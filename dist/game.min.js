"use strict";var A=Object.defineProperty,ye=Object.defineProperties,pe=Object.getOwnPropertyDescriptor,me=Object.getOwnPropertyDescriptors,Se=Object.getOwnPropertyNames,$=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,he=Object.prototype.propertyIsEnumerable;var j=(t,e,r)=>e in t?A(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,p=(t,e)=>{for(var r in e||(e={}))V.call(e,r)&&j(t,r,e[r]);if($)for(var r of $(e))he.call(e,r)&&j(t,r,e[r]);return t},q=(t,e)=>ye(t,me(e));var ve=(t,e)=>{for(var r in e)A(t,r,{get:e[r],enumerable:!0})},we=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Se(e))!V.call(t,a)&&a!==r&&A(t,a,{get:()=>e[a],enumerable:!(n=pe(e,a))||n.enumerable});return t};var be=t=>we(A({},"__esModule",{value:!0}),t);var Ke={};ve(Ke,{game:()=>ke});module.exports=be(Ke);var c={id:"player_001",attrs:{strength:75,intelligence:82,charm:68,luck:55},legend:30,tags:["civilian"],reputation:50,resources:{gold:100,food:200,soldiers:0},location:{region:"yingchuan",scene:"village"}},v={era:"184",flags:["taipingdao_spread=high"],time:{year:184,month:2,day:1},regionStatus:{jingzhou:"stable",yuzhou:"turmoil",jizhou:"stable"}},m=[{id:"caocao",name:"\u66F9\u64CD",stance:"neutral",trust:30,location:"luoyang"},{id:"liubei",name:"\u5218\u5907",stance:"friendly",trust:50,location:"zhuoxian"}],S={ADJUDICATION_API:"http://localhost:3000/intent/resolve",MAX_RETRIES:2,RETRY_DELAY:1e3,REQUEST_TIMEOUT:15e3,DEBUG:!1,DEFAULT_PLAYER_STATE:c,DEFAULT_WORLD_STATE:v,DEFAULT_NPC_STATE:m};function Y(){return{value:"",isKeyboardVisible:!1}}function P(t,e){return t.value=e,t}function J(t){return t.value="",t}function x(t,e){return t.isKeyboardVisible=e,t}function B(t,e){let r={x:0,y:0,width:t,height:80},n=Math.max(100,Math.round(e*.2)),a=60,i={x:0,y:e-n,width:t,height:n},s={x:0,y:i.y-a,width:t,height:a},l={x:0,y:r.height,width:t,height:s.y-r.height};return{attributePanel:r,dialogueArea:l,inputArea:i,saveLoadPanel:s}}function Q(t){let{ctx:e,screenWidth:r,screenHeight:n}=t;e.clearRect(0,0,r,n),Ae(t),xe(t),Te(t),t.isSaveLoadPanelVisible&&Ie(t)}function Ae({ctx:t,layout:e,playerAttributes:r,currentSaveData:n}){let a=e.attributePanel;t.fillStyle="#2C3E50",t.fillRect(a.x,a.y,a.width,a.height),t.fillStyle="#FFFFFF",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("\u73A9\u5BB6\u5C5E\u6027",a.width/2,a.y+25),t.font="14px sans-serif",t.textAlign="left";let i=[`\u6B66\u529B: ${r.strength}`,`\u667A\u529B: ${r.intelligence}`,`\u9B45\u529B: ${r.charm}`,`\u8FD0\u6C14: ${r.luck}`,`\u4F20\u5947\u5EA6: ${r.legend}`],s=a.y+50;i.forEach((u,g)=>{t.fillStyle="#ECF0F1",t.fillText(u,20,s+g*20)});let l=n?"\u5DF2\u5B58\u6863":"\u65B0\u6E38\u620F";t.fillStyle=n?"#27AE60":"#E74C3C",t.font="12px sans-serif",t.textAlign="right",t.fillText(`\u72B6\u6001: ${l}`,a.width-20,a.y+25),t.fillStyle="#3498DB",t.fillRect(a.width-50,a.y+10,40,20),t.fillStyle="#FFFFFF",t.font="12px sans-serif",t.textAlign="center",t.fillText("\u5B58\u6863",a.width-30,a.y+25)}function xe({ctx:t,layout:e,dialogueHistory:r}){let n=e.dialogueArea;t.fillStyle="#34495E",t.fillRect(n.x,n.y,n.width,n.height),t.fillStyle="#FFFFFF",t.font="16px sans-serif",t.textAlign="left";let a=20,i=n.y+a,s=n.width-a*2;r.forEach(l=>{if(i=Le(t,l,a,i,s),i+=12,i>n.y+n.height-a){t.fillStyle="#E74C3C",t.fillText("\uFF08\u66F4\u591A\u5185\u5BB9...\uFF09",a,n.y+n.height-a);return}})}function Te({ctx:t,layout:e,currentInput:r,currentSaveData:n,keyboardActive:a}){let i=e.inputArea;t.fillStyle="#2C3E50",t.fillRect(i.x,i.y,i.width,i.height);let s=i.y+20;t.fillStyle="#ECF0F1",t.fillRect(20,s,i.width-100,40),t.fillStyle="#2C3E50",t.font="16px sans-serif",t.textAlign="left";let l=a?"\u8F93\u5165\u4E2D...":"\u70B9\u51FB\u6B64\u5904\u8F93\u5165\u4F60\u7684\u610F\u56FE...";t.fillText(r||l,25,s+25),t.fillStyle="#27AE60",t.fillRect(i.width-70,s,60,40),t.fillStyle="#FFFFFF",t.font="bold 14px sans-serif",t.textAlign="center",t.fillText("\u53D1\u9001",i.width-40,s+25),n&&(t.fillStyle="#27AE60",t.font="10px sans-serif",t.textAlign="left",t.fillText("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u7528",20,i.y+10))}function Ie({ctx:t,layout:e,currentSaveData:r}){let n=e.saveLoadPanel;if(t.fillStyle="rgba(44, 62, 80, 0.95)",t.fillRect(n.x,n.y,n.width,n.height),t.strokeStyle="#3498DB",t.lineWidth=2,t.strokeRect(n.x,n.y,n.width,n.height),t.fillStyle="#FFFFFF",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("\u5B58\u6863\u7BA1\u7406",n.width/2,n.y+25),t.fillStyle="#27AE60",t.fillRect(.1*n.width,n.y+35,.35*n.width,20),t.fillStyle="#FFFFFF",t.font="14px sans-serif",t.textAlign="center",t.fillText("\u4FDD\u5B58\u6E38\u620F",.275*n.width,n.y+50),t.fillStyle="#3498DB",t.fillRect(.55*n.width,n.y+35,.35*n.width,20),t.fillStyle="#FFFFFF",t.fillText("\u5173\u95ED\u9762\u677F",.725*n.width,n.y+50),r){let a=r.meta;t.fillStyle="#ECF0F1",t.font="12px sans-serif",t.textAlign="left",[`\u5B58\u6863: ${a.saveName}`,`\u73A9\u5BB6: ${a.playerId.substring(0,8)}...`,`\u65F6\u95F4: ${new Date(a.lastSaved).toLocaleString()}`].forEach((s,l)=>{t.fillText(s,20,n.y+80+15*l)})}else t.fillStyle="#E74C3C",t.font="12px sans-serif",t.textAlign="left",t.fillText("\u65E0\u5B58\u6863\u6570\u636E\uFF0C\u8BF7\u5148\u4FDD\u5B58\u6E38\u620F",20,n.y+80)}function Le(t,e,r,n,a){let i=Array.from(e),s="",l=n;return i.forEach(u=>{let g=s+u;t.measureText(g).width>a&&s.length>0?(t.fillText(s,r,l),s=u,l+=24):s=g}),s&&(t.fillText(s,r,l),l+=24),l}var R="1.0.0",E="sanguo_save_";function w(t){return JSON.parse(JSON.stringify(t))}function Ce(){let t=new Date().toISOString(),e=w(c),r=w(v),n=w(m);return{meta:{version:R,createdAt:t,lastSaved:t,playerId:e.id,saveName:"\u9ED8\u8BA4\u5B58\u6863",saveSlot:0},player:e,world:r,npcs:n,eventLog:[],dialogueHistory:["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026"],progress:{totalTurns:0,lastEventId:"",lastEventTime:t}}}var D=class{constructor(){this.mockStorage={};this.useMock=typeof wx=="undefined"||typeof wx.setStorageSync!="function",this.useMock&&console.warn("\u5FAE\u4FE1\u5C0F\u6E38\u620F\u5B58\u50A8 API \u4E0D\u53EF\u7528\uFF0C\u4F7F\u7528\u5185\u5B58\u6A21\u62DF\u3002")}setItem(e,r){if(this.useMock){this.mockStorage[e]=r;return}wx.setStorageSync(e,r)}getItem(e){if(this.useMock)return this.mockStorage[e];let r=wx.getStorageSync(e);return r===""?void 0:r}removeItem(e){if(this.useMock){delete this.mockStorage[e];return}wx.removeStorageSync(e)}getAllKeys(){return this.useMock?Object.keys(this.mockStorage):wx.getStorageInfoSync().keys}getStorageSizeBytes(){return this.useMock?Object.values(this.mockStorage).reduce((r,n)=>r+n.length,0):wx.getStorageInfoSync().currentSize*1024}isMock(){return this.useMock}},H=class{constructor(){this.currentSlot=0;this.autoSaveEnabled=!0;this.autoSaveInterval=30;this.autoSaveTimer=null;this.storageLimits={maxSingleKeySize:1048576,maxTotalSize:10485760,maxDialogueHistory:100,maxEventLog:500,warningThreshold:.8};this.storage=new D}init(){return console.log("\u5B58\u6863\u7CFB\u7EDF\u521D\u59CB\u5316"),this.startAutoSave(),!0}generatePlayerId(){return`player_${Date.now()}_${Math.floor(Math.random()*1e4)}`}createNewSave(e=0,r="\u65B0\u5EFA\u5B58\u6863"){let n=w(Ce()),a=this.generatePlayerId(),i=new Date().toISOString();return n.meta=q(p({},n.meta),{playerId:a,createdAt:i,lastSaved:i,saveName:r,saveSlot:e}),n.player.id=a,this.currentSlot=e,n}optimizeSaveData(e){let r=w(e);return r.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(r.dialogueHistory=r.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory)),r.eventLog.length>this.storageLimits.maxEventLog&&(r.eventLog=r.eventLog.slice(-this.storageLimits.maxEventLog)),delete r.tempData,r}checkSaveSize(e){try{let r=JSON.stringify(e),n=new Blob([r]).size,a=n<=this.storageLimits.maxSingleKeySize;return{size:n,withinLimit:a,warning:n>this.storageLimits.maxSingleKeySize*this.storageLimits.warningThreshold?`\u5B58\u6863\u5927\u5C0F ${n} \u5B57\u8282\u63A5\u8FD1\u5355\u952E\u9650\u5236`:null}}catch(r){return console.error("\u68C0\u67E5\u5B58\u6863\u5927\u5C0F\u5931\u8D25:",r),{size:0,withinLimit:!1,warning:null}}}checkTotalStorage(){try{let e=this.storage.getStorageSizeBytes(),r=e/this.storageLimits.maxTotalSize;return{totalSize:e,usagePercentage:r,withinLimit:e<=this.storageLimits.maxTotalSize,warning:r>this.storageLimits.warningThreshold?`\u5B58\u50A8\u4F7F\u7528\u7387 ${(r*100).toFixed(1)}% \u63A5\u8FD1\u4E0A\u9650`:null}}catch(e){return console.error("\u68C0\u67E5\u5B58\u50A8\u4F7F\u7528\u60C5\u51B5\u5931\u8D25:",e),null}}save(e,r=!1){if(!e)return console.error("\u5B58\u6863\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A"),!1;let n=new Date().toISOString();e.meta.lastSaved=n,r&&(e.meta.lastAutoSave=n);let a=this.optimizeSaveData(e),i=this.checkSaveSize(a);if(!i.withinLimit&&(console.error(`\u5B58\u6863\u5927\u5C0F ${i.size} \u5B57\u8282\u8D85\u8FC7\u9650\u5236\uFF0C\u5C1D\u8BD5\u88C1\u526A...`),a.dialogueHistory=a.dialogueHistory.slice(-50),a.eventLog=a.eventLog.slice(-100),!this.checkSaveSize(a).withinLimit))return console.error("\u88C1\u526A\u540E\u4ECD\u8D85\u8FC7\u9650\u5236\uFF0C\u4FDD\u5B58\u5931\u8D25"),!1;i.warning&&console.warn(i.warning);let s=this.checkTotalStorage();s!=null&&s.warning&&console.warn(s.warning);let l=`${E}${this.currentSlot}`;try{let u=JSON.stringify(a);return this.storage.setItem(l,u),console.log(`\u5B58\u6863\u4FDD\u5B58\u6210\u529F\uFF08${r?"\u81EA\u52A8":"\u624B\u52A8"}\uFF09\uFF0C\u69FD\u4F4D: ${this.currentSlot}`),!0}catch(u){return console.error("\u5B58\u6863\u4FDD\u5B58\u5931\u8D25:",u),!1}}readSlot(e){let r=`${E}${e}`;try{let n=this.storage.getItem(r);if(!n)return null;let a=JSON.parse(n);return a.meta.version!==R&&console.warn(`\u5B58\u6863\u7248\u672C\u4E0D\u5339\u914D: ${a.meta.version} -> ${R}`),a}catch(n){return console.error("\u5B58\u6863\u8BFB\u53D6\u5931\u8D25:",n),null}}load(e=null){let r=e!=null?e:this.currentSlot;try{let n=this.readSlot(r);return n?(this.currentSlot=r,n):(console.log(`\u5B58\u6863\u69FD\u4F4D ${r} \u4E0D\u5B58\u5728`),null)}catch(n){return console.error("\u5B58\u6863\u52A0\u8F7D\u5931\u8D25:",n),null}}deleteSave(e){let r=`${E}${e}`;try{return this.storage.removeItem(r),console.log(`\u5B58\u6863\u5220\u9664\u6210\u529F\uFF0C\u69FD\u4F4D: ${e}`),!0}catch(n){return console.error("\u5B58\u6863\u5220\u9664\u5931\u8D25:",n),!1}}getSaveList(){let e=[];for(let r=0;r<10;r+=1){let n=this.readSlot(r);n&&e.push({slot:r,name:n.meta.saveName,playerId:n.meta.playerId,lastSaved:n.meta.lastSaved,era:n.world.era,location:n.player.location.region})}return e}logEvent(e,r,n){if(!e||!r)return console.error("logEvent \u53C2\u6570\u9519\u8BEF"),!1;let a=n||e.player.id;if(e.eventLog.some(s=>s.eventId===r&&s.playerId===a))return!0;let i=new Date().toISOString();return e.eventLog.push({eventId:r,playerId:a,triggeredAt:i,recordedAt:i}),e.progress.lastEventId=r,e.progress.lastEventTime=i,e.progress.totalTurns+=1,!0}isEventTriggered(e,r){return!e||!r?!1:e.eventLog.some(n=>n.eventId===r&&n.playerId===e.player.id)}updatePlayerAttributes(e,r){if(!e||!r)return e;if(r.attrs&&Object.entries(r.attrs).forEach(([n,a])=>{if(typeof a=="number"&&n in e.player.attrs){let i=e.player.attrs[n]+a;e.player.attrs[n]=Math.max(0,Math.min(100,i))}}),typeof r.legend=="number"&&(e.player.legend=Math.max(0,e.player.legend+r.legend)),typeof r.reputation=="number"){let n=e.player.reputation+r.reputation;e.player.reputation=Math.max(0,Math.min(100,n))}return r.resources&&Object.entries(r.resources).forEach(([n,a])=>{if(typeof a=="number"&&n in e.player.resources){let i=e.player.resources[n]+a;e.player.resources[n]=Math.max(0,i)}}),e}updateWorldState(e,r){return!e||!r||(r.era&&(e.world.era=r.era),r.flags&&r.flags.forEach(n=>{e.world.flags.includes(n)||e.world.flags.push(n)}),r.time&&(e.world.time=p(p({},e.world.time),r.time)),r.regions&&(e.world.regions=e.world.regions||{},Object.entries(r.regions).forEach(([n,a])=>{e.world.regions[n]=p(p({},e.world.regions[n]||{}),a)}))),e}addDialogueHistory(e,r){return!e||!r||(Array.isArray(r)?e.dialogueHistory.push(...r):e.dialogueHistory.push(r),e.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(e.dialogueHistory=e.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory))),e}startAutoSave(){!this.autoSaveEnabled||this.autoSaveTimer||(this.autoSaveTimer=setInterval(()=>{let e=this.load(this.currentSlot);e&&this.save(e,!0)},this.autoSaveInterval*1e3),console.log(`\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.autoSaveInterval} \u79D2`))}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u505C\u6B62"))}setAutoSaveInterval(e){this.autoSaveInterval=Math.max(10,e),this.autoSaveTimer&&(this.stopAutoSave(),this.startAutoSave())}exportSave(e=null){let r=this.load(e!=null?e:this.currentSlot);return r?JSON.stringify(r,null,2):null}importSave(e,r){try{let n=JSON.parse(e);if(!n.meta||!n.player)throw new Error("\u5B58\u6863\u683C\u5F0F\u65E0\u6548");return typeof r=="number"&&(this.currentSlot=r),this.save(n,!1)}catch(n){return console.error("\u5BFC\u5165\u5B58\u6863\u5931\u8D25:",n),!1}}getStorageInfo(){if(this.storage.isMock())return{total:this.storageLimits.maxTotalSize,used:0,available:this.storageLimits.maxTotalSize,usagePercentage:0};try{let e=wx.getStorageInfoSync();return{total:this.storageLimits.maxTotalSize,used:e.currentSize*1024,available:this.storageLimits.maxTotalSize-e.currentSize*1024,usagePercentage:e.currentSize/10240,keys:e.keys}}catch(e){return console.error("\u83B7\u53D6\u5B58\u50A8\u4FE1\u606F\u5931\u8D25:",e),null}}},f=new H;function h(t,e,r=120){return Array.isArray(e)?t.push(...e):t.push(e),Pe(t,r),t}function F(t){return t.pop()}function Pe(t,e){t.length>e&&t.splice(0,t.length-e)}function y(){return _()?wx:null}function _(){return typeof wx!="undefined"}function k(){let t=y();if(t&&typeof t.getSystemInfoSync=="function"){let r=t.getSystemInfoSync();return{windowWidth:r.windowWidth||375,windowHeight:r.windowHeight||667,pixelRatio:r.pixelRatio||2}}let e=typeof window!="undefined"?window:void 0;return{windowWidth:(e==null?void 0:e.innerWidth)||375,windowHeight:(e==null?void 0:e.innerHeight)||667,pixelRatio:(e==null?void 0:e.devicePixelRatio)||2}}function X(){let t=y(),e=k(),r=e.windowWidth*e.pixelRatio,n=e.windowHeight*e.pixelRatio;if(t&&typeof t.createCanvas=="function"){let a=t.createCanvas();return a.width=r,a.height=n,a}if(typeof document!="undefined"&&typeof document.createElement=="function"){let a=document.createElement("canvas");return a.width=r,a.height=n,a}return console.warn("wx.createCanvas \u4E0D\u53EF\u7528\uFF0C\u8FD4\u56DE null\u3002"),null}function Z(t){let e=y();!e||typeof e.onTouchStart!="function"||e.onTouchStart(t)}function ee(t){let e=y();!e||typeof e.onKeyboardInput!="function"||e.onKeyboardInput(t)}function te(t){let e=y();!e||typeof e.onKeyboardConfirm!="function"||e.onKeyboardConfirm(t)}function re(t){let e=y();!e||typeof e.onKeyboardComplete!="function"||e.onKeyboardComplete(t)}function ne(t,e=100){let r=y();if(!r||typeof r.showKeyboard!="function"){console.warn("wx.showKeyboard \u4E0D\u53EF\u7528\u3002");return}r.showKeyboard({defaultValue:t,maxLength:e,multiple:!1,confirmHold:!1,confirmType:"send"})}function ae(){let t=y();!t||typeof t.hideKeyboard!="function"||t.hideKeyboard({})}function oe({url:t,data:e,method:r="POST",timeout:n=15e3,header:a={"Content-Type":"application/json"}}){let i=y();return!i||typeof i.request!="function"?Promise.reject(new Error("wx.request \u4E0D\u53EF\u7528\uFF0C\u65E0\u6CD5\u53D1\u8D77\u7F51\u7EDC\u8BF7\u6C42")):new Promise((s,l)=>{i.request({url:t,data:e,method:r,timeout:n,header:a,enableChunked:!0,success(u){s({statusCode:u.statusCode,data:u.data})},fail(u){l(u)}})})}function K(t){if(typeof requestAnimationFrame=="function"){requestAnimationFrame(t);return}setTimeout(()=>t(Date.now()),16)}async function ie({url:t=S.ADJUDICATION_API,payload:e,retries:r=S.MAX_RETRIES,retryDelay:n=S.RETRY_DELAY,timeout:a=S.REQUEST_TIMEOUT}){let i=0,s=null;for(;i<=r;)try{let l=await oe({url:t,data:e,method:"POST",timeout:a,header:{"Content-Type":"application/json"}});if(l.statusCode>=200&&l.statusCode<300)return l.data;throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${l.statusCode}`)}catch(l){if(s=l,i+=1,i>r)break;await new Promise(u=>setTimeout(u,n))}throw s instanceof Error?s:new Error("\u8BF7\u6C42\u5931\u8D25\u4E14\u65E0\u53EF\u7528\u9519\u8BEF\u4FE1\u606F")}var O=["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026"],o={canvas:null,ctx:null,layout:null,screenWidth:0,screenHeight:0,playerAttributes:{strength:c.attrs.strength,intelligence:c.attrs.intelligence,charm:c.attrs.charm,luck:c.attrs.luck,legend:c.legend},dialogueHistory:[...O],input:Y(),isSaveLoadPanelVisible:!1,currentSaveData:null,isAdjudicating:!1,loopActive:!1},se=!1,le=!1;function U(){if(se)return{ready:!0};let t=X();if(!t)return{ready:!1,message:"\u65E0\u6CD5\u521B\u5EFA Canvas\uFF0C\u4E0A\u4E0B\u6587\u4E0D\u53EF\u7528"};let e=k(),r=e.pixelRatio||1,n=e.windowWidth,a=e.windowHeight,i=t.getContext("2d");return i?(r!==1&&typeof i.scale=="function"&&i.scale(r,r),o.canvas=t,o.ctx=i,o.screenWidth=n||t.width,o.screenHeight=a||t.height,o.layout=B(o.screenWidth,o.screenHeight),f.init(),Ee(),Re(),d(),se=!0,{ready:!0}):{ready:!1,message:"\u65E0\u6CD5\u83B7\u53D6 CanvasRenderingContext2D"}}function W(){if(o.loopActive)return;o.loopActive=!0;let t=()=>{d(),K(t)};K(t)}function z(t){var l;if(!o.layout)return;let e=(l=t.touches)==null?void 0:l[0];if(!e)return;let{x:r,y:n}=e,{inputArea:a,saveLoadPanel:i,attributePanel:s}=o.layout;if(T(a,r,n)){De(r,n);return}if(o.isSaveLoadPanelVisible&&T(i,r,n)){let u=i.width/2;r<=u?G():I();return}T(s,r,n)&&r>=s.width-60&&I()}function N(){x(o.input,!0),ne(o.input.value),d()}async function C(){if(o.isAdjudicating)return;let t=o.input.value.trim();if(!t)return;h(o.dialogueHistory,[`\u4F60\u8BF4\uFF1A\u201C${t}\u201D`,"\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"]),o.currentSaveData&&f.addDialogueHistory(o.currentSaveData,[`\u4F60\u8BF4\uFF1A\u201C${t}\u201D`,"\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"]),J(o.input),ae(),x(o.input,!1),M(),d(),o.isAdjudicating=!0;let e=He(t);try{let r=await ie({payload:e});ce(),Fe(r)}catch(r){ce(),h(o.dialogueHistory,"\u7F51\u7EDC\u6CE2\u52A8\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5 (\u70B9\u51FB\u8F93\u5165\u6846\u91CD\u8BD5)"),d(),console.error("\u88C1\u51B3 API \u8C03\u7528\u5931\u8D25:",r),_e(t)}finally{o.isAdjudicating=!1}}function I(){o.isSaveLoadPanelVisible=!o.isSaveLoadPanelVisible,d()}function G(){o.currentSaveData||(o.currentSaveData=f.createNewSave(0,"\u624B\u52A8\u5B58\u6863")),f.save(o.currentSaveData,!1)&&(h(o.dialogueHistory,"\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"),d(),setTimeout(()=>{o.dialogueHistory.at(-1)==="\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"&&(F(o.dialogueHistory),d())},3e3))}function Ee(){let t=f.load(0);if(t)return o.currentSaveData=t,L(),console.log("\u5B58\u6863\u52A0\u8F7D\u6210\u529F"),!0;let e=f.createNewSave(0,"\u521D\u59CB\u5B58\u6863");return f.save(e,!1)?(o.currentSaveData=e,L(),console.log("\u65B0\u5B58\u6863\u521B\u5EFA\u5E76\u4FDD\u5B58\u6210\u529F"),!0):(console.warn("\u521D\u59CB\u5B58\u6863\u4FDD\u5B58\u5931\u8D25\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u6570\u636E"),o.currentSaveData=null,o.dialogueHistory=[...O],!1)}function d(){!o.ctx||!o.layout||Q({ctx:o.ctx,layout:o.layout,screenWidth:o.screenWidth,screenHeight:o.screenHeight,playerAttributes:o.playerAttributes,dialogueHistory:o.dialogueHistory,currentInput:o.input.value,currentSaveData:o.currentSaveData,isSaveLoadPanelVisible:o.isSaveLoadPanelVisible,keyboardActive:o.input.isKeyboardVisible})}function de(t){P(o.input,t),d()}function Re(){le||!_()||(Z(t=>z(t)),ee(t=>{P(o.input,t.value),d()}),te(()=>{C().catch(t=>console.error(t))}),re(()=>{x(o.input,!1),d()}),le=!0)}function De(t,e){if(!o.layout)return;let r=o.layout.inputArea,n={x:r.width-70,y:r.y+20,width:60,height:40};T(n,t,e)?C().catch(a=>console.error(a)):N()}function He(t){let e=c,r=v,n=m,a;return o.currentSaveData&&(e=o.currentSaveData.player,r=o.currentSaveData.world,n=o.currentSaveData.npcs||m,a={recent_dialogue:o.currentSaveData.dialogueHistory.slice(-3)}),{player_state:e,world_state:r,npc_state:n,event_context:a,player_intent:t}}function Fe(t){var r,n,a,i;let e=((r=t.result)==null?void 0:r.narrative)||"\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u6CE8\u610F\u3002";h(o.dialogueHistory,e),o.currentSaveData&&(f.addDialogueHistory(o.currentSaveData,e),(n=t.state_changes)!=null&&n.player&&t.state_changes.player.length>0&&ue(t.state_changes.player),(a=t.result)!=null&&a.effects&&ue(t.result.effects),(i=t.state_changes)!=null&&i.world&&f.updateWorldState(o.currentSaveData,t.state_changes.world),M(),L()),d()}function ue(t){if(!o.currentSaveData)return;let e={},r={},n=0,a=0;t.forEach(i=>{let s=i.match(/^([a-zA-Z_]+)([+-]\d+)$/);if(!s)return;let[,l,u]=s,g=Number(u);Number.isNaN(g)||(l in o.currentSaveData.player.attrs?e[l]=(e[l]||0)+g:l==="legend"?n+=g:l==="reputation"?a+=g:l in o.currentSaveData.player.resources&&(r[l]=(r[l]||0)+g))}),f.updatePlayerAttributes(o.currentSaveData,{attrs:e,legend:n,reputation:a,resources:r})}function _e(t){setTimeout(()=>{let e="\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u53BF\u5C09\u7684\u6CE8\u610F\uFF0C\u4ED6\u5BF9\u4F60\u7684\u884C\u4E3A\u8868\u793A\u8D5E\u8D4F\u3002";h(o.dialogueHistory,e),o.currentSaveData&&(f.addDialogueHistory(o.currentSaveData,e),f.updatePlayerAttributes(o.currentSaveData,{attrs:{intelligence:1},reputation:3}),M(),L()),d()},1e3)}function M(){o.currentSaveData&&f.save(o.currentSaveData,!0)}function L(){o.currentSaveData&&(o.playerAttributes={strength:o.currentSaveData.player.attrs.strength||c.attrs.strength,intelligence:o.currentSaveData.player.attrs.intelligence||c.attrs.intelligence,charm:o.currentSaveData.player.attrs.charm||c.attrs.charm,luck:o.currentSaveData.player.attrs.luck||c.attrs.luck,legend:o.currentSaveData.player.legend||c.legend},o.dialogueHistory=o.currentSaveData.dialogueHistory.length?[...o.currentSaveData.dialogueHistory]:[...O])}function ce(){o.dialogueHistory.at(-1)==="\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"&&F(o.dialogueHistory)}function T(t,e,r){var i,s;let n=(i=t.x)!=null?i:0,a=(s=t.y)!=null?s:0;return e>=n&&e<=n+t.width&&r>=a&&r<=a+t.height}var fe=!1;function ge(){if(fe)return;let t=U();if(!t.ready){console.error("\u6E38\u620F\u521D\u59CB\u5316\u5931\u8D25:",t.message);return}W(),fe=!0,console.log("\u5C0F\u6E38\u620F\u5165\u53E3\u521D\u59CB\u5316\u5B8C\u6210\uFF08\u5360\u4F4D\u5B9E\u73B0\uFF09")}var b=typeof wx!="undefined"?wx:null;b&&typeof b.onShow=="function"?(b.onShow(()=>{ge()}),b.onHide(()=>{console.log("\u6E38\u620F\u8FDB\u5165\u540E\u53F0")}),b.onError(t=>{console.error("\u6E38\u620F\u9519\u8BEF:",t)})):(console.warn("wx \u5168\u5C40\u5BF9\u8C61\u4E0D\u53EF\u7528\uFF0C\u4F7F\u7528\u672C\u5730\u8C03\u8BD5\u6A21\u5F0F\u81EA\u52A8\u542F\u52A8\u3002"),ge());var ke={initGame:U,gameLoop:W,handleTouch:z,showKeyboard:N,submitInput:C,manualSave:G,toggleSaveLoadPanel:I,render:d,setCurrentInput:de};
