"use strict";var Ye=Object.defineProperty,qe=Object.defineProperties;var Je=Object.getOwnPropertyDescriptors;var ge=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,Qe=Object.prototype.propertyIsEnumerable;var pe=(t,e,n)=>e in t?Ye(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,_=(t,e)=>{for(var n in e||(e={}))Xe.call(e,n)&&pe(t,n,e[n]);if(ge)for(var n of ge(e))Qe.call(e,n)&&pe(t,n,e[n]);return t},he=(t,e)=>qe(t,Je(e));var m={id:"player_001",attrs:{strength:75,intelligence:82,charm:68,luck:55},legend:30,tags:["civilian"],reputation:50,resources:{gold:100,food:200,soldiers:0},location:{region:"yingchuan",scene:"village"}},U={era:"184",flags:["taipingdao_spread=high"],time:{year:184,month:2,day:1},regionStatus:{jingzhou:"stable",yuzhou:"turmoil",jizhou:"stable"}},M=["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026","\u3010\u63D0\u793A\u3011\u5728\u4E0B\u65B9\u8F93\u5165\u6846\u8F93\u5165\u4F60\u7684\u610F\u56FE\uFF08\u5982\u300C\u524D\u5F80\u6D1B\u9633\u300D\u300C\u7ED3\u8BC6\u8C6A\u6770\u300D\uFF09\uFF0C\u70B9\u51FB\u53D1\u9001\u5373\u53EF\u63A8\u8FDB\u5267\u60C5\u3002"],N=[{id:"caocao",name:"\u66F9\u64CD",stance:"neutral",trust:30,location:"luoyang"},{id:"liubei",name:"\u5218\u5907",stance:"friendly",trust:50,location:"zhuoxian"}],O=(()=>{try{let e=(typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{}).process;return e&&typeof e=="object"&&e!==null&&"env"in e?e.env||{}:{}}catch(t){return{}}})(),C={CLOUD_ENV:O.CLOUD_ENV||"cloud1-3gfb9ep2701c4857",ADJUDICATION_API:O.ADJUDICATION_API||"http://localhost:3000/intent/resolve",MAX_RETRIES:2,RETRY_DELAY:1e3,REQUEST_TIMEOUT:15e3,DEBUG:O.NODE_ENV!=="production",DEBUG_TOUCH:O.DEBUG_TOUCH==="true",AD_UNIT_ID:O.AD_UNIT_ID||"adunit-1234567890abcdef",DEFAULT_PLAYER_STATE:m,DEFAULT_WORLD_STATE:U,DEFAULT_NPC_STATE:N};var Ze={};function ye(t,e){let n=Ze[t];return!n||n.size===0?e:e.filter(r=>r.id!=null?n.has(r.id):!1)}function me(t){var u,c,l,d,f;let{saveData:e,playerIntent:n,recentDialogue:r=(c=(u=e==null?void 0:e.dialogueHistory)==null?void 0:u.slice(-5))!=null?c:[]}=t,a=(l=e==null?void 0:e.player)!=null?l:m,o=(d=e==null?void 0:e.world)!=null?d:U,s=(f=e==null?void 0:e.npcs)!=null?f:N;return s=ye("npc",s),{player_state:a,world_state:o,npc_state:s,event_context:r.length>0?{recent_dialogue:r}:void 0,player_intent:n}}function Se(){return{value:"",isKeyboardVisible:!1}}function ve(t,e){return t.value=e,t}function F(t){return t.value="",t}function k(t,e){return t.isKeyboardVisible=e,t}function be(t,e,n=0){var R;let r,a;typeof t=="object"?(r=t.screenWidth,a=t.screenHeight,n=(R=t.safeAreaTop)!=null?R:0):(r=t,a=e!=null?e:667);let o=Math.max(0,n),s=Math.max(16,Math.min(24,Math.round(r*.04))),u=r-s*2,c=Math.max(10,Math.round(a*.012)),l=Math.max(90,Math.min(100,Math.round(a*.1))),d=Math.max(72,Math.min(88,Math.round(a*.11))),f=Math.max(64,Math.min(80,Math.round(a*.09))),p={x:s,y:s+o,width:u,height:l},A={x:s,y:a-s-d,width:u,height:d},y={x:s,y:A.y-c-f,width:u,height:f},L={x:s,y:p.y+p.height+c,width:u,height:y.y-(p.y+p.height)-c*2};return{safeMargin:s,attributePanel:p,dialogueArea:L,inputArea:A,saveLoadPanel:y}}var w={canvas:null,ctx:null,cacheKey:"",totalHeight:0};function et(t,e,n){try{if(typeof OffscreenCanvas!="undefined")return new OffscreenCanvas(t,e);let r=n.canvas;if(r!=null&&r.createOffscreenCanvas)return r.createOffscreenCanvas(t,e);if(typeof document!="undefined"&&document.createElement){let a=document.createElement("canvas");return a.width=t,a.height=e,a}}catch(r){}return null}var we=["\u524D\u5F80\u6D1B\u9633","\u6253\u542C\u6D88\u606F","\u7ED3\u8BC6\u8C6A\u6770"],tt={yingchuan:"\u988D\u5DDD",luoyang:"\u6D1B\u9633",jingzhou:"\u8346\u5DDE",jizhou:"\u5180\u5DDE",yuzhou:"\u8C6B\u5DDE",zhuoxian:"\u6DBF\u53BF"},nt={village:"\u6751\u5E84",city:"\u57CE\u5185",camp:"\u8425\u5730",inn:"\u5BA2\u6808",temple:"\u5E99\u5B87"},g={bgStart:"#0f172a",bgEnd:"#1e293b",panel:"rgba(30, 41, 59, 0.92)",panelBorder:"rgba(148, 163, 184, 0.2)",dialogueBg:"rgba(15, 23, 42, 0.85)",bubbleSystem:"rgba(255,255,255,0.06)",bubblePlayer:"rgba(56, 189, 248, 0.12)",bubblePlayerBorder:"rgba(56, 189, 248, 0.35)",textPrimary:"#f8fafc",textSecondary:"#94a3b8",textMuted:"#64748b",accent:"#38bdf8",success:"#4ade80",warn:"#fb7185"};function Te(t){let{ctx:e,screenWidth:n,screenHeight:r}=t;rt(e,n,r),at(t),it(t),st(t),lt(t)}function rt(t,e,n){let r=t.createLinearGradient(0,0,0,n);r.addColorStop(0,g.bgStart),r.addColorStop(1,g.bgEnd),t.fillStyle=r,t.fillRect(0,0,e,n)}function at({ctx:t,layout:e,playerAttributes:n,currentSaveData:r}){var L,R,S,b,P,H,D,j;let a=e.attributePanel,o=14;E(t,a,g.panel,g.panelBorder),t.fillStyle=g.accent,t.font="bold 14px 'PingFang SC', sans-serif",t.textAlign="left",t.fillText("\u73A9\u5BB6\u5C5E\u6027",a.x+o,a.y+16);let s=["\u6B66\u529B","\u667A\u529B","\u9B45\u529B","\u8FD0\u6C14","\u4F20\u5947","\u6C14\u52BF"],u=[n.strength,n.intelligence,n.charm,n.luck,n.legend,Math.max(0,Math.round(n.legend/10))],c=(a.width-o*2)/6;t.font="13px 'PingFang SC', sans-serif",s.forEach((Ve,ce)=>{let de=a.x+o+c*ce+c/2,fe=a.y+36;t.fillStyle=g.textMuted,t.textAlign="center",t.fillText(Ve,de,fe-2),t.fillStyle=g.textPrimary,t.fillText(String(u[ce]),de,fe+14)});let l=(S=(R=(L=r==null?void 0:r.player)==null?void 0:L.location)==null?void 0:R.region)!=null?S:"",d=(H=(P=(b=r==null?void 0:r.player)==null?void 0:b.location)==null?void 0:P.scene)!=null?H:"",f=((D=tt[l])!=null?D:l)||"\u2014",p=((j=nt[d])!=null?j:d)||"\u2014",A=`${f} \xB7 ${p}`;t.fillStyle=g.textMuted,t.font="11px 'PingFang SC', sans-serif",t.textAlign="left",t.fillText(A,a.x+o,a.y+a.height-8);let y=r?"\u5DF2\u5B58\u6863":"\u65B0\u6E38\u620F";t.fillStyle=r?g.success:g.warn,t.textAlign="right",t.fillText(`${y} \xB7 \u70B9\u51FB\u5B58\u6863`,a.x+a.width-o,a.y+a.height-8)}function ot(t,e,n){t.save(),t.font="14px 'PingFang SC', sans-serif";let o=Ae(t,e,n-24);return t.restore(),o.length*22+24}function it(t){let{ctx:e,layout:n,dialogueHistory:r,dialogueScrollOffset:a=0}=t,o=n.dialogueArea,s=14,u=8,c=o.width-s*2,l=r,d=o.height-s*2,f=[];l.forEach(S=>{f.push(ot(e,S,c))});let p=f.reduce((S,b)=>S+b+u,-u),A=Math.max(0,p-d),y=Math.min(a,A),L=`${l.join("")}|${o.width}x${o.height}`;if((w.cacheKey!==L||!w.canvas||w.totalHeight!==p)&&p>0){let S=et(o.width,p,e);if(S){let b=S.getContext("2d");if(b){let P=0;l.forEach(H=>{let D=H.startsWith("\u4F60\u8BF4\uFF1A"),j=xe(b,{x:s,y:P,width:c,text:H,player:D});P+=j+u}),w.canvas=S,w.ctx=b,w.cacheKey=L,w.totalHeight=p}}else w.cacheKey="",w.canvas=null,w.ctx=null,w.totalHeight=0}if(E(e,o,g.dialogueBg,"rgba(148,163,184,0.12)"),e.save(),e.beginPath(),e.rect(o.x,o.y,o.width,o.height),e.clip(),w.canvas&&w.ctx){let S=Math.max(0,p-d-y),b=Math.min(d,p-S),P=o.y+s;e.drawImage(w.canvas,0,S,o.width,b,o.x,P,o.width,b)}else{let S=o.height-p-s*2;e.translate(0,S+y);let b=o.y+s;l.forEach(P=>{let H=P.startsWith("\u4F60\u8BF4\uFF1A"),D=xe(e,{x:o.x+s,y:b,width:c,text:P,player:H});b+=D+u})}e.restore(),A>0&&y<A-2&&(e.fillStyle=g.accent,e.font="12px 'PingFang SC', sans-serif",e.textAlign="center",e.fillText("\u2191 \u4E0A\u6ED1\u67E5\u770B\u5386\u53F2\u5BF9\u8BDD",o.x+o.width/2,o.y+o.height-8))}function st({ctx:t,layout:e,currentInput:n,keyboardActive:r,placeholderIndex:a}){let o=e.inputArea,s=12,u=64,c=10;E(t,o,g.panel,g.panelBorder);let l={x:o.x+s,y:o.y+s,width:o.width-s*2-u-c,height:o.height-s*2};E(t,l,"rgba(15,23,42,0.9)","rgba(148,163,184,0.2)",10);let d=(a!=null?a:0)%we.length,f=n?"":r?"\u8F93\u5165\u4E2D...":we[d];t.fillStyle=n?g.textPrimary:g.textMuted,t.font="14px 'PingFang SC', sans-serif",t.textAlign="left";let p=n||f,A=l.y+l.height/2+5;t.fillText(p||" ",l.x+12,A);let y={x:o.x+o.width-s-u,y:o.y+s,width:u,height:o.height-s*2};ut(t,y,"\u53D1\u9001")}function lt({ctx:t,layout:e,currentSaveData:n}){if(!e.saveLoadPanel)return;let r=e.saveLoadPanel,a=10,o=8,s=(r.width-a*2-o)/2,u=r.height-a*2;if(E(t,r,g.panel,g.panelBorder),[{label:"\u4FDD\u5B58",x:r.x+a},{label:"\u5173\u95ED",x:r.x+a+s+o}].forEach(({label:l,x:d})=>{E(t,{x:d,y:r.y+a,width:s,height:u},"rgba(15,23,42,0.9)","rgba(148,163,184,0.2)",10),t.fillStyle=g.textPrimary,t.font="bold 13px 'PingFang SC', sans-serif",t.textAlign="center",t.fillText(l,d+s/2,r.y+a+u/2+4)}),n){t.fillStyle=g.textMuted,t.font="11px 'PingFang SC', sans-serif",t.textAlign="left";let l=r.y+r.height-6;t.fillText(`${n.meta.saveName} \xB7 ${new Date(n.meta.lastSaved).toLocaleDateString()}`,r.x+a,l)}}function xe(t,e){let a=e.width-24,o=Ae(t,e.text,a),s=o.length*22+24;return t.save(),E(t,{x:e.x,y:e.y,width:e.width,height:s},e.player?g.bubblePlayer:g.bubbleSystem,e.player?g.bubblePlayerBorder:"rgba(255,255,255,0.08)",10),t.fillStyle=e.player?g.textPrimary:g.textSecondary,t.font="14px 'PingFang SC', sans-serif",t.textAlign="left",o.forEach((u,c)=>{t.fillText(u,e.x+12,e.y+12+22*(c+.82))}),t.restore(),s}function Ae(t,e,n){let r=Array.from(e),a=[],o="";return r.forEach(s=>{let u=o+s;t.measureText(u).width>n&&o?(a.push(o),o=s):o=u}),o&&a.push(o),a}function E(t,e,n,r,a=18){let{x:o,y:s,width:u,height:c}=e;t.save(),t.beginPath(),t.moveTo(o+a,s),t.lineTo(o+u-a,s),t.quadraticCurveTo(o+u,s,o+u,s+a),t.lineTo(o+u,s+c-a),t.quadraticCurveTo(o+u,s+c,o+u-a,s+c),t.lineTo(o+a,s+c),t.quadraticCurveTo(o,s+c,o,s+c-a),t.lineTo(o,s+a),t.quadraticCurveTo(o,s,o+a,s),t.closePath(),t.fillStyle=n,t.fill(),r&&(t.strokeStyle=r,t.lineWidth=1,t.stroke()),t.restore()}function ut(t,e,n){let r=t.createLinearGradient(e.x,e.y,e.x+e.width,e.y+e.height);r.addColorStop(0,"#38bdf8"),r.addColorStop(1,"#3b82f6"),E(t,e,r,void 0,10),t.fillStyle="#0f172a",t.font="bold 14px 'PingFang SC', sans-serif",t.textAlign="center",t.fillText(n,e.x+e.width/2,e.y+e.height/2+4)}var B="1.0.0";function ct(){if(typeof wx!="undefined"&&typeof wx.setStorageSync=="function")return{setItem(e,n){wx.setStorageSync(e,n)},getItem(e){let n=wx.getStorageSync(e);return n===""?void 0:n},removeItem(e){wx.removeStorageSync(e)},getAllKeys(){return wx.getStorageInfoSync().keys},getSizeBytes(){return wx.getStorageInfoSync().currentSize*1024}};let t=new Map;return{setItem(e,n){t.set(e,n)},getItem(e){return t.get(e)},removeItem(e){t.delete(e)},getAllKeys(){return Array.from(t.keys())},getSizeBytes(){return Array.from(t.values()).reduce((e,n)=>e+n.length,0)}}}var $="sanguo_save_";function G(t){return JSON.parse(JSON.stringify(t))}function dt(t){return typeof Blob!="undefined"?new Blob([t]).size:typeof TextEncoder!="undefined"?new TextEncoder().encode(t).length:t.length*2}function ft(){let t=new Date().toISOString(),e=G(m),n=G(U),r=G(N);return{meta:{version:B,createdAt:t,lastSaved:t,playerId:e.id,saveName:"\u9ED8\u8BA4\u5B58\u6863",saveSlot:0},player:e,world:n,npcs:r,eventLog:[],dialogueHistory:[...M],progress:{totalTurns:0,lastEventId:"",lastEventTime:t}}}var V=class{constructor(){this.currentSlot=0;this.autoSaveEnabled=!0;this.autoSaveInterval=20;this.autoSaveTimer=null;this.storageLimits={maxSingleKeySize:1048576,maxTotalSize:10485760,maxDialogueHistory:100,maxEventLog:500,warningThreshold:.8};this.storage=ct()}init(){return console.log("\u5B58\u6863\u7CFB\u7EDF\u521D\u59CB\u5316"),this.startAutoSave(),!0}generatePlayerId(){return`player_${Date.now()}_${Math.floor(Math.random()*1e4)}`}createNewSave(e=0,n="\u65B0\u5EFA\u5B58\u6863"){let r=G(ft()),a=this.generatePlayerId(),o=new Date().toISOString();return r.meta=he(_({},r.meta),{playerId:a,createdAt:o,lastSaved:o,saveName:n,saveSlot:e}),r.player.id=a,this.currentSlot=e,r}optimizeSaveData(e){let n=G(e);return n.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(n.dialogueHistory=n.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory)),n.eventLog.length>this.storageLimits.maxEventLog&&(n.eventLog=n.eventLog.slice(-this.storageLimits.maxEventLog)),delete n.tempData,n}checkSaveSize(e){try{let n=JSON.stringify(e),r=dt(n),a=r<=this.storageLimits.maxSingleKeySize;return{size:r,withinLimit:a,warning:r>this.storageLimits.maxSingleKeySize*this.storageLimits.warningThreshold?`\u5B58\u6863\u5927\u5C0F ${r} \u5B57\u8282\u63A5\u8FD1\u5355\u952E\u9650\u5236`:null}}catch(n){return console.error("\u68C0\u67E5\u5B58\u6863\u5927\u5C0F\u5931\u8D25:",n),{size:0,withinLimit:!1,warning:null}}}checkTotalStorage(){try{let e=this.storage.getSizeBytes(),n=e/this.storageLimits.maxTotalSize;return{totalSize:e,usagePercentage:n,withinLimit:e<=this.storageLimits.maxTotalSize,warning:n>this.storageLimits.warningThreshold?`\u5B58\u50A8\u4F7F\u7528\u7387 ${(n*100).toFixed(1)}% \u63A5\u8FD1\u4E0A\u9650`:null}}catch(e){return console.error("\u68C0\u67E5\u5B58\u50A8\u4F7F\u7528\u60C5\u51B5\u5931\u8D25:",e),null}}save(e,n=!1){if(!e)return console.error("\u5B58\u6863\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A"),!1;let r=new Date().toISOString();e.meta.lastSaved=r,n&&(e.meta.lastAutoSave=r);let a=this.optimizeSaveData(e),o=this.checkSaveSize(a);if(!o.withinLimit&&(console.error(`\u5B58\u6863\u5927\u5C0F ${o.size} \u5B57\u8282\u8D85\u8FC7\u9650\u5236\uFF0C\u5C1D\u8BD5\u88C1\u526A...`),a.dialogueHistory=a.dialogueHistory.slice(-50),a.eventLog=a.eventLog.slice(-100),!this.checkSaveSize(a).withinLimit))return console.error("\u88C1\u526A\u540E\u4ECD\u8D85\u8FC7\u9650\u5236\uFF0C\u4FDD\u5B58\u5931\u8D25"),!1;o.warning&&console.warn(o.warning);let s=this.checkTotalStorage();s!=null&&s.warning&&console.warn(s.warning);let u=`${$}${this.currentSlot}`;try{let c=JSON.stringify(a);return this.storage.setItem(u,c),console.log(`\u5B58\u6863\u4FDD\u5B58\u6210\u529F\uFF08${n?"\u81EA\u52A8":"\u624B\u52A8"}\uFF09\uFF0C\u69FD\u4F4D: ${this.currentSlot}`),!0}catch(c){return console.error("\u5B58\u6863\u4FDD\u5B58\u5931\u8D25:",c),!1}}readSlot(e){let n=`${$}${e}`;try{let r=this.storage.getItem(n);if(!r)return null;let a=JSON.parse(r);return a.meta.version!==B&&console.warn(`\u5B58\u6863\u7248\u672C\u4E0D\u5339\u914D: ${a.meta.version} -> ${B}`),a}catch(r){return console.error("\u5B58\u6863\u8BFB\u53D6\u5931\u8D25:",r),null}}load(e=null){let n=e!=null?e:this.currentSlot;try{let r=this.readSlot(n);return r?(this.currentSlot=n,r):(console.log(`\u5B58\u6863\u69FD\u4F4D ${n} \u4E0D\u5B58\u5728`),null)}catch(r){return console.error("\u5B58\u6863\u52A0\u8F7D\u5931\u8D25:",r),null}}deleteSave(e){let n=`${$}${e}`;try{return this.storage.removeItem(n),console.log(`\u5B58\u6863\u5220\u9664\u6210\u529F\uFF0C\u69FD\u4F4D: ${e}`),!0}catch(r){return console.error("\u5B58\u6863\u5220\u9664\u5931\u8D25:",r),!1}}getSaveList(){let e=[];for(let n=0;n<10;n+=1){let r=this.readSlot(n);r&&e.push({slot:n,name:r.meta.saveName,playerId:r.meta.playerId,lastSaved:r.meta.lastSaved,era:r.world.era,location:r.player.location.region})}return e}logEvent(e,n,r){if(!e||!n)return console.error("logEvent \u53C2\u6570\u9519\u8BEF"),!1;let a=r||e.player.id;if(e.eventLog.some(s=>s.eventId===n&&s.playerId===a))return!0;let o=new Date().toISOString();return e.eventLog.push({eventId:n,playerId:a,triggeredAt:o,recordedAt:o}),e.progress.lastEventId=n,e.progress.lastEventTime=o,e.progress.totalTurns+=1,!0}isEventTriggered(e,n){return!e||!n?!1:e.eventLog.some(r=>r.eventId===n&&r.playerId===e.player.id)}updatePlayerAttributes(e,n){if(!e||!n)return e;if(n.attrs&&Object.entries(n.attrs).forEach(([r,a])=>{if(typeof a=="number"&&r in e.player.attrs){let o=e.player.attrs[r]+a;e.player.attrs[r]=Math.max(0,Math.min(100,o))}}),typeof n.legend=="number"&&(e.player.legend=Math.max(0,e.player.legend+n.legend)),typeof n.reputation=="number"){let r=e.player.reputation+n.reputation;e.player.reputation=Math.max(0,Math.min(100,r))}return n.resources&&Object.entries(n.resources).forEach(([r,a])=>{if(typeof a=="number"&&r in e.player.resources){let o=e.player.resources[r]+a;e.player.resources[r]=Math.max(0,o)}}),e}updateWorldState(e,n){return!e||!n||(n.era&&(e.world.era=n.era),n.flags&&n.flags.forEach(r=>{e.world.flags.includes(r)||e.world.flags.push(r)}),n.time&&(e.world.time=_(_({},e.world.time),n.time)),n.regions&&(e.world.regions=e.world.regions||{},Object.entries(n.regions).forEach(([r,a])=>{e.world.regions[r]=_(_({},e.world.regions[r]||{}),a)}))),e}addDialogueHistory(e,n){return!e||!n||(Array.isArray(n)?e.dialogueHistory.push(...n):e.dialogueHistory.push(n),e.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(e.dialogueHistory=e.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory))),e}startAutoSave(){!this.autoSaveEnabled||this.autoSaveTimer||(this.autoSaveTimer=setInterval(()=>{let e=this.load(this.currentSlot);e&&this.save(e,!0)},this.autoSaveInterval*1e3),console.log(`\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.autoSaveInterval} \u79D2`))}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u505C\u6B62"))}setAutoSaveInterval(e){this.autoSaveInterval=Math.max(10,e),this.autoSaveTimer&&(this.stopAutoSave(),this.startAutoSave())}exportSave(e=null){let n=this.load(e!=null?e:this.currentSlot);return n?JSON.stringify(n,null,2):null}importSave(e,n){try{let r=JSON.parse(e);if(!r.meta||!r.player)throw new Error("\u5B58\u6863\u683C\u5F0F\u65E0\u6548");return typeof n=="number"&&(this.currentSlot=n),this.save(r,!1)}catch(r){return console.error("\u5BFC\u5165\u5B58\u6863\u5931\u8D25:",r),!1}}getStorageInfo(){let e=this.storage.getSizeBytes(),n=this.storageLimits.maxTotalSize;return{total:n,used:e,available:Math.max(0,n-e),usagePercentage:e/n,keys:this.storage.getAllKeys()}}},v=new V;function x(t,e,n=120){return Array.isArray(e)?t.push(...e):t.push(e),gt(t,n),t}function Y(t){return t.pop()}function gt(t,e){t.length>e&&t.splice(0,t.length-e)}function I(){return typeof wx!="undefined"}function pt(){return wx}function q(){var r,a,o;let t=pt().getSystemInfoSync(),e=(r=t.statusBarHeight)!=null?r:0,n=(o=(a=t.safeArea)==null?void 0:a.top)!=null?o:e;return{windowWidth:t.windowWidth||375,windowHeight:t.windowHeight||667,pixelRatio:t.pixelRatio||2,statusBarHeight:e,safeAreaTop:Math.max(e,n,0)}}function Ce(){if(!I()||typeof wx.createCanvas!="function")return null;let t=q(),e=wx.createCanvas();return e.width=t.windowWidth*t.pixelRatio,e.height=t.windowHeight*t.pixelRatio,e}function Ie(t){if(!I())return;let e=wx.onTouchStart;if(typeof e!="function"){console.warn("[wxHelpers] wx.onTouchStart \u4E0D\u53EF\u7528\uFF0C\u89E6\u6478\u5C06\u65E0\u6CD5\u54CD\u5E94");return}e.call(wx,t)}function Pe(t){if(!I())return;let e=wx.onTouchMove;typeof e=="function"&&e.call(wx,t)}function Le(t){if(!I())return;let e=wx.onTouchEnd;typeof e=="function"&&e.call(wx,t)}function Ee(t){!I()||typeof wx.onKeyboardInput!="function"||wx.onKeyboardInput(t)}function He(t){!I()||typeof wx.onKeyboardConfirm!="function"||wx.onKeyboardConfirm(t)}function Re(t){!I()||typeof wx.onKeyboardComplete!="function"||wx.onKeyboardComplete(t)}function De(t,e=100){if(!(!I()||typeof wx.showKeyboard!="function"))try{let n=wx.getSystemInfoSync(),r=String((n==null?void 0:n.platform)||"").toLowerCase();if(r==="devtools"||r==="mac"||r==="windows")return;wx.showKeyboard({defaultValue:t||"",maxLength:Math.max(1,Math.min(e,200)),multiple:!1,confirmHold:!1,confirmType:"done"})}catch(n){try{wx.hideKeyboard({})}catch(r){}}}function J(){!I()||typeof wx.hideKeyboard!="function"||wx.hideKeyboard({})}function X(t){if(typeof wx!="undefined"&&typeof wx.requestAnimationFrame=="function"){wx.requestAnimationFrame(t);return}setTimeout(()=>t(Date.now()),16)}function _e(t){return!I()||typeof wx.request!="function"?Promise.reject(new Error("wx.request \u4E0D\u53EF\u7528")):new Promise((e,n)=>{var r;wx.request({url:t.url,data:t.data,method:t.method||"POST",header:t.header||{"Content-Type":"application/json"},timeout:(r=t.timeout)!=null?r:15e3,enableChunked:!0,success(a){e({statusCode:a.statusCode,data:a.data})},fail(a){n(a instanceof Error?a:new Error("wx.request \u8C03\u7528\u5931\u8D25"))}})})}function ht(){var t;return typeof wx!="undefined"&&typeof((t=wx.cloud)==null?void 0:t.callFunction)=="function"}async function Me(t){let{CLOUD_ENV:e,ADJUDICATION_API:n,MAX_RETRIES:r,RETRY_DELAY:a,REQUEST_TIMEOUT:o}=C;if(ht()&&e)try{let l=await wx.cloud.callFunction({name:"adjudication",data:t}),d=l==null?void 0:l.result;if(d&&typeof d=="object"&&d.result)return d;throw new Error("\u4E91\u51FD\u6570\u8FD4\u56DE\u683C\u5F0F\u5F02\u5E38")}catch(l){throw l instanceof Error?l:new Error("\u4E91\u51FD\u6570\u8C03\u7528\u5931\u8D25")}let u=0,c=null;for(;u<=r;)try{let l=await _e({url:n,data:t,method:"POST",timeout:o,header:{"Content-Type":"application/json"}});if(l.statusCode>=200&&l.statusCode<300)return l.data;throw new Error(`\u88C1\u51B3 API \u8FD4\u56DE ${l.statusCode}`)}catch(l){if(c=l,u+=1,u>r)break;await new Promise(d=>setTimeout(d,a))}throw c instanceof Error?c:new Error("\u88C1\u51B3\u8BF7\u6C42\u5931\u8D25")}var T=null,W=!1,Oe=!1,Ue=12e4,Q=0;function yt(){if(!(T||Oe)&&(Oe=!0,!(typeof wx=="undefined"||typeof wx.createRewardedVideoAd!="function")))try{T=wx.createRewardedVideoAd({adUnitId:C.AD_UNIT_ID}),T.onLoad(()=>{W=!0}),T.onError(()=>{W=!1}),T.onClose(()=>{W=!0})}catch(t){T=null}}function Z(t){let e=Date.now();if(e-Q<Ue){console.log(`[ads] trigger=${t}, cooldown active (${Math.ceil((Ue-(e-Q))/1e3)}s remaining)`);return}if(yt(),!T||!W){console.log(`[ads] trigger=${t}, but rewarded ad not ready`);return}T.show().then(()=>{Q=Date.now(),W=!1}).catch(()=>{T==null||T.load().then(()=>T==null?void 0:T.show()).catch(n=>{console.warn("[ads] failed to show rewarded ad:",n)})})}var mt=["\u4F5C\u5F0A\u5668","\u5916\u6302","\u66B4\u6050","\u4F4E\u4FD7","\u8D4C\u535A","\u653F\u6CBB\u654F\u611F","\u6D89\u9EC4","\u8FDD\u6CD5","\u6050\u6016\u88AD\u51FB","\u8272\u60C5","\u53CD\u52A8","\u66B4\u529B","\u8840\u8165","\u6BD2\u54C1","\u8BC8\u9A97","\u4F20\u9500","\u90AA\u6559","\u5206\u88C2","\u98A0\u8986"];function Ne(t){let e=t.toLowerCase();return mt.some(n=>e.includes(n.toLowerCase()))}function ke(t){var r;let e=typeof wx!="undefined"?wx:null,n=(r=e==null?void 0:e.security)==null?void 0:r.msgSecCheck;return typeof n!="function"?Promise.resolve(!0):new Promise(a=>{n({data:{content:t,version:2,scene:2,openid:""},success:()=>a(!0),fail:()=>a(!1)})})}async function Ge(t){return t.trim()?Ne(t)?{allowed:!1,reason:"\u8F93\u5165\u5185\u5BB9\u6D89\u53CA\u654F\u611F\u8BCD\uFF0C\u5DF2\u88AB\u62E6\u622A"}:await ke(t)?{allowed:!0}:{allowed:!1,reason:"\u5185\u5BB9\u672A\u901A\u8FC7\u5E73\u53F0\u5BA1\u6838\uFF0C\u8BF7\u8C03\u6574\u540E\u518D\u8BD5"}:{allowed:!1,reason:"\u8BF7\u8F93\u5165\u6709\u6548\u5185\u5BB9"}}async function ee(t){return Ne(t)?{allowed:!1,reason:"\u751F\u6210\u5185\u5BB9\u5305\u542B\u654F\u611F\u4FE1\u606F\uFF0C\u5DF2\u81EA\u52A8\u5C4F\u853D"}:await ke(t)?{allowed:!0,text:t}:{allowed:!1,reason:"\u751F\u6210\u5185\u5BB9\u672A\u901A\u8FC7\u5BA1\u6838\uFF0C\u5DF2\u66FF\u6362\u4E3A\u7CFB\u7EDF\u56DE\u590D"}}var i={canvas:null,ctx:null,layout:null,screenWidth:0,screenHeight:0,pixelRatio:1,playerAttributes:{strength:m.attrs.strength,intelligence:m.attrs.intelligence,charm:m.attrs.charm,luck:m.attrs.luck,legend:m.legend},dialogueHistory:[...M],input:Se(),isSaveLoadPanelVisible:!1,currentSaveData:null,isAdjudicating:!1,loopActive:!1,dialogueScrollOffset:0,touchStartY:0,touchStartScroll:0,isDialogueScrollActive:!1},We=!1,Ke=!1;function K(t,e,n){var o,s;let r=(o=t.x)!=null?o:0,a=(s=t.y)!=null?s:0;return e>=r&&e<=r+t.width&&n>=a&&n<=a+t.height}function h(){if(!i.ctx||!i.layout)return;let t=Math.floor(Date.now()/4e3)%3;Te({ctx:i.ctx,layout:i.layout,screenWidth:i.screenWidth,screenHeight:i.screenHeight,playerAttributes:i.playerAttributes,dialogueHistory:i.dialogueHistory,currentInput:i.input.value,currentSaveData:i.currentSaveData,isSaveLoadPanelVisible:i.isSaveLoadPanelVisible,keyboardActive:i.input.isKeyboardVisible,dialogueScrollOffset:i.dialogueScrollOffset,placeholderIndex:t})}function re(){i.currentSaveData&&v.save(i.currentSaveData,!0)}function ae(){i.currentSaveData&&v.save(i.currentSaveData,!0)}function z(){var t,e,n,r,a;i.currentSaveData&&(i.playerAttributes={strength:(t=i.currentSaveData.player.attrs.strength)!=null?t:m.attrs.strength,intelligence:(e=i.currentSaveData.player.attrs.intelligence)!=null?e:m.attrs.intelligence,charm:(n=i.currentSaveData.player.attrs.charm)!=null?n:m.attrs.charm,luck:(r=i.currentSaveData.player.attrs.luck)!=null?r:m.attrs.luck,legend:(a=i.currentSaveData.player.legend)!=null?a:m.legend},i.dialogueHistory=i.currentSaveData.dialogueHistory.length>0?[...i.currentSaveData.dialogueHistory]:[...M])}function te(){let t=i.dialogueHistory.at(-1);(t!=null&&t.startsWith("\uFF08\u6B63\u5728\u751F\u6210\u5267\u60C5")||t==="\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09")&&Y(i.dialogueHistory)}function St(t){var e,n;return me({saveData:i.currentSaveData,playerIntent:t,recentDialogue:(n=(e=i.currentSaveData)==null?void 0:e.dialogueHistory)==null?void 0:n.slice(-5)})}function je(t){var o,s;if(!i.currentSaveData)return;let e={},n={},r=0,a=0;for(let u of t){let c=u.match(/^([a-zA-Z_]+)([+-]\d+)$/);if(!c)continue;let[,l,d]=c,f=Number(d);Number.isNaN(f)||(l in i.currentSaveData.player.attrs?e[l]=((o=e[l])!=null?o:0)+f:l==="legend"?r+=f:l==="reputation"?a+=f:l in i.currentSaveData.player.resources&&(n[l]=((s=n[l])!=null?s:0)+f))}v.updatePlayerAttributes(i.currentSaveData,{attrs:e,legend:r,reputation:a,resources:n})}function vt(t){var r,a,o,s,u,c,l;i.dialogueScrollOffset=0;let e=(a=(r=t.result)==null?void 0:r.narrative)!=null?a:"\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u6CE8\u610F\u3002";ee(e).then(d=>{var f;d.allowed&&d.text?x(i.dialogueHistory,d.text):x(i.dialogueHistory,(f=d.reason)!=null?f:"\u5185\u5BB9\u6682\u65F6\u4E0D\u53EF\u7528"),h()}).catch(()=>{x(i.dialogueHistory,e),h()}),i.currentSaveData&&(v.addDialogueHistory(i.currentSaveData,e),(o=t.state_changes)!=null&&o.player&&t.state_changes.player.length>0&&je(t.state_changes.player),(s=t.result)!=null&&s.effects&&je(t.result.effects),(u=t.state_changes)!=null&&u.world&&v.updateWorldState(i.currentSaveData,t.state_changes.world),re(),z()),((l=(c=t.result)==null?void 0:c.effects)!=null?l:[]).some(d=>d.includes("legend+")||d.includes("gold+"))&&Z("legend-boost")}function bt(t){setTimeout(()=>{let e="\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u53BF\u5C09\u7684\u6CE8\u610F\uFF0C\u4ED6\u5BF9\u4F60\u7684\u884C\u4E3A\u8868\u793A\u8D5E\u8D4F\u3002";ee(e).then(n=>{var r;n.allowed&&n.text?x(i.dialogueHistory,n.text):x(i.dialogueHistory,(r=n.reason)!=null?r:"\u5185\u5BB9\u6682\u65F6\u4E0D\u53EF\u7528")}).finally(()=>{i.currentSaveData&&(v.addDialogueHistory(i.currentSaveData,e),v.updatePlayerAttributes(i.currentSaveData,{attrs:{intelligence:1},reputation:3}),re(),z()),h()})},1e3)}function wt(t){let e=t.trim().toLowerCase();return["help","\u5E2E\u52A9","\u6307\u4EE4"].includes(e)?"help":["\u5B58\u6863","\u4FDD\u5B58","save"].includes(e)?"save":["\u8BFB\u6863","\u8F7D\u5165","load"].includes(e)?"load":["\u4F60\u662F\u8C01","who are you","about"].includes(e)?"about":["\u5E7F\u544A","\u798F\u5229","reward"].includes(e)?"ad":null}async function xt(t){let e=wt(t);if(!e)return!1;if(e==="help")return x(i.dialogueHistory,["\u3010\u6307\u4EE4\u63D0\u793A\u3011\u76F4\u63A5\u8F93\u5165\u4EE5\u4E0B\u547D\u4EE4\uFF0C\u65E0\u9700\u8C03\u7528\u88C1\u51B3\uFF1A","\u2022 \u5B58\u6863 / \u4FDD\u5B58 / save \u2014 \u624B\u52A8\u4FDD\u5B58\u8FDB\u5EA6","\u2022 \u8BFB\u6863 / \u8F7D\u5165 / load \u2014 \u52A0\u8F7D\u6700\u65B0\u5B58\u6863","\u2022 \u4F60\u662F\u8C01 / about \u2014 \u4E86\u89E3\u6E38\u620F","\u2022 \u5E7F\u544A / \u798F\u5229 \u2014 \u89C2\u770B\u6FC0\u52B1\u5E7F\u544A","\u3010\u73A9\u6CD5\u3011\u8F93\u5165\u5267\u60C5\u610F\u56FE\uFF08\u5982\u300C\u524D\u5F80\u6D1B\u9633\u300D\u300C\u6253\u542C\u6D88\u606F\u300D\u300C\u6295\u9760\u66F9\u64CD\u300D\uFF09\u53EF\u63A8\u8FDB\u6545\u4E8B\uFF0C\u6B66\u529B\u3001\u667A\u529B\u7B49\u5C5E\u6027\u4F1A\u5F71\u54CD\u5267\u60C5\u8D70\u5411\u3002"]),h(),!0;if(e==="save")return le(),!0;if(e==="load"){let n=ue();return x(i.dialogueHistory,n?"\u3010\u63D0\u793A\u3011\u6700\u65B0\u5B58\u6863\u5DF2\u52A0\u8F7D\u3002":"\u3010\u63D0\u793A\u3011\u6682\u65E0\u53EF\u7528\u5B58\u6863\u3002"),h(),!0}return e==="about"?(x(i.dialogueHistory,"\u6211\u662F\u4E00\u540D\u8D1F\u8D23\u4E3B\u6301\u5192\u9669\u7684\u519B\u673A\u53C2\u8C0B\uFF0C\u968F\u65F6\u8BB0\u5F55\u4F60\u7684\u6BCF\u4E00\u6B21\u6289\u62E9\u3002"),h(),!0):e==="ad"?(Z("user-request"),x(i.dialogueHistory,"\u5E7F\u544A\u52A0\u8F7D\u4E2D\uFF0C\u5B8C\u6210\u89C2\u770B\u53EF\u83B7\u5F97\u989D\u5916\u8D44\u6E90\u5956\u52B1\u3002"),h(),!0):!1}function Tt(){Ke||!I()||(Ie(t=>Fe(t)),Pe(t=>Ct(t)),Le(t=>It(t)),Ee(t=>{ve(i.input,t.value),h()}),He(()=>{se().catch(t=>console.error(t))}),Re(()=>{k(i.input,!1),h()}),Ke=!0)}function At(t,e){if(!i.layout)return;let n=i.layout.inputArea,r=12,a=64,o={x:n.x+n.width-r-a,y:n.y+r,width:a,height:n.height-r*2};K(o,t,e)?se().catch(s=>console.error(s)):$e()}function oe(){var s;if(We)return{ready:!0};let t=Ce();if(!t)return{ready:!1,message:"\u65E0\u6CD5\u521B\u5EFA Canvas\uFF0C\u4E0A\u4E0B\u6587\u4E0D\u53EF\u7528"};let e=q(),n=e.pixelRatio||1,r=e.windowWidth,a=e.windowHeight,o=t.getContext("2d");return o?(n!==1&&typeof o.scale=="function"&&o.scale(n,n),i.canvas=t,i.ctx=o,i.screenWidth=r,i.screenHeight=a,i.pixelRatio=n,i.layout=be(i.screenWidth,i.screenHeight,(s=e.safeAreaTop)!=null?s:0),v.init(),ue(),Tt(),h(),We=!0,{ready:!0}):{ready:!1,message:"\u65E0\u6CD5\u83B7\u53D6 CanvasRenderingContext2D"}}function ie(){if(i.loopActive)return;i.loopActive=!0;let t=()=>{h(),X(t)};X(t)}function ze(t){var s,u,c,l,d;let e=(c=(s=t.touches)==null?void 0:s[0])!=null?c:(u=t.changedTouches)==null?void 0:u[0];if(!e)return null;let n=(l=e.clientX)!=null?l:e.x,r=(d=e.clientY)!=null?d:e.y;if(n==null||r==null)return null;let a=i.pixelRatio>0?i.pixelRatio:1,o=typeof e.clientX=="number";return{x:o?n:n/a,y:o?r:r/a}}function Ct(t){if(!i.isDialogueScrollActive||!i.layout)return;let e=ze(t);if(!e)return;let n=i.touchStartY-e.y,r=Math.max(0,i.dialogueHistory.length*50-i.layout.dialogueArea.height);i.dialogueScrollOffset=Math.max(0,Math.min(r,i.touchStartScroll+n)),i.touchStartY=e.y,i.touchStartScroll=i.dialogueScrollOffset}function It(t){i.isDialogueScrollActive=!1}function Fe(t){var l,d;if(!i.layout)return;let e=ze(t);if(!e)return;let{x:n,y:r}=e;C.DEBUG_TOUCH&&typeof wx!="undefined"&&wx.showToast&&wx.showToast({title:`x:${Math.round(n)} y:${Math.round(r)}`,icon:"none",duration:500});let{inputArea:a,saveLoadPanel:o,attributePanel:s,dialogueArea:u}=i.layout;if(K(a,n,r)){At(n,r);return}if(K(u,n,r)){i.isDialogueScrollActive=!0,i.touchStartY=r,i.touchStartScroll=i.dialogueScrollOffset;return}if(i.isSaveLoadPanelVisible&&K(o,n,r)){let f=((l=o.x)!=null?l:0)+o.width/2;n<f?le():ne();return}let c=((d=s.x)!=null?d:0)+s.width-60;K(s,n,r)&&n>=c&&ne()}function $e(){k(i.input,!0),De(i.input.value),h()}async function se(){var l,d,f,p,A;if(i.isAdjudicating){typeof wx!="undefined"&&wx.showToast&&wx.showToast({title:"\u6B63\u5728\u5904\u7406\uFF0C\u8BF7\u7A0D\u5019",icon:"none",duration:1500});return}let t=i.input.value.trim();if(!t)return;if(await xt(t)){F(i.input),J(),k(i.input,!1),h();return}let n=await Ge(t);if(!n.allowed){x(i.dialogueHistory,(l=n.reason)!=null?l:"\u8F93\u5165\u672A\u901A\u8FC7\u5B89\u5168\u5BA1\u6838"),h();return}let r="\uFF08\u6B63\u5728\u751F\u6210\u5267\u60C5\uFF0C\u8BF7\u7A0D\u5019\u2026\u9996\u6B21\u54CD\u5E94\u53EF\u80FD\u9700 5\uFF5E15 \u79D2\uFF09";x(i.dialogueHistory,[`\u4F60\u8BF4\uFF1A"${t}"`,r]),i.currentSaveData&&v.addDialogueHistory(i.currentSaveData,[`\u4F60\u8BF4\uFF1A"${t}"`,r]),F(i.input),J(),k(i.input,!1),re(),h(),i.isAdjudicating=!0;let a=St(t),o=C.ADJUDICATION_API,s=/localhost|127\.0\.0\.1/.test(o),u=typeof wx!="undefined"&&["android","ios"].includes(String((p=(f=(d=wx.getSystemInfoSync)==null?void 0:d.call(wx))==null?void 0:f.platform)!=null?p:"").toLowerCase()),c=!!(typeof wx!="undefined"&&((A=wx.cloud)!=null&&A.callFunction)&&C.CLOUD_ENV);if(s&&u&&!c){te(),bt(t),i.isAdjudicating=!1;return}try{let y=await Me(a);te(),vt(y)}catch(y){te(),i.dialogueScrollOffset=0;let L=y instanceof Error?y.message:"\u88C1\u51B3\u8BF7\u6C42\u5931\u8D25";x(i.dialogueHistory,`\u88C1\u51B3\u5931\u8D25\uFF1A${L}\uFF08\u8BF7\u68C0\u67E5\u4E91\u51FD\u6570\u914D\u7F6E\u4E0E\u7F51\u7EDC\uFF0C\u6216\u7A0D\u540E\u91CD\u8BD5\uFF09`),h(),console.warn("\u88C1\u51B3 API \u8C03\u7528\u5931\u8D25:",y)}finally{i.isAdjudicating=!1}}function ne(){i.isSaveLoadPanelVisible=!i.isSaveLoadPanelVisible,h()}function le(){i.currentSaveData||(i.currentSaveData=v.createNewSave(0,"\u624B\u52A8\u5B58\u6863")),v.save(i.currentSaveData,!1)&&(x(i.dialogueHistory,"\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"),h(),setTimeout(()=>{i.dialogueHistory.at(-1)==="\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"&&(Y(i.dialogueHistory),h())},5e3))}function ue(){let t=v.load(0);if(t)return i.currentSaveData=t,z(),!0;let e=v.createNewSave(0,"\u521D\u59CB\u5B58\u6863");return v.save(e,!1)?(i.currentSaveData=e,z(),!0):(i.currentSaveData=null,i.dialogueHistory=[...M],!1)}var Be=!1;function Pt(){var e;if(Be)return;typeof wx!="undefined"&&((e=wx.cloud)!=null&&e.init)&&C.CLOUD_ENV&&wx.cloud.init({env:C.CLOUD_ENV});let t=oe();if(!t.ready){console.error("\u6E38\u620F\u521D\u59CB\u5316\u5931\u8D25:",t.message);return}ie(),Be=!0}typeof wx!="undefined"&&typeof wx.onShow=="function"&&(wx.onShow(Pt),wx.onHide(()=>{ae()}),wx.onError(t=>{console.error("\u6E38\u620F\u9519\u8BEF:",t)}));
