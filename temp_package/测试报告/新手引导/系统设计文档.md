# 三国文字沙箱游戏 - 新手引导系统设计文档

## 1. 设计背景与目标

### 1.1 问题识别
基于灰度测试反馈，轻度用户（用户C）面临的核心问题：
- **输入迷茫**：游戏开始时不知道能输入什么意图
- **目标缺失**：缺乏明确的短期和长期目标指引
- **系统不透明**：意图被拒绝时缺乏明确解释，因果关系不理解

### 1.2 核心设计目标
1. **消除输入迷茫**：提供清晰的意图示例和引导性任务
2. **建立目标感**：设计分层目标系统（新手任务→短期目标→长期追求）
3. **提升系统透明度**：标准化拒绝理由和属性门槛提示
4. **保持低认知负荷**：遵循轻度用户偏好，避免复杂学习曲线

### 1.3 目标用户画像
- **用户类型**：轻度游戏用户
- **游戏经验**：休闲游戏为主，避免复杂操作
- **历史知识**：三国背景了解有限
- **核心需求**：简单直观、即时反馈、明确目标指引

## 2. 系统架构设计

### 2.1 总体架构图
```
新手引导系统
├── 引导任务管理器
│   ├── 任务定义引擎
│   ├── 进度追踪器
│   └── 奖励发放器
├── 示例意图系统
│   ├── 示例库管理器
│   ├── 智能推荐器
│   └── 一键输入器
├── 目标指引系统
│   ├── 目标定义层
│   ├── 进度可视化层
│   └── 成就反馈层
└── 系统集成接口
    ├── 客户端集成模块
    ├── 服务端集成模块
    └── 数据持久化模块
```

### 2.2 核心组件说明

#### 2.2.1 引导任务管理器
- **功能**：管理新手引导任务的创建、追踪、完成和奖励
- **任务类型**：
  - **操作类任务**：完成特定游戏操作（如首次输入、查看属性面板）
  - **进度类任务**：达成特定游戏进度（如触发3个事件）
  - **探索类任务**：尝试特定类型的意图（如社交、学习、交易）
- **任务生命周期**：创建 → 激活 → 进行中 → 可完成 → 已完成

#### 2.2.2 示例意图系统
- **功能**：提供意图输入参考，降低新手门槛
- **示例分类**：
  - **基础操作**："游览洛阳"、"查看属性"、"保存游戏"
  - **属性提升**："学习武艺"、"读书识字"、"练习口才"
  - **社交互动**："结交朋友"、"拜访官员"、"参与宴席"
  - **资源获取**："买卖商品"、"做小生意"、"寻找宝物"
- **推荐策略**：基于当前游戏状态和玩家进度智能推荐

#### 2.2.3 目标指引系统
- **功能**：提供分层目标指引，增强游戏动力
- **目标层级**：
  - **新手目标**（0-10分钟）：熟悉基础操作，完成引导任务
  - **短期目标**（10-30分钟）：达成特定游戏状态，获得初期奖励
  - **长期追求**（30分钟以上）：解锁高级内容，追求游戏终局

#### 2.2.4 系统集成接口
- **客户端集成**：在现有UI基础上添加引导元素
- **服务端集成**：扩展状态管理系统，支持引导状态跟踪
- **数据持久化**：与现有存档系统兼容，保存引导进度

## 3. 数据库设计

### 3.1 新增表结构
```sql
-- 引导任务定义表
CREATE TABLE IF NOT EXISTS tutorial_task_definitions (
  task_id TEXT PRIMARY KEY,
  task_name TEXT NOT NULL,
  task_description TEXT NOT NULL,
  task_type TEXT NOT NULL,  -- 'operation', 'progress', 'exploration'
  completion_condition JSON NOT NULL,  -- 完成条件定义
  reward JSON NOT NULL,  -- 奖励定义
  priority INTEGER DEFAULT 0,
  is_required BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 玩家引导进度表
CREATE TABLE IF NOT EXISTS player_tutorial_progress (
  player_id TEXT NOT NULL,
  task_id TEXT NOT NULL,
  current_progress INTEGER DEFAULT 0,
  required_progress INTEGER NOT NULL,
  status TEXT NOT NULL,  -- 'not_started', 'in_progress', 'completed', 'claimed'
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  claimed_at TIMESTAMP,
  PRIMARY KEY (player_id, task_id),
  FOREIGN KEY (task_id) REFERENCES tutorial_task_definitions(task_id)
);

-- 示例意图库
CREATE TABLE IF NOT EXISTS example_intents (
  example_id TEXT PRIMARY KEY,
  intent_text TEXT NOT NULL,
  category TEXT NOT NULL,  -- 'basic', 'attribute', 'social', 'resource'
  description TEXT NOT NULL,
  recommended_for TEXT,  -- 推荐场景
  priority INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 现有表扩展
在 `player_progress` 表中添加引导相关字段：
```sql
ALTER TABLE player_progress ADD COLUMN tutorial_completed BOOLEAN DEFAULT false;
ALTER TABLE player_progress ADD COLUMN last_shown_example_category TEXT;
ALTER TABLE player_progress ADD COLUMN tutorial_progress_json TEXT;
```

## 4. 引导任务设计

### 4.1 核心新手引导任务（示例实现）

#### 任务1：完成首次输入
- **任务ID**：`tutorial_first_input`
- **任务类型**：操作类
- **完成条件**：成功提交一次意图输入
- **奖励**：
  ```json
  {
    "type": "attribute_bonus",
    "target": "luck",
    "value": 5,
    "message": "勇气可嘉！你的运气提升了。"
  }
  ```
- **UI引导**：输入框高亮显示，显示提示文本"试试输入'游览洛阳'"

#### 任务2：触发第一个事件
- **任务ID**：`tutorial_first_event`
- **任务类型**：进度类
- **完成条件**：触发任意游戏事件
- **奖励**：
  ```json
  {
    "type": "resource",
    "target": "gold",
    "value": 50,
    "message": "初入江湖，获得起步资金。"
  }
  ```
- **UI引导**：对话历史区域显示事件触发提示

#### 任务3：查看属性面板
- **任务ID**：`tutorial_view_attributes`
- **任务类型**：操作类
- **完成条件**：查看属性面板（通过点击或相关操作）
- **奖励**：
  ```json
  {
    "type": "attribute_bonus",
    "target": "intelligence",
    "value": 3,
    "message": "知己知彼，智慧有所提升。"
  }
  ```
- **UI引导**：属性面板区域轻微脉动动画

### 4.2 任务管理系统流程
```
1. 玩家创建/加载存档
   ↓
2. 系统检查引导进度
   ↓
3. 激活符合条件的任务
   ↓
4. 监听游戏事件，更新任务进度
   ↓
5. 进度达到100% → 任务可完成
   ↓
6. 玩家领取奖励，标记任务完成
   ↓
7. 激活下一个任务（如有）
```

## 5. UI/UX设计

### 5.1 引导元素集成

#### 5.1.1 输入引导区（在输入区域上方）
```
+---------------------------------------+
| [新] 试试输入这些：                   |
| 游览洛阳 | 学习武艺 | 结交朋友        |
| [更多示例]                            |
+---------------------------------------+
| 输入框 [________________________] [发送]|
+---------------------------------------+
```
- **功能**：提供一键输入示例，降低打字负担
- **交互**：点击示例直接填充输入框，可点击发送

#### 5.1.2 任务面板（在属性面板下方）
```
+---------------------------------------+
| [新手任务]                            |
| ✓ 完成首次输入（+5运气）             |
| ⏳ 触发第一个事件（1/1）              |
| ○ 查看属性面板                        |
| [领取奖励]                            |
+---------------------------------------+
```
- **状态显示**：✓ 已完成 ⏳ 进行中 ○ 未开始
- **进度显示**：显示当前进度（如1/1）
- **奖励按钮**：完成任务后显示可点击的奖励按钮

#### 5.1.3 目标指引条（在屏幕顶部）
```
[当前目标]：完成3个新手任务 → 解锁更多功能
[进度]：■■■■□□□□□□ 30%
```
- **显示位置**：游戏开始时显示，5分钟后可隐藏
- **内容**：显示当前最重要的短期目标
- **进度**：可视化进度条

### 5.2 视觉设计原则
1. **非侵入性**：引导元素不遮挡核心游戏内容
2. **渐进式**：按需展示引导，避免信息过载
3. **可关闭**：玩家可随时隐藏引导元素
4. **一致性**：与现有UI风格保持一致（简约、古风）

## 6. 技术实现方案

### 6.1 客户端实现

#### 6.1.1 新增模块结构
```
src/client/
├── tutorial/
│   ├── TutorialManager.js      # 引导管理器主类
│   ├── TaskTracker.js          # 任务追踪器
│   ├── ExampleSystem.js        # 示例系统
│   ├── ui/
│   │   ├── TaskPanel.js        # 任务面板UI
│   │   ├── ExampleBar.js       # 示例栏UI
│   │   └── GoalIndicator.js    # 目标指示器UI
│   └── events/
│       └── TutorialEvents.js   # 引导相关事件
└── main.js                     # 集成引导系统
```

#### 6.1.2 核心集成代码示例
```javascript
// main.js 中的集成点
import TutorialManager from './tutorial/TutorialManager.js';

class Game {
  constructor() {
    this.tutorialManager = new TutorialManager();
  }
  
  initGame() {
    // 初始化引导系统
    this.tutorialManager.init(this.currentSaveData);
    
    // 监听游戏事件
    this.setupTutorialListeners();
  }
  
  setupTutorialListeners() {
    // 监听输入提交
    this.onInputSubmit((intent) => {
      this.tutorialManager.onIntentSubmitted(intent);
    });
    
    // 监听事件触发
    this.onEventTriggered((event) => {
      this.tutorialManager.onEventTriggered(event);
    });
  }
}
```

### 6.2 服务端实现

#### 6.2.1 引导状态管理
在现有裁决流程中集成引导状态检查：
```javascript
// 在裁决流程开始时检查引导相关状态
function checkTutorialRequirements(playerState, intent) {
  const tutorialProgress = playerState.tutorial_progress;
  
  // 检查是否需要显示示例
  if (tutorialProgress && !tutorialProgress.first_input_completed) {
    return {
      show_examples: ['游览洛阳', '学习武艺', '结交朋友'],
      hint: '试试输入这些意图开始游戏'
    };
  }
  
  return null;
}
```

#### 6.2.2 引导任务完成验证
```javascript
// 验证引导任务完成条件
function validateTutorialCompletion(playerState, adjudicationResult) {
  const tasks = getActiveTutorialTasks(playerState);
  const updates = [];
  
  for (const task of tasks) {
    if (checkTaskCompletion(task, adjudicationResult)) {
      updates.push({
        task_id: task.id,
        completed: true,
        reward: task.reward
      });
    }
  }
  
  return updates;
}
```

### 6.3 数据同步方案
1. **引导状态保存**：随存档数据一起保存到本地
2. **进度同步**：引导任务进度存储在现有存档系统中
3. **兼容性处理**：旧存档自动初始化引导状态

## 7. 验收标准与测试方案

### 7.1 功能验收标准
1. **引导任务系统**：
   - [ ] 3个示例引导任务可正常触发和完成
   - [ ] 任务进度正确追踪和显示
   - [ ] 奖励可正常领取并应用到游戏状态

2. **示例意图系统**：
   - [ ] 示例意图分类显示正确
   - [ ] 一键输入功能正常工作
   - [ ] 智能推荐基于游戏状态

3. **目标指引系统**：
   - [ ] 分层目标清晰显示
   - [ ] 进度可视化准确
   - [ ] 成就反馈及时

### 7.2 性能验收标准
1. **包体大小**：新增代码≤500KB（总包体保持≤4MB）
2. **加载时间**：引导系统初始化≤200ms
3. **内存占用**：引导相关数据≤100KB

### 7.3 用户体验验收标准
1. **易用性**：轻度用户可在5分钟内完成基础引导
2. **可理解性**：引导提示清晰易懂，无歧义
3. **可控性**：用户可隐藏/跳过引导元素

## 8. 实施计划与风险控制

### 8.1 实施阶段
1. **第一阶段（基础框架）**：实现引导任务管理器核心逻辑
2. **第二阶段（UI集成）**：集成引导UI元素到现有界面
3. **第三阶段（内容完善）**：完善示例意图库和任务设计
4. **第四阶段（测试优化）**：用户测试和体验优化

### 8.2 风险控制
1. **技术风险**：引导系统与现有代码兼容性问题
   - **应对**：采用渐进式集成，充分测试各模块接口
   
2. **体验风险**：引导过于侵入或信息过载
   - **应对**：A/B测试不同引导方案，收集用户反馈
   
3. **性能风险**：新增功能影响游戏流畅度
   - **应对**：性能监控和优化，确保核心游戏循环优先

## 9. 后续扩展方向

### 9.1 短期扩展（下个版本）
1. **更多引导任务**：增加5-10个进阶引导任务
2. **动态示例系统**：基于玩家行为模式推荐意图
3. **成就系统**：将引导任务扩展为完整成就系统

### 9.2 长期规划
1. **个性化引导**：基于玩家类型（轻度/资深）提供不同引导路径
2. **社区示例**：玩家分享和投票最佳意图示例
3. **引导编辑器**：允许创作者自定义引导流程

---

**文档版本**：1.0  
**创建时间**：2026年02月10日  
**最后更新**：2026年02月10日  
**维护人**：扣子（Worker Agent）  
**状态**：✅ 已完成初稿，待实现验证