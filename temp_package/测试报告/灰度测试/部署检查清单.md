# 灰度测试部署检查清单

## 概述
本清单用于指导灰度测试环境的完整部署，确保客户端（微信小游戏）与服务端（裁决API）均就绪，能够收集真实用户反馈。

## 前置条件验证
- [ ] 已安装微信开发者工具（最新稳定版）
- [ ] 拥有微信小游戏测试号或体验版 AppID
- [ ] 本地 Mac 环境（目标目录：`/Users/liyulong/Desktop/caozei`）
- [ ] 终端访问权限（用于解压与文件操作）
- [ ] Node.js 环境（v16+，用于服务端）

## 第一步：代码包验证
### 检查代码包完整性
- [ ] 确认 `outputs/game_code_latest.zip` 文件存在（约9.1KB）
- [ ] 解压测试：执行以下命令验证无损坏
  ```bash
  mkdir -p temp_validation
  unzip -o outputs/game_code_latest.zip -d temp_validation
  ls -la temp_validation/
  ```
- [ ] 验证解压后包含以下6个必需文件：
  - `build_report.md`
  - `config.min.js`
  - `game.json`
  - `game.min.js`
  - `main.min.js`
  - `save.min.js`

### 包体大小确认
- [ ] 总大小 ≤ 4MB（实际约21KB，符合要求）
- [ ] 各文件大小正常（无0字节文件）

## 第二步：客户端部署（微信开发者工具）
### 解压与目录准备
- [ ] 创建或清空目标目录：`/Users/liyulong/Desktop/caozei`
- [ ] 解压代码包到目标目录：
  ```bash
  cd "/Users/liyulong/Desktop/caozei"
  unzip -o ~/Downloads/game_code_latest.zip
  ```
- [ ] 验证目标目录包含上述6个文件

### 导入微信开发者工具
- [ ] 启动微信开发者工具
- [ ] 点击「导入项目」
- [ ] 选择目录：`/Users/liyulong/Desktop/caozei`
- [ ] 填写 AppID（可使用测试号）
- [ ] 项目类型选择「小游戏」
- [ ] 点击「导入」

### 配置客户端
- [ ] 检查 `config.min.js` 中的 API 地址：
  ```javascript
  ADJUDICATION_API: process.env.ADJUDICATION_API || "http://localhost:3000/intent/resolve"
  ```
- [ ] 如需远程服务端，修改为实际地址（或通过环境变量设置）

## 第三步：服务端部署
### 环境配置
- [ ] 确认已设置 DeepSeek API 密钥环境变量：
  ```bash
  export DEEPSEEK_API_KEY="your-key-here"
  ```
- [ ] 可选：设置 `ADJUDICATION_API` 环境变量（如需覆盖默认地址）

### 启动服务端
- [ ] 进入服务端目录（项目根目录）
- [ ] 安装依赖（如尚未安装）：
  ```bash
  npm install
  ```
- [ ] 启动服务：
  ```bash
  npm start
  ```
- [ ] 验证服务端运行：
  - 控制台输出 `Server running on port 3000`
  - 访问 `http://localhost:3000/health` 应返回 `{"status":"ok"}`

### 服务端健康检查
- [ ] API 端点可访问：`POST http://localhost:3000/intent/resolve`
- [ ] 数据库连接正常（`data/shared_state/state.db` 存在且可读写）

## 第四步：体验版构建与发布
### 预览生成
- [ ] 在微信开发者工具中点击「预览」
- [ ] 选择「体验版」构建
- [ ] 生成二维码
- [ ] 保存二维码图片备用

### 真机验证
- [ ] 使用微信扫描二维码
- [ ] 在真机上加载游戏
- [ ] 完成首次输入并收到响应
- [ ] 确认无白屏、无错误弹窗

## 第五步：反馈机制就绪
### 问卷模板准备
- [ ] 确认 `outputs/灰度测试/用户反馈问卷模板.md` 存在
- [ ] 可根据需要自定义问卷内容

### 邀请话术准备
- [ ] 确认 `outputs/灰度测试/用户邀请话术.md` 存在
- [ ] 准备分发渠道（微信群、私聊等）

### 日志收集设置
- [ ] 服务端监控日志：`data/monitor/monitor.log`
- [ ] 客户端错误日志：微信开发者工具控制台

## 第六步：部署验证脚本
### 运行验证脚本
- [ ] 执行部署验证脚本：
  ```bash
  node scripts/verify_deployment.js
  ```
- [ ] 脚本输出应显示所有检查项通过

### 手动验证点
- [ ] 客户端可正常输入意图
- [ ] 服务端返回结构化裁决结果
- [ ] 游戏状态正确更新
- [ ] 存档功能正常

## 故障排除
### 常见问题与解决
1. **解压失败**：重新下载代码包，确保网络稳定
2. **导入后无代码**：检查目标目录是否为空，确认解压路径正确
3. **服务端连接超时**：
   - 确认服务端进程已启动（端口3000）
   - 检查防火墙设置
   - 验证环境变量配置
4. **体验版扫码后白屏**：
   - 检查微信开发者工具控制台错误
   - 确认 API 地址配置正确
   - 验证网络连接

### 回滚方案
每次部署前建议备份：
```bash
cp -r "/Users/liyulong/Desktop/caozei" "/Users/liyulong/Desktop/caozei_backup_$(date +%Y%m%d)"
```

## 完成标志
- [ ] 所有检查项均已完成
- [ ] 体验版二维码可正常扫码体验
- [ ] 服务端正常运行，可处理裁决请求
- [ ] 反馈收集渠道就绪

## 后续步骤
1. 分发体验版二维码给测试用户
2. 收集用户反馈（问卷、访谈）
3. 分析监控日志，识别性能瓶颈
4. 准备下一轮迭代优化

---
*最后更新：2026-02-11*