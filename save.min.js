"use strict";var g=Object.defineProperty,L=Object.defineProperties,x=Object.getOwnPropertyDescriptor,_=Object.getOwnPropertyDescriptors,b=Object.getOwnPropertyNames,p=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var v=(o,e,t)=>e in o?g(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,s=(o,e)=>{for(var t in e||(e={}))T.call(e,t)&&v(o,t,e[t]);if(p)for(var t of p(e))P.call(e,t)&&v(o,t,e[t]);return o},I=(o,e)=>L(o,_(e));var z=(o,e)=>{for(var t in e)g(o,t,{get:e[t],enumerable:!0})},N=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of b(e))!T.call(o,n)&&n!==t&&g(o,n,{get:()=>e[n],enumerable:!(r=x(e,n))||r.enumerable});return o};var O=o=>N(g({},"__esModule",{value:!0}),o);var H={};z(H,{SAVE_VERSION:()=>S,STORAGE_KEY_PREFIX:()=>c,SaveManager:()=>m,SaveManagerConfig:()=>w,saveManager:()=>D});module.exports=O(H);var d={id:"player_001",attrs:{strength:75,intelligence:82,charm:68,luck:55},legend:30,tags:["civilian"],reputation:50,resources:{gold:100,food:200,soldiers:0},location:{region:"yingchuan",scene:"village"}},f={era:"184",flags:["taipingdao_spread=high"],time:{year:184,month:2,day:1},regionStatus:{jingzhou:"stable",yuzhou:"turmoil",jizhou:"stable"}},E=["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026","\u3010\u63D0\u793A\u3011\u5728\u4E0B\u65B9\u8F93\u5165\u6846\u8F93\u5165\u4F60\u7684\u610F\u56FE\uFF08\u5982\u300C\u524D\u5F80\u6D1B\u9633\u300D\u300C\u7ED3\u8BC6\u8C6A\u6770\u300D\uFF09\uFF0C\u70B9\u51FB\u53D1\u9001\u5373\u53EF\u63A8\u8FDB\u5267\u60C5\u3002"],h=[{id:"caocao",name:"\u66F9\u64CD",stance:"neutral",trust:30,location:"luoyang"},{id:"liubei",name:"\u5218\u5907",stance:"friendly",trust:50,location:"zhuoxian"}],l=(()=>{try{let e=(typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:{}).process;return e&&typeof e=="object"&&e!==null&&"env"in e?e.env||{}:{}}catch(o){return{}}})(),w={CLOUD_ENV:l.CLOUD_ENV||"cloud1-3gfb9ep2701c4857",ADJUDICATION_API:l.ADJUDICATION_API||"http://localhost:3000/intent/resolve",MAX_RETRIES:2,RETRY_DELAY:1e3,REQUEST_TIMEOUT:15e3,DEBUG:l.NODE_ENV!=="production",DEBUG_TOUCH:l.DEBUG_TOUCH==="true",AD_UNIT_ID:l.AD_UNIT_ID||"adunit-1234567890abcdef",DEFAULT_PLAYER_STATE:d,DEFAULT_WORLD_STATE:f,DEFAULT_NPC_STATE:h};var S="1.0.0";function G(){if(typeof wx!="undefined"&&typeof wx.setStorageSync=="function")return{setItem(e,t){wx.setStorageSync(e,t)},getItem(e){let t=wx.getStorageSync(e);return t===""?void 0:t},removeItem(e){wx.removeStorageSync(e)},getAllKeys(){return wx.getStorageInfoSync().keys},getSizeBytes(){return wx.getStorageInfoSync().currentSize*1024}};let o=new Map;return{setItem(e,t){o.set(e,t)},getItem(e){return o.get(e)},removeItem(e){o.delete(e)},getAllKeys(){return Array.from(o.keys())},getSizeBytes(){return Array.from(o.values()).reduce((e,t)=>e+t.length,0)}}}var c="sanguo_save_";function u(o){return JSON.parse(JSON.stringify(o))}function U(o){return typeof Blob!="undefined"?new Blob([o]).size:typeof TextEncoder!="undefined"?new TextEncoder().encode(o).length:o.length*2}function C(){let o=new Date().toISOString(),e=u(d),t=u(f),r=u(h);return{meta:{version:S,createdAt:o,lastSaved:o,playerId:e.id,saveName:"\u9ED8\u8BA4\u5B58\u6863",saveSlot:0},player:e,world:t,npcs:r,eventLog:[],dialogueHistory:[...E],progress:{totalTurns:0,lastEventId:"",lastEventTime:o}}}var m=class{constructor(){this.currentSlot=0;this.autoSaveEnabled=!0;this.autoSaveInterval=20;this.autoSaveTimer=null;this.storageLimits={maxSingleKeySize:1048576,maxTotalSize:10485760,maxDialogueHistory:100,maxEventLog:500,warningThreshold:.8};this.storage=G()}init(){return console.log("\u5B58\u6863\u7CFB\u7EDF\u521D\u59CB\u5316"),this.startAutoSave(),!0}generatePlayerId(){return`player_${Date.now()}_${Math.floor(Math.random()*1e4)}`}createNewSave(e=0,t="\u65B0\u5EFA\u5B58\u6863"){let r=u(C()),n=this.generatePlayerId(),a=new Date().toISOString();return r.meta=I(s({},r.meta),{playerId:n,createdAt:a,lastSaved:a,saveName:t,saveSlot:e}),r.player.id=n,this.currentSlot=e,r}optimizeSaveData(e){let t=u(e);return t.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(t.dialogueHistory=t.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory)),t.eventLog.length>this.storageLimits.maxEventLog&&(t.eventLog=t.eventLog.slice(-this.storageLimits.maxEventLog)),delete t.tempData,t}checkSaveSize(e){try{let t=JSON.stringify(e),r=U(t),n=r<=this.storageLimits.maxSingleKeySize;return{size:r,withinLimit:n,warning:r>this.storageLimits.maxSingleKeySize*this.storageLimits.warningThreshold?`\u5B58\u6863\u5927\u5C0F ${r} \u5B57\u8282\u63A5\u8FD1\u5355\u952E\u9650\u5236`:null}}catch(t){return console.error("\u68C0\u67E5\u5B58\u6863\u5927\u5C0F\u5931\u8D25:",t),{size:0,withinLimit:!1,warning:null}}}checkTotalStorage(){try{let e=this.storage.getSizeBytes(),t=e/this.storageLimits.maxTotalSize;return{totalSize:e,usagePercentage:t,withinLimit:e<=this.storageLimits.maxTotalSize,warning:t>this.storageLimits.warningThreshold?`\u5B58\u50A8\u4F7F\u7528\u7387 ${(t*100).toFixed(1)}% \u63A5\u8FD1\u4E0A\u9650`:null}}catch(e){return console.error("\u68C0\u67E5\u5B58\u50A8\u4F7F\u7528\u60C5\u51B5\u5931\u8D25:",e),null}}save(e,t=!1){if(!e)return console.error("\u5B58\u6863\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A"),!1;let r=new Date().toISOString();e.meta.lastSaved=r,t&&(e.meta.lastAutoSave=r);let n=this.optimizeSaveData(e),a=this.checkSaveSize(n);if(!a.withinLimit&&(console.error(`\u5B58\u6863\u5927\u5C0F ${a.size} \u5B57\u8282\u8D85\u8FC7\u9650\u5236\uFF0C\u5C1D\u8BD5\u88C1\u526A...`),n.dialogueHistory=n.dialogueHistory.slice(-50),n.eventLog=n.eventLog.slice(-100),!this.checkSaveSize(n).withinLimit))return console.error("\u88C1\u526A\u540E\u4ECD\u8D85\u8FC7\u9650\u5236\uFF0C\u4FDD\u5B58\u5931\u8D25"),!1;a.warning&&console.warn(a.warning);let i=this.checkTotalStorage();i!=null&&i.warning&&console.warn(i.warning);let A=`${c}${this.currentSlot}`;try{let y=JSON.stringify(n);return this.storage.setItem(A,y),console.log(`\u5B58\u6863\u4FDD\u5B58\u6210\u529F\uFF08${t?"\u81EA\u52A8":"\u624B\u52A8"}\uFF09\uFF0C\u69FD\u4F4D: ${this.currentSlot}`),!0}catch(y){return console.error("\u5B58\u6863\u4FDD\u5B58\u5931\u8D25:",y),!1}}readSlot(e){let t=`${c}${e}`;try{let r=this.storage.getItem(t);if(!r)return null;let n=JSON.parse(r);return n.meta.version!==S&&console.warn(`\u5B58\u6863\u7248\u672C\u4E0D\u5339\u914D: ${n.meta.version} -> ${S}`),n}catch(r){return console.error("\u5B58\u6863\u8BFB\u53D6\u5931\u8D25:",r),null}}load(e=null){let t=e!=null?e:this.currentSlot;try{let r=this.readSlot(t);return r?(this.currentSlot=t,r):(console.log(`\u5B58\u6863\u69FD\u4F4D ${t} \u4E0D\u5B58\u5728`),null)}catch(r){return console.error("\u5B58\u6863\u52A0\u8F7D\u5931\u8D25:",r),null}}deleteSave(e){let t=`${c}${e}`;try{return this.storage.removeItem(t),console.log(`\u5B58\u6863\u5220\u9664\u6210\u529F\uFF0C\u69FD\u4F4D: ${e}`),!0}catch(r){return console.error("\u5B58\u6863\u5220\u9664\u5931\u8D25:",r),!1}}getSaveList(){let e=[];for(let t=0;t<10;t+=1){let r=this.readSlot(t);r&&e.push({slot:t,name:r.meta.saveName,playerId:r.meta.playerId,lastSaved:r.meta.lastSaved,era:r.world.era,location:r.player.location.region})}return e}logEvent(e,t,r){if(!e||!t)return console.error("logEvent \u53C2\u6570\u9519\u8BEF"),!1;let n=r||e.player.id;if(e.eventLog.some(i=>i.eventId===t&&i.playerId===n))return!0;let a=new Date().toISOString();return e.eventLog.push({eventId:t,playerId:n,triggeredAt:a,recordedAt:a}),e.progress.lastEventId=t,e.progress.lastEventTime=a,e.progress.totalTurns+=1,!0}isEventTriggered(e,t){return!e||!t?!1:e.eventLog.some(r=>r.eventId===t&&r.playerId===e.player.id)}updatePlayerAttributes(e,t){if(!e||!t)return e;if(t.attrs&&Object.entries(t.attrs).forEach(([r,n])=>{if(typeof n=="number"&&r in e.player.attrs){let a=e.player.attrs[r]+n;e.player.attrs[r]=Math.max(0,Math.min(100,a))}}),typeof t.legend=="number"&&(e.player.legend=Math.max(0,e.player.legend+t.legend)),typeof t.reputation=="number"){let r=e.player.reputation+t.reputation;e.player.reputation=Math.max(0,Math.min(100,r))}return t.resources&&Object.entries(t.resources).forEach(([r,n])=>{if(typeof n=="number"&&r in e.player.resources){let a=e.player.resources[r]+n;e.player.resources[r]=Math.max(0,a)}}),e}updateWorldState(e,t){return!e||!t||(t.era&&(e.world.era=t.era),t.flags&&t.flags.forEach(r=>{e.world.flags.includes(r)||e.world.flags.push(r)}),t.time&&(e.world.time=s(s({},e.world.time),t.time)),t.regions&&(e.world.regions=e.world.regions||{},Object.entries(t.regions).forEach(([r,n])=>{e.world.regions[r]=s(s({},e.world.regions[r]||{}),n)}))),e}addDialogueHistory(e,t){return!e||!t||(Array.isArray(t)?e.dialogueHistory.push(...t):e.dialogueHistory.push(t),e.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(e.dialogueHistory=e.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory))),e}startAutoSave(){!this.autoSaveEnabled||this.autoSaveTimer||(this.autoSaveTimer=setInterval(()=>{let e=this.load(this.currentSlot);e&&this.save(e,!0)},this.autoSaveInterval*1e3),console.log(`\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.autoSaveInterval} \u79D2`))}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u505C\u6B62"))}setAutoSaveInterval(e){this.autoSaveInterval=Math.max(10,e),this.autoSaveTimer&&(this.stopAutoSave(),this.startAutoSave())}exportSave(e=null){let t=this.load(e!=null?e:this.currentSlot);return t?JSON.stringify(t,null,2):null}importSave(e,t){try{let r=JSON.parse(e);if(!r.meta||!r.player)throw new Error("\u5B58\u6863\u683C\u5F0F\u65E0\u6548");return typeof t=="number"&&(this.currentSlot=t),this.save(r,!1)}catch(r){return console.error("\u5BFC\u5165\u5B58\u6863\u5931\u8D25:",r),!1}}getStorageInfo(){let e=this.storage.getSizeBytes(),t=this.storageLimits.maxTotalSize;return{total:t,used:e,available:Math.max(0,t-e),usagePercentage:e/t,keys:this.storage.getAllKeys()}}},D=new m;
