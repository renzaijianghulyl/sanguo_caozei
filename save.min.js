"use strict";var u=Object.defineProperty,x=Object.defineProperties,E=Object.getOwnPropertyDescriptor,A=Object.getOwnPropertyDescriptors,b=Object.getOwnPropertyNames,p=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var v=(i,e,t)=>e in i?u(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,s=(i,e)=>{for(var t in e||(e={}))T.call(e,t)&&v(i,t,e[t]);if(p)for(var t of p(e))P.call(e,t)&&v(i,t,e[t]);return i},w=(i,e)=>x(i,A(e));var _=(i,e)=>{for(var t in e)u(i,t,{get:e[t],enumerable:!0})},z=(i,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of b(e))!T.call(i,o)&&o!==t&&u(i,o,{get:()=>e[o],enumerable:!(r=E(e,o))||r.enumerable});return i};var k=i=>z(u({},"__esModule",{value:!0}),i);var N={};_(N,{SAVE_VERSION:()=>c,STORAGE_KEY_PREFIX:()=>g,SaveManager:()=>S,SaveManagerConfig:()=>L,saveManager:()=>M});module.exports=k(N);var h={id:"player_001",attrs:{strength:75,intelligence:82,charm:68,luck:55},legend:30,tags:["civilian"],reputation:50,resources:{gold:100,food:200,soldiers:0},location:{region:"yingchuan",scene:"village"}},y={era:"184",flags:["taipingdao_spread=high"],time:{year:184,month:2,day:1},regionStatus:{jingzhou:"stable",yuzhou:"turmoil",jizhou:"stable"}},d=[{id:"caocao",name:"\u66F9\u64CD",stance:"neutral",trust:30,location:"luoyang"},{id:"liubei",name:"\u5218\u5907",stance:"friendly",trust:50,location:"zhuoxian"}],L={ADJUDICATION_API:"http://localhost:3000/intent/resolve",MAX_RETRIES:2,RETRY_DELAY:1e3,REQUEST_TIMEOUT:15e3,DEBUG:!1,DEFAULT_PLAYER_STATE:h,DEFAULT_WORLD_STATE:y,DEFAULT_NPC_STATE:d};var c="1.0.0",g="sanguo_save_";function l(i){return JSON.parse(JSON.stringify(i))}function O(){let i=new Date().toISOString(),e=l(h),t=l(y),r=l(d);return{meta:{version:c,createdAt:i,lastSaved:i,playerId:e.id,saveName:"\u9ED8\u8BA4\u5B58\u6863",saveSlot:0},player:e,world:t,npcs:r,eventLog:[],dialogueHistory:["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026"],progress:{totalTurns:0,lastEventId:"",lastEventTime:i}}}var f=class{constructor(){this.mockStorage={};this.useMock=typeof wx=="undefined"||typeof wx.setStorageSync!="function",this.useMock&&console.warn("\u5FAE\u4FE1\u5C0F\u6E38\u620F\u5B58\u50A8 API \u4E0D\u53EF\u7528\uFF0C\u4F7F\u7528\u5185\u5B58\u6A21\u62DF\u3002")}setItem(e,t){if(this.useMock){this.mockStorage[e]=t;return}wx.setStorageSync(e,t)}getItem(e){if(this.useMock)return this.mockStorage[e];let t=wx.getStorageSync(e);return t===""?void 0:t}removeItem(e){if(this.useMock){delete this.mockStorage[e];return}wx.removeStorageSync(e)}getAllKeys(){return this.useMock?Object.keys(this.mockStorage):wx.getStorageInfoSync().keys}getStorageSizeBytes(){return this.useMock?Object.values(this.mockStorage).reduce((t,r)=>t+r.length,0):wx.getStorageInfoSync().currentSize*1024}isMock(){return this.useMock}},S=class{constructor(){this.currentSlot=0;this.autoSaveEnabled=!0;this.autoSaveInterval=30;this.autoSaveTimer=null;this.storageLimits={maxSingleKeySize:1048576,maxTotalSize:10485760,maxDialogueHistory:100,maxEventLog:500,warningThreshold:.8};this.storage=new f}init(){return console.log("\u5B58\u6863\u7CFB\u7EDF\u521D\u59CB\u5316"),this.startAutoSave(),!0}generatePlayerId(){return`player_${Date.now()}_${Math.floor(Math.random()*1e4)}`}createNewSave(e=0,t="\u65B0\u5EFA\u5B58\u6863"){let r=l(O()),o=this.generatePlayerId(),a=new Date().toISOString();return r.meta=w(s({},r.meta),{playerId:o,createdAt:a,lastSaved:a,saveName:t,saveSlot:e}),r.player.id=o,this.currentSlot=e,r}optimizeSaveData(e){let t=l(e);return t.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(t.dialogueHistory=t.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory)),t.eventLog.length>this.storageLimits.maxEventLog&&(t.eventLog=t.eventLog.slice(-this.storageLimits.maxEventLog)),delete t.tempData,t}checkSaveSize(e){try{let t=JSON.stringify(e),r=new Blob([t]).size,o=r<=this.storageLimits.maxSingleKeySize;return{size:r,withinLimit:o,warning:r>this.storageLimits.maxSingleKeySize*this.storageLimits.warningThreshold?`\u5B58\u6863\u5927\u5C0F ${r} \u5B57\u8282\u63A5\u8FD1\u5355\u952E\u9650\u5236`:null}}catch(t){return console.error("\u68C0\u67E5\u5B58\u6863\u5927\u5C0F\u5931\u8D25:",t),{size:0,withinLimit:!1,warning:null}}}checkTotalStorage(){try{let e=this.storage.getStorageSizeBytes(),t=e/this.storageLimits.maxTotalSize;return{totalSize:e,usagePercentage:t,withinLimit:e<=this.storageLimits.maxTotalSize,warning:t>this.storageLimits.warningThreshold?`\u5B58\u50A8\u4F7F\u7528\u7387 ${(t*100).toFixed(1)}% \u63A5\u8FD1\u4E0A\u9650`:null}}catch(e){return console.error("\u68C0\u67E5\u5B58\u50A8\u4F7F\u7528\u60C5\u51B5\u5931\u8D25:",e),null}}save(e,t=!1){if(!e)return console.error("\u5B58\u6863\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A"),!1;let r=new Date().toISOString();e.meta.lastSaved=r,t&&(e.meta.lastAutoSave=r);let o=this.optimizeSaveData(e),a=this.checkSaveSize(o);if(!a.withinLimit&&(console.error(`\u5B58\u6863\u5927\u5C0F ${a.size} \u5B57\u8282\u8D85\u8FC7\u9650\u5236\uFF0C\u5C1D\u8BD5\u88C1\u526A...`),o.dialogueHistory=o.dialogueHistory.slice(-50),o.eventLog=o.eventLog.slice(-100),!this.checkSaveSize(o).withinLimit))return console.error("\u88C1\u526A\u540E\u4ECD\u8D85\u8FC7\u9650\u5236\uFF0C\u4FDD\u5B58\u5931\u8D25"),!1;a.warning&&console.warn(a.warning);let n=this.checkTotalStorage();n!=null&&n.warning&&console.warn(n.warning);let I=`${g}${this.currentSlot}`;try{let m=JSON.stringify(o);return this.storage.setItem(I,m),console.log(`\u5B58\u6863\u4FDD\u5B58\u6210\u529F\uFF08${t?"\u81EA\u52A8":"\u624B\u52A8"}\uFF09\uFF0C\u69FD\u4F4D: ${this.currentSlot}`),!0}catch(m){return console.error("\u5B58\u6863\u4FDD\u5B58\u5931\u8D25:",m),!1}}readSlot(e){let t=`${g}${e}`;try{let r=this.storage.getItem(t);if(!r)return null;let o=JSON.parse(r);return o.meta.version!==c&&console.warn(`\u5B58\u6863\u7248\u672C\u4E0D\u5339\u914D: ${o.meta.version} -> ${c}`),o}catch(r){return console.error("\u5B58\u6863\u8BFB\u53D6\u5931\u8D25:",r),null}}load(e=null){let t=e!=null?e:this.currentSlot;try{let r=this.readSlot(t);return r?(this.currentSlot=t,r):(console.log(`\u5B58\u6863\u69FD\u4F4D ${t} \u4E0D\u5B58\u5728`),null)}catch(r){return console.error("\u5B58\u6863\u52A0\u8F7D\u5931\u8D25:",r),null}}deleteSave(e){let t=`${g}${e}`;try{return this.storage.removeItem(t),console.log(`\u5B58\u6863\u5220\u9664\u6210\u529F\uFF0C\u69FD\u4F4D: ${e}`),!0}catch(r){return console.error("\u5B58\u6863\u5220\u9664\u5931\u8D25:",r),!1}}getSaveList(){let e=[];for(let t=0;t<10;t+=1){let r=this.readSlot(t);r&&e.push({slot:t,name:r.meta.saveName,playerId:r.meta.playerId,lastSaved:r.meta.lastSaved,era:r.world.era,location:r.player.location.region})}return e}logEvent(e,t,r){if(!e||!t)return console.error("logEvent \u53C2\u6570\u9519\u8BEF"),!1;let o=r||e.player.id;if(e.eventLog.some(n=>n.eventId===t&&n.playerId===o))return!0;let a=new Date().toISOString();return e.eventLog.push({eventId:t,playerId:o,triggeredAt:a,recordedAt:a}),e.progress.lastEventId=t,e.progress.lastEventTime=a,e.progress.totalTurns+=1,!0}isEventTriggered(e,t){return!e||!t?!1:e.eventLog.some(r=>r.eventId===t&&r.playerId===e.player.id)}updatePlayerAttributes(e,t){if(!e||!t)return e;if(t.attrs&&Object.entries(t.attrs).forEach(([r,o])=>{if(typeof o=="number"&&r in e.player.attrs){let a=e.player.attrs[r]+o;e.player.attrs[r]=Math.max(0,Math.min(100,a))}}),typeof t.legend=="number"&&(e.player.legend=Math.max(0,e.player.legend+t.legend)),typeof t.reputation=="number"){let r=e.player.reputation+t.reputation;e.player.reputation=Math.max(0,Math.min(100,r))}return t.resources&&Object.entries(t.resources).forEach(([r,o])=>{if(typeof o=="number"&&r in e.player.resources){let a=e.player.resources[r]+o;e.player.resources[r]=Math.max(0,a)}}),e}updateWorldState(e,t){return!e||!t||(t.era&&(e.world.era=t.era),t.flags&&t.flags.forEach(r=>{e.world.flags.includes(r)||e.world.flags.push(r)}),t.time&&(e.world.time=s(s({},e.world.time),t.time)),t.regions&&(e.world.regions=e.world.regions||{},Object.entries(t.regions).forEach(([r,o])=>{e.world.regions[r]=s(s({},e.world.regions[r]||{}),o)}))),e}addDialogueHistory(e,t){return!e||!t||(Array.isArray(t)?e.dialogueHistory.push(...t):e.dialogueHistory.push(t),e.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(e.dialogueHistory=e.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory))),e}startAutoSave(){!this.autoSaveEnabled||this.autoSaveTimer||(this.autoSaveTimer=setInterval(()=>{let e=this.load(this.currentSlot);e&&this.save(e,!0)},this.autoSaveInterval*1e3),console.log(`\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.autoSaveInterval} \u79D2`))}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u505C\u6B62"))}setAutoSaveInterval(e){this.autoSaveInterval=Math.max(10,e),this.autoSaveTimer&&(this.stopAutoSave(),this.startAutoSave())}exportSave(e=null){let t=this.load(e!=null?e:this.currentSlot);return t?JSON.stringify(t,null,2):null}importSave(e,t){try{let r=JSON.parse(e);if(!r.meta||!r.player)throw new Error("\u5B58\u6863\u683C\u5F0F\u65E0\u6548");return typeof t=="number"&&(this.currentSlot=t),this.save(r,!1)}catch(r){return console.error("\u5BFC\u5165\u5B58\u6863\u5931\u8D25:",r),!1}}getStorageInfo(){if(this.storage.isMock())return{total:this.storageLimits.maxTotalSize,used:0,available:this.storageLimits.maxTotalSize,usagePercentage:0};try{let e=wx.getStorageInfoSync();return{total:this.storageLimits.maxTotalSize,used:e.currentSize*1024,available:this.storageLimits.maxTotalSize-e.currentSize*1024,usagePercentage:e.currentSize/10240,keys:e.keys}}catch(e){return console.error("\u83B7\u53D6\u5B58\u50A8\u4FE1\u606F\u5931\u8D25:",e),null}}},M=new S;
