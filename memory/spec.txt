# 三国文字沙箱微信小游戏 - 工作计划

## 1. 核心目标
### 目标概述
上线可玩MVP，验证“AI+互动叙事”可行性，聚焦黄巾之乱前后的叙事自由度。玩家可自由设定开局，通过自然语言输入意图，系统基于LLM动态裁决并推进“改史/顺史”的长期状态演进。

### 背景与动机
- 灵感来源：网络穿越小说《曹贼》、三国志13单人剧情、三国志14事件
- 核心卖点：叙事驱动、传奇自由度、可改史或顺史
- 用户画像：三国题材爱好者、互动小说/剧情向游戏用户、轻量策略强代入玩家

## 2. 要求与标准
- **产出要求**：
  - 微信小游戏MVP：首包≤4MB，包含完整核心循环（场景呈现→玩家输入→LLM裁决→状态更新→叙事反馈）
  - 交付时间：紧凑5周迭代，每完成一个版本立即基于测试反馈启动下一迭代
  - 验收标准：每次输入都有有效反馈；20-30分钟连续可玩；LLM失败率可控，体验不中断
- **风格偏好**：
  - 叙事风格：古风旁白 + 少量对话，禁止现代网络用语
  - 文本长度：场景描述≤150字，结果反馈≤80字，叙事≤120字
- **文件目录规则**：
  - 最终交付物：`outputs/`
  - 代码脚本：`src/`
  - 数据文件：`data/`
  - 文档资料：`docs/`
  - 临时文件：`temp/`
- **技术约束**：
  - 平台：微信小游戏（首包≤4MB，资源分包与动态加载）
  - LLM集成：DeepSeek API（秘钥已提供，需配置环境变量）
  - 合规过滤：服务端敏感词与违规意图拦截，叙事风格控制
  - 资源压缩：图片≤200KB、音频≤500KB（MVP阶段暂不考虑音频和图片）
- **数据依赖**：
  - 事件模板：遵循 `EVENT_SPEC.md` 规范
  - 裁决协议：遵循 `ADJUDICATION_SPEC.md` 规范
  - 架构分层：客户端（微信小游戏）、服务端（裁决编排）、LLM集成（DeepSeek）
- **同步要求**：
  - Git仓库：https://github.com/renzaijianghulyl/demo.git（账号：renzaijianghulyl，密码：wojiushiwoLee4）
  - 本地目录：`/Users/liyulong/Desktop/caozei`
  - 每完成一次迭代自动提交代码并同步到本地环境

## 3. 执行路线图
### 第一阶段：初始化与环境搭建
- [x] 初始化项目结构与git仓库配置
- [x] 配置DeepSeek API环境变量与基础配置文件
- [ ] 建立自动同步管道（git提交 + 本地文件夹同步）

### 第二阶段：垂直切片（单场景完整闭环）
- [x] 开发基础客户端界面（对话区、输入区、属性面板）
- [x] 实现服务端裁决API端点（`POST /intent/resolve`）
- [x] 集成DeepSeek LLM，实现结构化JSON输出
- [x] 完成本地存档读写机制
- [x] 在微信开发者工具中验证运行闭环

### 第三阶段：核心系统扩展
- [ ] 完善事件模板引擎（支持主线/支线/随机事件）
- [ ] 扩展NPC关系与势力系统
- [ ] 增强合规过滤与安全拦截
- [ ] 实现事件去重与冷却机制

### 第四阶段：内容成型与稳定
- [ ] 批量生成15-25个事件模板（符合EVENT_SPEC）
- [ ] 配置6-10个核心NPC
- [ ] 优化性能与包体大小（确保≤4MB）
- [ ] 建立监控埋点（错误率、裁决分级分布）

### 第五阶段：上线准备
- [ ] 灰度测试与反馈收集
- [ ] 最终合规审核
- [ ] 包体优化与资源压缩
- [ ] 文档整理与交付

## 4. 共享状态设计
### 状态库路径
`data/shared_state/state.db`

### 表结构（DDL）
```sql
CREATE TABLE IF NOT EXISTS event_log (
  event_id TEXT PRIMARY KEY,
  player_id TEXT NOT NULL,
  triggered_at TEXT NOT NULL,
  created_at TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS player_progress (
  player_id TEXT PRIMARY KEY,
  last_save_time TEXT NOT NULL,
  world_state_hash TEXT NOT NULL,
  created_at TEXT NOT NULL
);
```

### 去重口径
- 事件去重：基于 `event_id` + `player_id` 唯一约束
- 存档去重：基于 `player_id` 唯一约束

### 幂等写入语义
使用 `INSERT OR IGNORE` 保证重复执行不产生重复记录。

## 5. 风险与对策
- **LLM不稳定**：重试（最多2次）+ JSON修复 + 规则兜底（非模板化短叙事）
- **内容合规**：服务端过滤 + 安全回退 + 叙事风格控制
- **体验不连贯**：事件模板与叙事一致性检查 + 失败也推进（给信息或关系变化）
- **包体超限**：资源分包、动态加载、极致压缩（图片≤200KB、音频≤500KB）
- **服务器启动超时**：测试环境中需确保端口可用、进程监控健壮，增加启动超时与健康检查重试机制