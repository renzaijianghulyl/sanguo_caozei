"use strict";var b=Object.defineProperty,ue=Object.defineProperties,ce=Object.getOwnPropertyDescriptor,de=Object.getOwnPropertyDescriptors,fe=Object.getOwnPropertyNames,W=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var z=(t,e,r)=>e in t?b(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,p=(t,e)=>{for(var r in e||(e={}))N.call(e,r)&&z(t,r,e[r]);if(W)for(var r of W(e))ge.call(e,r)&&z(t,r,e[r]);return t},M=(t,e)=>ue(t,de(e));var ye=(t,e)=>{for(var r in e)b(t,r,{get:e[r],enumerable:!0})},pe=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of fe(e))!N.call(t,a)&&a!==r&&b(t,a,{get:()=>e[a],enumerable:!(n=ce(e,a))||n.enumerable});return t};var Se=t=>pe(b({},"__esModule",{value:!0}),t);var Fe={};ye(Fe,{gameLoop:()=>Ie,getState:()=>Le,handleTouch:()=>ie,initGame:()=>Te,loadLatestSave:()=>le,manualSave:()=>se,render:()=>f,setCurrentInput:()=>Ce,showKeyboard:()=>oe,submitInput:()=>O,toggleSaveLoadPanel:()=>k});module.exports=Se(Fe);var c={id:"player_001",attrs:{strength:75,intelligence:82,charm:68,luck:55},legend:30,tags:["civilian"],reputation:50,resources:{gold:100,food:200,soldiers:0},location:{region:"yingchuan",scene:"village"}},v={era:"184",flags:["taipingdao_spread=high"],time:{year:184,month:2,day:1},regionStatus:{jingzhou:"stable",yuzhou:"turmoil",jizhou:"stable"}},S=[{id:"caocao",name:"\u66F9\u64CD",stance:"neutral",trust:30,location:"luoyang"},{id:"liubei",name:"\u5218\u5907",stance:"friendly",trust:50,location:"zhuoxian"}],m={ADJUDICATION_API:"http://localhost:3000/intent/resolve",MAX_RETRIES:2,RETRY_DELAY:1e3,REQUEST_TIMEOUT:15e3,DEBUG:!1,DEFAULT_PLAYER_STATE:c,DEFAULT_WORLD_STATE:v,DEFAULT_NPC_STATE:S};function G(){return{value:"",isKeyboardVisible:!1}}function I(t,e){return t.value=e,t}function $(t){return t.value="",t}function A(t,e){return t.isKeyboardVisible=e,t}function j(t,e){let r={x:0,y:0,width:t,height:80},n=Math.max(100,Math.round(e*.2)),a=60,o={x:0,y:e-n,width:t,height:n},s={x:0,y:o.y-a,width:t,height:a},l={x:0,y:r.height,width:t,height:s.y-r.height};return{attributePanel:r,dialogueArea:l,inputArea:o,saveLoadPanel:s}}function V(t){let{ctx:e,screenWidth:r,screenHeight:n}=t;e.clearRect(0,0,r,n),me(t),he(t),ve(t),t.isSaveLoadPanelVisible&&we(t)}function me({ctx:t,layout:e,playerAttributes:r,currentSaveData:n}){let a=e.attributePanel;t.fillStyle="#2C3E50",t.fillRect(a.x,a.y,a.width,a.height),t.fillStyle="#FFFFFF",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("\u73A9\u5BB6\u5C5E\u6027",a.width/2,a.y+25),t.font="14px sans-serif",t.textAlign="left";let o=[`\u6B66\u529B: ${r.strength}`,`\u667A\u529B: ${r.intelligence}`,`\u9B45\u529B: ${r.charm}`,`\u8FD0\u6C14: ${r.luck}`,`\u4F20\u5947\u5EA6: ${r.legend}`],s=a.y+50;o.forEach((u,g)=>{t.fillStyle="#ECF0F1",t.fillText(u,20,s+g*20)});let l=n?"\u5DF2\u5B58\u6863":"\u65B0\u6E38\u620F";t.fillStyle=n?"#27AE60":"#E74C3C",t.font="12px sans-serif",t.textAlign="right",t.fillText(`\u72B6\u6001: ${l}`,a.width-20,a.y+25),t.fillStyle="#3498DB",t.fillRect(a.width-50,a.y+10,40,20),t.fillStyle="#FFFFFF",t.font="12px sans-serif",t.textAlign="center",t.fillText("\u5B58\u6863",a.width-30,a.y+25)}function he({ctx:t,layout:e,dialogueHistory:r}){let n=e.dialogueArea;t.fillStyle="#34495E",t.fillRect(n.x,n.y,n.width,n.height),t.fillStyle="#FFFFFF",t.font="16px sans-serif",t.textAlign="left";let a=20,o=n.y+a,s=n.width-a*2;r.forEach(l=>{if(o=be(t,l,a,o,s),o+=12,o>n.y+n.height-a){t.fillStyle="#E74C3C",t.fillText("\uFF08\u66F4\u591A\u5185\u5BB9...\uFF09",a,n.y+n.height-a);return}})}function ve({ctx:t,layout:e,currentInput:r,currentSaveData:n,keyboardActive:a}){let o=e.inputArea;t.fillStyle="#2C3E50",t.fillRect(o.x,o.y,o.width,o.height);let s=o.y+20;t.fillStyle="#ECF0F1",t.fillRect(20,s,o.width-100,40),t.fillStyle="#2C3E50",t.font="16px sans-serif",t.textAlign="left";let l=a?"\u8F93\u5165\u4E2D...":"\u70B9\u51FB\u6B64\u5904\u8F93\u5165\u4F60\u7684\u610F\u56FE...";t.fillText(r||l,25,s+25),t.fillStyle="#27AE60",t.fillRect(o.width-70,s,60,40),t.fillStyle="#FFFFFF",t.font="bold 14px sans-serif",t.textAlign="center",t.fillText("\u53D1\u9001",o.width-40,s+25),n&&(t.fillStyle="#27AE60",t.font="10px sans-serif",t.textAlign="left",t.fillText("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u7528",20,o.y+10))}function we({ctx:t,layout:e,currentSaveData:r}){let n=e.saveLoadPanel;if(t.fillStyle="rgba(44, 62, 80, 0.95)",t.fillRect(n.x,n.y,n.width,n.height),t.strokeStyle="#3498DB",t.lineWidth=2,t.strokeRect(n.x,n.y,n.width,n.height),t.fillStyle="#FFFFFF",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("\u5B58\u6863\u7BA1\u7406",n.width/2,n.y+25),t.fillStyle="#27AE60",t.fillRect(.1*n.width,n.y+35,.35*n.width,20),t.fillStyle="#FFFFFF",t.font="14px sans-serif",t.textAlign="center",t.fillText("\u4FDD\u5B58\u6E38\u620F",.275*n.width,n.y+50),t.fillStyle="#3498DB",t.fillRect(.55*n.width,n.y+35,.35*n.width,20),t.fillStyle="#FFFFFF",t.fillText("\u5173\u95ED\u9762\u677F",.725*n.width,n.y+50),r){let a=r.meta;t.fillStyle="#ECF0F1",t.font="12px sans-serif",t.textAlign="left",[`\u5B58\u6863: ${a.saveName}`,`\u73A9\u5BB6: ${a.playerId.substring(0,8)}...`,`\u65F6\u95F4: ${new Date(a.lastSaved).toLocaleString()}`].forEach((s,l)=>{t.fillText(s,20,n.y+80+15*l)})}else t.fillStyle="#E74C3C",t.font="12px sans-serif",t.textAlign="left",t.fillText("\u65E0\u5B58\u6863\u6570\u636E\uFF0C\u8BF7\u5148\u4FDD\u5B58\u6E38\u620F",20,n.y+80)}function be(t,e,r,n,a){let o=Array.from(e),s="",l=n;return o.forEach(u=>{let g=s+u;t.measureText(g).width>a&&s.length>0?(t.fillText(s,r,l),s=u,l+=24):s=g}),s&&(t.fillText(s,r,l),l+=24),l}var L="1.0.0",C="sanguo_save_";function w(t){return JSON.parse(JSON.stringify(t))}function Ae(){let t=new Date().toISOString(),e=w(c),r=w(v),n=w(S);return{meta:{version:L,createdAt:t,lastSaved:t,playerId:e.id,saveName:"\u9ED8\u8BA4\u5B58\u6863",saveSlot:0},player:e,world:r,npcs:n,eventLog:[],dialogueHistory:["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026"],progress:{totalTurns:0,lastEventId:"",lastEventTime:t}}}var P=class{constructor(){this.mockStorage={};this.useMock=typeof wx=="undefined"||typeof wx.setStorageSync!="function",this.useMock&&console.warn("\u5FAE\u4FE1\u5C0F\u6E38\u620F\u5B58\u50A8 API \u4E0D\u53EF\u7528\uFF0C\u4F7F\u7528\u5185\u5B58\u6A21\u62DF\u3002")}setItem(e,r){if(this.useMock){this.mockStorage[e]=r;return}wx.setStorageSync(e,r)}getItem(e){if(this.useMock)return this.mockStorage[e];let r=wx.getStorageSync(e);return r===""?void 0:r}removeItem(e){if(this.useMock){delete this.mockStorage[e];return}wx.removeStorageSync(e)}getAllKeys(){return this.useMock?Object.keys(this.mockStorage):wx.getStorageInfoSync().keys}getStorageSizeBytes(){return this.useMock?Object.values(this.mockStorage).reduce((r,n)=>r+n.length,0):wx.getStorageInfoSync().currentSize*1024}isMock(){return this.useMock}},E=class{constructor(){this.currentSlot=0;this.autoSaveEnabled=!0;this.autoSaveInterval=30;this.autoSaveTimer=null;this.storageLimits={maxSingleKeySize:1048576,maxTotalSize:10485760,maxDialogueHistory:100,maxEventLog:500,warningThreshold:.8};this.storage=new P}init(){return console.log("\u5B58\u6863\u7CFB\u7EDF\u521D\u59CB\u5316"),this.startAutoSave(),!0}generatePlayerId(){return`player_${Date.now()}_${Math.floor(Math.random()*1e4)}`}createNewSave(e=0,r="\u65B0\u5EFA\u5B58\u6863"){let n=w(Ae()),a=this.generatePlayerId(),o=new Date().toISOString();return n.meta=M(p({},n.meta),{playerId:a,createdAt:o,lastSaved:o,saveName:r,saveSlot:e}),n.player.id=a,this.currentSlot=e,n}optimizeSaveData(e){let r=w(e);return r.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(r.dialogueHistory=r.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory)),r.eventLog.length>this.storageLimits.maxEventLog&&(r.eventLog=r.eventLog.slice(-this.storageLimits.maxEventLog)),delete r.tempData,r}checkSaveSize(e){try{let r=JSON.stringify(e),n=new Blob([r]).size,a=n<=this.storageLimits.maxSingleKeySize;return{size:n,withinLimit:a,warning:n>this.storageLimits.maxSingleKeySize*this.storageLimits.warningThreshold?`\u5B58\u6863\u5927\u5C0F ${n} \u5B57\u8282\u63A5\u8FD1\u5355\u952E\u9650\u5236`:null}}catch(r){return console.error("\u68C0\u67E5\u5B58\u6863\u5927\u5C0F\u5931\u8D25:",r),{size:0,withinLimit:!1,warning:null}}}checkTotalStorage(){try{let e=this.storage.getStorageSizeBytes(),r=e/this.storageLimits.maxTotalSize;return{totalSize:e,usagePercentage:r,withinLimit:e<=this.storageLimits.maxTotalSize,warning:r>this.storageLimits.warningThreshold?`\u5B58\u50A8\u4F7F\u7528\u7387 ${(r*100).toFixed(1)}% \u63A5\u8FD1\u4E0A\u9650`:null}}catch(e){return console.error("\u68C0\u67E5\u5B58\u50A8\u4F7F\u7528\u60C5\u51B5\u5931\u8D25:",e),null}}save(e,r=!1){if(!e)return console.error("\u5B58\u6863\u6570\u636E\u4E0D\u80FD\u4E3A\u7A7A"),!1;let n=new Date().toISOString();e.meta.lastSaved=n,r&&(e.meta.lastAutoSave=n);let a=this.optimizeSaveData(e),o=this.checkSaveSize(a);if(!o.withinLimit&&(console.error(`\u5B58\u6863\u5927\u5C0F ${o.size} \u5B57\u8282\u8D85\u8FC7\u9650\u5236\uFF0C\u5C1D\u8BD5\u88C1\u526A...`),a.dialogueHistory=a.dialogueHistory.slice(-50),a.eventLog=a.eventLog.slice(-100),!this.checkSaveSize(a).withinLimit))return console.error("\u88C1\u526A\u540E\u4ECD\u8D85\u8FC7\u9650\u5236\uFF0C\u4FDD\u5B58\u5931\u8D25"),!1;o.warning&&console.warn(o.warning);let s=this.checkTotalStorage();s!=null&&s.warning&&console.warn(s.warning);let l=`${C}${this.currentSlot}`;try{let u=JSON.stringify(a);return this.storage.setItem(l,u),console.log(`\u5B58\u6863\u4FDD\u5B58\u6210\u529F\uFF08${r?"\u81EA\u52A8":"\u624B\u52A8"}\uFF09\uFF0C\u69FD\u4F4D: ${this.currentSlot}`),!0}catch(u){return console.error("\u5B58\u6863\u4FDD\u5B58\u5931\u8D25:",u),!1}}readSlot(e){let r=`${C}${e}`;try{let n=this.storage.getItem(r);if(!n)return null;let a=JSON.parse(n);return a.meta.version!==L&&console.warn(`\u5B58\u6863\u7248\u672C\u4E0D\u5339\u914D: ${a.meta.version} -> ${L}`),a}catch(n){return console.error("\u5B58\u6863\u8BFB\u53D6\u5931\u8D25:",n),null}}load(e=null){let r=e!=null?e:this.currentSlot;try{let n=this.readSlot(r);return n?(this.currentSlot=r,n):(console.log(`\u5B58\u6863\u69FD\u4F4D ${r} \u4E0D\u5B58\u5728`),null)}catch(n){return console.error("\u5B58\u6863\u52A0\u8F7D\u5931\u8D25:",n),null}}deleteSave(e){let r=`${C}${e}`;try{return this.storage.removeItem(r),console.log(`\u5B58\u6863\u5220\u9664\u6210\u529F\uFF0C\u69FD\u4F4D: ${e}`),!0}catch(n){return console.error("\u5B58\u6863\u5220\u9664\u5931\u8D25:",n),!1}}getSaveList(){let e=[];for(let r=0;r<10;r+=1){let n=this.readSlot(r);n&&e.push({slot:r,name:n.meta.saveName,playerId:n.meta.playerId,lastSaved:n.meta.lastSaved,era:n.world.era,location:n.player.location.region})}return e}logEvent(e,r,n){if(!e||!r)return console.error("logEvent \u53C2\u6570\u9519\u8BEF"),!1;let a=n||e.player.id;if(e.eventLog.some(s=>s.eventId===r&&s.playerId===a))return!0;let o=new Date().toISOString();return e.eventLog.push({eventId:r,playerId:a,triggeredAt:o,recordedAt:o}),e.progress.lastEventId=r,e.progress.lastEventTime=o,e.progress.totalTurns+=1,!0}isEventTriggered(e,r){return!e||!r?!1:e.eventLog.some(n=>n.eventId===r&&n.playerId===e.player.id)}updatePlayerAttributes(e,r){if(!e||!r)return e;if(r.attrs&&Object.entries(r.attrs).forEach(([n,a])=>{if(typeof a=="number"&&n in e.player.attrs){let o=e.player.attrs[n]+a;e.player.attrs[n]=Math.max(0,Math.min(100,o))}}),typeof r.legend=="number"&&(e.player.legend=Math.max(0,e.player.legend+r.legend)),typeof r.reputation=="number"){let n=e.player.reputation+r.reputation;e.player.reputation=Math.max(0,Math.min(100,n))}return r.resources&&Object.entries(r.resources).forEach(([n,a])=>{if(typeof a=="number"&&n in e.player.resources){let o=e.player.resources[n]+a;e.player.resources[n]=Math.max(0,o)}}),e}updateWorldState(e,r){return!e||!r||(r.era&&(e.world.era=r.era),r.flags&&r.flags.forEach(n=>{e.world.flags.includes(n)||e.world.flags.push(n)}),r.time&&(e.world.time=p(p({},e.world.time),r.time)),r.regions&&(e.world.regions=e.world.regions||{},Object.entries(r.regions).forEach(([n,a])=>{e.world.regions[n]=p(p({},e.world.regions[n]||{}),a)}))),e}addDialogueHistory(e,r){return!e||!r||(Array.isArray(r)?e.dialogueHistory.push(...r):e.dialogueHistory.push(r),e.dialogueHistory.length>this.storageLimits.maxDialogueHistory&&(e.dialogueHistory=e.dialogueHistory.slice(-this.storageLimits.maxDialogueHistory))),e}startAutoSave(){!this.autoSaveEnabled||this.autoSaveTimer||(this.autoSaveTimer=setInterval(()=>{let e=this.load(this.currentSlot);e&&this.save(e,!0)},this.autoSaveInterval*1e3),console.log(`\u81EA\u52A8\u4FDD\u5B58\u5DF2\u542F\u52A8\uFF0C\u95F4\u9694: ${this.autoSaveInterval} \u79D2`))}stopAutoSave(){this.autoSaveTimer&&(clearInterval(this.autoSaveTimer),this.autoSaveTimer=null,console.log("\u81EA\u52A8\u4FDD\u5B58\u5DF2\u505C\u6B62"))}setAutoSaveInterval(e){this.autoSaveInterval=Math.max(10,e),this.autoSaveTimer&&(this.stopAutoSave(),this.startAutoSave())}exportSave(e=null){let r=this.load(e!=null?e:this.currentSlot);return r?JSON.stringify(r,null,2):null}importSave(e,r){try{let n=JSON.parse(e);if(!n.meta||!n.player)throw new Error("\u5B58\u6863\u683C\u5F0F\u65E0\u6548");return typeof r=="number"&&(this.currentSlot=r),this.save(n,!1)}catch(n){return console.error("\u5BFC\u5165\u5B58\u6863\u5931\u8D25:",n),!1}}getStorageInfo(){if(this.storage.isMock())return{total:this.storageLimits.maxTotalSize,used:0,available:this.storageLimits.maxTotalSize,usagePercentage:0};try{let e=wx.getStorageInfoSync();return{total:this.storageLimits.maxTotalSize,used:e.currentSize*1024,available:this.storageLimits.maxTotalSize-e.currentSize*1024,usagePercentage:e.currentSize/10240,keys:e.keys}}catch(e){return console.error("\u83B7\u53D6\u5B58\u50A8\u4FE1\u606F\u5931\u8D25:",e),null}}},d=new E;function h(t,e,r=120){return Array.isArray(e)?t.push(...e):t.push(e),xe(t,r),t}function R(t){return t.pop()}function xe(t,e){t.length>e&&t.splice(0,t.length-e)}function y(){return D()?wx:null}function D(){return typeof wx!="undefined"}function H(){let t=y();if(t&&typeof t.getSystemInfoSync=="function"){let r=t.getSystemInfoSync();return{windowWidth:r.windowWidth||375,windowHeight:r.windowHeight||667,pixelRatio:r.pixelRatio||2}}let e=typeof window!="undefined"?window:void 0;return{windowWidth:(e==null?void 0:e.innerWidth)||375,windowHeight:(e==null?void 0:e.innerHeight)||667,pixelRatio:(e==null?void 0:e.devicePixelRatio)||2}}function q(){let t=y(),e=H(),r=e.windowWidth*e.pixelRatio,n=e.windowHeight*e.pixelRatio;if(t&&typeof t.createCanvas=="function"){let a=t.createCanvas();return a.width=r,a.height=n,a}if(typeof document!="undefined"&&typeof document.createElement=="function"){let a=document.createElement("canvas");return a.width=r,a.height=n,a}return console.warn("wx.createCanvas \u4E0D\u53EF\u7528\uFF0C\u8FD4\u56DE null\u3002"),null}function Y(t){let e=y();!e||typeof e.onTouchStart!="function"||e.onTouchStart(t)}function J(t){let e=y();!e||typeof e.onKeyboardInput!="function"||e.onKeyboardInput(t)}function B(t){let e=y();!e||typeof e.onKeyboardConfirm!="function"||e.onKeyboardConfirm(t)}function Q(t){let e=y();!e||typeof e.onKeyboardComplete!="function"||e.onKeyboardComplete(t)}function X(t,e=100){let r=y();if(!r||typeof r.showKeyboard!="function"){console.warn("wx.showKeyboard \u4E0D\u53EF\u7528\u3002");return}r.showKeyboard({defaultValue:t,maxLength:e,multiple:!1,confirmHold:!1,confirmType:"send"})}function Z(){let t=y();!t||typeof t.hideKeyboard!="function"||t.hideKeyboard({})}function ee({url:t,data:e,method:r="POST",timeout:n=15e3,header:a={"Content-Type":"application/json"}}){let o=y();return!o||typeof o.request!="function"?Promise.reject(new Error("wx.request \u4E0D\u53EF\u7528\uFF0C\u65E0\u6CD5\u53D1\u8D77\u7F51\u7EDC\u8BF7\u6C42")):new Promise((s,l)=>{o.request({url:t,data:e,method:r,timeout:n,header:a,enableChunked:!0,success(u){s({statusCode:u.statusCode,data:u.data})},fail(u){l(u)}})})}function F(t){if(typeof requestAnimationFrame=="function"){requestAnimationFrame(t);return}setTimeout(()=>t(Date.now()),16)}async function te({url:t=m.ADJUDICATION_API,payload:e,retries:r=m.MAX_RETRIES,retryDelay:n=m.RETRY_DELAY,timeout:a=m.REQUEST_TIMEOUT}){let o=0,s=null;for(;o<=r;)try{let l=await ee({url:t,data:e,method:"POST",timeout:a,header:{"Content-Type":"application/json"}});if(l.statusCode>=200&&l.statusCode<300)return l.data;throw new Error(`\u8BF7\u6C42\u5931\u8D25: ${l.statusCode}`)}catch(l){if(s=l,o+=1,o>r)break;await new Promise(u=>setTimeout(u,n))}throw s instanceof Error?s:new Error("\u8BF7\u6C42\u5931\u8D25\u4E14\u65E0\u53EF\u7528\u9519\u8BEF\u4FE1\u606F")}var K=["\u5EFA\u5B81\u5143\u5E74\uFF08\u516C\u5143168\u5E74\uFF09\uFF0C\u4F60\u9192\u6765\u53D1\u73B0\u81EA\u5DF1\u8EAB\u5904\u6D1B\u9633\u57CE\u5916\u7684\u5C0F\u6751\u5E84\u3002","\u6751\u4E2D\u957F\u8005\u544A\u8BC9\u4F60\uFF0C\u9EC4\u5DFE\u4E4B\u4E71\u5373\u5C06\u7206\u53D1\uFF0C\u5929\u4E0B\u5C06\u4E71\u3002","\u4F60\u53EF\u4EE5\u9009\u62E9\u6295\u9760\u5B98\u5E9C\uFF0C\u4E5F\u53EF\u4EE5\u6697\u4E2D\u7ED3\u4EA4\u8C6A\u6770\uFF0C\u751A\u81F3\u52A0\u5165\u592A\u5E73\u9053\u2026\u2026"],i={canvas:null,ctx:null,layout:null,screenWidth:0,screenHeight:0,playerAttributes:{strength:c.attrs.strength,intelligence:c.attrs.intelligence,charm:c.attrs.charm,luck:c.attrs.luck,legend:c.legend},dialogueHistory:[...K],input:G(),isSaveLoadPanelVisible:!1,currentSaveData:null,isAdjudicating:!1,loopActive:!1},_=!1,re=!1;function Te(){if(_)return{ready:!0};let t=q();if(!t)return{ready:!1,message:"\u65E0\u6CD5\u521B\u5EFA Canvas\uFF0C\u4E0A\u4E0B\u6587\u4E0D\u53EF\u7528"};let e=H(),r=e.pixelRatio||1,n=e.windowWidth,a=e.windowHeight,o=t.getContext("2d");return o?(r!==1&&typeof o.scale=="function"&&o.scale(r,r),i.canvas=t,i.ctx=o,i.screenWidth=n||t.width,i.screenHeight=a||t.height,i.layout=j(i.screenWidth,i.screenHeight),d.init(),le(),Pe(),f(),_=!0,{ready:!0}):{ready:!1,message:"\u65E0\u6CD5\u83B7\u53D6 CanvasRenderingContext2D"}}function Ie(){if(i.loopActive)return;i.loopActive=!0;let t=()=>{f(),F(t)};F(t)}function ie(t){var l;if(!i.layout)return;let e=(l=t.touches)==null?void 0:l[0];if(!e)return;let{x:r,y:n}=e,{inputArea:a,saveLoadPanel:o,attributePanel:s}=i.layout;if(x(a,r,n)){Ee(r,n);return}if(i.isSaveLoadPanelVisible&&x(o,r,n)){let u=o.width/2;r<=u?se():k();return}x(s,r,n)&&r>=s.width-60&&k()}function oe(){A(i.input,!0),X(i.input.value),f()}async function O(){if(i.isAdjudicating)return;let t=i.input.value.trim();if(!t)return;h(i.dialogueHistory,[`\u4F60\u8BF4\uFF1A\u201C${t}\u201D`,"\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"]),i.currentSaveData&&d.addDialogueHistory(i.currentSaveData,[`\u4F60\u8BF4\uFF1A\u201C${t}\u201D`,"\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"]),$(i.input),Z(),A(i.input,!1),U(),f(),i.isAdjudicating=!0;let e=Re(t);try{let r=await te({payload:e});ae(),De(r)}catch(r){ae(),h(i.dialogueHistory,"\u7F51\u7EDC\u6CE2\u52A8\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5 (\u70B9\u51FB\u8F93\u5165\u6846\u91CD\u8BD5)"),f(),console.error("\u88C1\u51B3 API \u8C03\u7528\u5931\u8D25:",r),He(t)}finally{i.isAdjudicating=!1}}function k(){i.isSaveLoadPanelVisible=!i.isSaveLoadPanelVisible,f()}function se(){i.currentSaveData||(i.currentSaveData=d.createNewSave(0,"\u624B\u52A8\u5B58\u6863")),d.save(i.currentSaveData,!1)&&(h(i.dialogueHistory,"\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"),f(),setTimeout(()=>{i.dialogueHistory.at(-1)==="\u3010\u6E38\u620F\u5DF2\u4FDD\u5B58\u3011"&&(R(i.dialogueHistory),f())},3e3))}function le(){let t=d.load(0);if(t)return i.currentSaveData=t,T(),console.log("\u5B58\u6863\u52A0\u8F7D\u6210\u529F"),!0;let e=d.createNewSave(0,"\u521D\u59CB\u5B58\u6863");return d.save(e,!1)?(i.currentSaveData=e,T(),console.log("\u65B0\u5B58\u6863\u521B\u5EFA\u5E76\u4FDD\u5B58\u6210\u529F"),!0):(console.warn("\u521D\u59CB\u5B58\u6863\u4FDD\u5B58\u5931\u8D25\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u6570\u636E"),i.currentSaveData=null,i.dialogueHistory=[...K],!1)}function f(){!i.ctx||!i.layout||V({ctx:i.ctx,layout:i.layout,screenWidth:i.screenWidth,screenHeight:i.screenHeight,playerAttributes:i.playerAttributes,dialogueHistory:i.dialogueHistory,currentInput:i.input.value,currentSaveData:i.currentSaveData,isSaveLoadPanelVisible:i.isSaveLoadPanelVisible,keyboardActive:i.input.isKeyboardVisible})}function Ce(t){I(i.input,t),f()}function Le(){return{initialized:_,input:i.input,currentSaveData:i.currentSaveData,dialogueHistory:i.dialogueHistory,playerAttributes:i.playerAttributes}}function Pe(){re||!D()||(Y(t=>ie(t)),J(t=>{I(i.input,t.value),f()}),B(()=>{O().catch(t=>console.error(t))}),Q(()=>{A(i.input,!1),f()}),re=!0)}function Ee(t,e){if(!i.layout)return;let r=i.layout.inputArea,n={x:r.width-70,y:r.y+20,width:60,height:40};x(n,t,e)?O().catch(a=>console.error(a)):oe()}function Re(t){let e=c,r=v,n=S,a;return i.currentSaveData&&(e=i.currentSaveData.player,r=i.currentSaveData.world,n=i.currentSaveData.npcs||S,a={recent_dialogue:i.currentSaveData.dialogueHistory.slice(-3)}),{player_state:e,world_state:r,npc_state:n,event_context:a,player_intent:t}}function De(t){var r,n,a,o;let e=((r=t.result)==null?void 0:r.narrative)||"\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u6CE8\u610F\u3002";h(i.dialogueHistory,e),i.currentSaveData&&(d.addDialogueHistory(i.currentSaveData,e),(n=t.state_changes)!=null&&n.player&&t.state_changes.player.length>0&&ne(t.state_changes.player),(a=t.result)!=null&&a.effects&&ne(t.result.effects),(o=t.state_changes)!=null&&o.world&&d.updateWorldState(i.currentSaveData,t.state_changes.world),U(),T()),f()}function ne(t){if(!i.currentSaveData)return;let e={},r={},n=0,a=0;t.forEach(o=>{let s=o.match(/^([a-zA-Z_]+)([+-]\d+)$/);if(!s)return;let[,l,u]=s,g=Number(u);Number.isNaN(g)||(l in i.currentSaveData.player.attrs?e[l]=(e[l]||0)+g:l==="legend"?n+=g:l==="reputation"?a+=g:l in i.currentSaveData.player.resources&&(r[l]=(r[l]||0)+g))}),d.updatePlayerAttributes(i.currentSaveData,{attrs:e,legend:n,reputation:a,resources:r})}function He(t){setTimeout(()=>{let e="\u4F60\u7684\u4E3E\u52A8\u5F15\u8D77\u4E86\u53BF\u5C09\u7684\u6CE8\u610F\uFF0C\u4ED6\u5BF9\u4F60\u7684\u884C\u4E3A\u8868\u793A\u8D5E\u8D4F\u3002";h(i.dialogueHistory,e),i.currentSaveData&&(d.addDialogueHistory(i.currentSaveData,e),d.updatePlayerAttributes(i.currentSaveData,{attrs:{intelligence:1},reputation:3}),U(),T()),f()},1e3)}function U(){i.currentSaveData&&d.save(i.currentSaveData,!0)}function T(){i.currentSaveData&&(i.playerAttributes={strength:i.currentSaveData.player.attrs.strength||c.attrs.strength,intelligence:i.currentSaveData.player.attrs.intelligence||c.attrs.intelligence,charm:i.currentSaveData.player.attrs.charm||c.attrs.charm,luck:i.currentSaveData.player.attrs.luck||c.attrs.luck,legend:i.currentSaveData.player.legend||c.legend},i.dialogueHistory=i.currentSaveData.dialogueHistory.length?[...i.currentSaveData.dialogueHistory]:[...K])}function ae(){i.dialogueHistory.at(-1)==="\uFF08\u7B49\u5F85\u88C1\u51B3\u7ED3\u679C...\uFF09"&&R(i.dialogueHistory)}function x(t,e,r){var o,s;let n=(o=t.x)!=null?o:0,a=(s=t.y)!=null?s:0;return e>=n&&e<=n+t.width&&r>=a&&r<=a+t.height}
