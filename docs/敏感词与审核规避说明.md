# 敏感词与审核规避说明

微信内容审核（`wx.security.msgSecCheck`）和平台规则会动态调整，无法 100% 事前规避。建议用「提示词规范 + 送审前替换 + 失败复盘」三层方式科学降低拦截率。

---

## 1. 从源头约束：安全叙事规范（Prompt）

- **位置**：`src/config/index.ts` → `NARRATIVE_SAFETY_INSTRUCTION`
- **作用**：该文案会随每次裁决请求注入到云函数的 Prompt 中，要求 LLM 用古风、含蓄笔法，避免直白血腥/暴力/政治等。
- **维护**：若某类表述反复被拒，可在此补充「避免用语」或更具体的替代写法（如「战争场面用烽烟、兵戈带过」）。

---

## 2. 送审前轻量替换（降低拒绝率）

- **位置**：`src/services/security/contentGuard.ts` → `NARRATIVE_RISK_REPLACEMENTS`
- **作用**：叙事在调用 `msgSecCheck` 前，先对少量高触发词做同义替换（如「血腥」→「肃杀之气」），再送审；通过后**展示给玩家的仍是原文**，仅用替换后的文本过审。
- **维护**：根据「审核失败」的日志或反馈，把常被拒的短语加入该数组，优先选「替换后语义可接受」的写法。

---

## 3. 失败复盘与迭代（科学迭代）

- **记录**：审核不通过时，`feedbackLogger.recordSanitizeFailure` 会记录叙事片段（见 `src/services/security/feedbackLogger.ts`）。可在灰度或测试环境定期查看这些记录。
- **迭代步骤**：
  1. 汇总被拒内容中的高频词/句式；
  2. 能在 Prompt 里规避的 → 补充进 `NARRATIVE_SAFETY_INSTRUCTION`；
  3. 适合做同义替换的 → 加入 `NARRATIVE_RISK_REPLACEMENTS`；
  4. 无法替换且合规的 → 可考虑是否误判，或联系平台确认规则。

---

## 4. 不建议的做法

- **本地敏感词表直接拦截叙事**：容易误伤文学化描写（如「隐约血腥」），已改为叙事仅走 msgSecCheck + 轻量替换。
- **过度替换**：`NARRATIVE_RISK_REPLACEMENTS` 只放少量高触发、可替代的短语，避免叙事失真。

---

## 5. 小结

| 层级       | 位置                         | 作用           |
|------------|------------------------------|----------------|
| Prompt 规范 | `config/index.ts`            | 从生成端减少敏感表述 |
| 送审前替换 | `contentGuard.ts` 风险词表   | 降低动态审核拒绝率   |
| 失败复盘   | `feedbackLogger` + 本说明文档 | 持续迭代风险词与规范 |

审核规则变化时，优先更新 **NARRATIVE_SAFETY_INSTRUCTION** 和 **NARRATIVE_RISK_REPLACEMENTS**，再结合失败日志微调即可。
