# 提示词相关文件汇总

本文档汇总工程中与提示词（Prompt）相关的核心文件路径及各自职责。

---

## 一、核心提示词定义与注册

| 文件路径 | 说明 |
|----------|------|
| `src/agents/prompts.ts` | **主提示词库**：定义 `PROMPT_KEYS`，在 `bootstrapDefaultPrompts()` 中通过 `registerPrompt()` 注册所有叙事与引导类提示词（名望称呼、旅途叙事、状态感知、志向引导、微目标注入、内心独白、建议动作志向等）。 |
| `src/core/contentRegistry.ts` | **提示词存储与读取**：提供 `registerPrompt`、`getPrompt`、`listPrompts`，供 `prompts.ts` 与 `eventContextPipeline` 等调用。 |

---

## 二、服务端（云函数）系统提示词

| 文件路径 | 说明 |
|----------|------|
| `cloudfunctions/adjudication/index.js` | **裁决用系统提示**：文件顶部定义 `SYSTEM_PROMPT`（三国剧情裁决者角色与规则），`buildUserPrompt()` 中按 `event_context` 拼装 user 端说明；发给 LLM 的 system 消息内容在此维护。 |

---

## 三、使用提示词拼装上下文的逻辑

| 文件路径 | 说明 |
|----------|------|
| `src/core/eventContextPipeline.ts` | **指令聚合**：根据 `PROMPT_KEYS` 从 contentRegistry 取对应提示词，拼成 `event_context` 中的各类 `*_instruction`（志向、微目标、身体状况、内心独白、建议动作等），供云函数注入 user prompt。 |
| `src/core/snapshot.ts` | **裁决快照**：构建发给裁决 API 的完整快照，依赖 eventContextPipeline 产出的 instruction。 |
| `src/core/preAdjudicator.ts` | **预裁决 / 逻辑预处理**：可能引用与逻辑冲突、地点权威等相关的 instruction。 |

---

## 使用指引

- **修改游戏内叙事 / 引导类提示词**：主要改 `src/agents/prompts.ts`，并确认 `src/core/eventContextPipeline.ts` 中的注入逻辑是否用到对应 key。
- **修改裁决系统的系统人设与规则**：改 `cloudfunctions/adjudication/index.js` 中的 `SYSTEM_PROMPT` 与 `buildUserPrompt`。
