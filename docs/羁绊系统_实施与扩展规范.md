# 羁绊系统 — 实施与扩展规范（供协作 AI 使用）

本文档面向**需要修改羁绊相关代码**的协作方（例如：扩展 Bond 字段、新增 effect 类型、改衰减/情感简报逻辑等）。约定任务边界、必须遵守的规范、代码触点、扩展清单与验收标准。请严格按此规范修改代码，避免破坏现有裁决链路与存档兼容性。

**若协作方只负责「编写羁绊系统的数据」（不写业务代码），请改用《羁绊系统_数据规范与编入约定》；数据编入到游戏的工作由另一方负责。**

---

## 一、任务边界与前置依赖

### 1.1 任务目标

- **使用**：在既有架构下，确保所有羁绊相关读写都走《羁绊系统设计与数据结构》中定义的数据结构与持久化位置（`Bond`、`NPCState.bond`、`GameSaveData.npcs[].bond`），且与 `player_favor` 的同步关系一致。
- **扩展**：若需增加 Bond 字段、effect 类型或新行为，按本规范中的「扩展清单」逐项修改，并保持向后兼容（旧存档无新字段时用默认值补全）。

### 1.2 必读文档与代码

| 文档/路径 | 用途 |
|-----------|------|
| **docs/羁绊系统设计与数据结构.md** | 数据结构定义、读写路径、Effect 协议、扩展建议。 |
| **docs/技术架构说明.md** 第五节 | 羁绊在架构中的位置与接入点。 |
| **src/core/state.ts** | `Bond`、`WorldTime`、`NPCState` 类型定义，**扩展时先改此处**。 |
| **src/core/BondSystem.ts** | 衰减、批量初始化、情感简报；扩展 Bond 时需同步 `createDefaultBond` 的调用处（RelationManager）及本文件内逻辑。 |
| **src/core/RelationManager.ts** | `createDefaultBond`、`ensureBond`、`touchLastSeen`、`updateAffinity`；扩展 Bond 时必须在此初始化新字段。 |
| **src/core/effectsApplier.ts** | 解析 `npc_*_favor`、`npc_*_relation` 并写回 bond；**新增 effect 类型（如 milestone）在此实现**。 |

---

## 二、必须遵守的约定（禁止违反）

1. **权威数据**：亲密度以 `bond.affinity` 为准；任何写入 `player_favor` 的地方必须同步写入 `bond.affinity`（或通过 RelationManager/BondSystem 统一写 bond 再同步到 player_favor）。
2. **无 bond 即未建立羁绊**：不得假定 `NPCState` 一定有 `bond`；读取前用 `RelationManager.ensureBond(npc, worldTime)` 或在业务上接受 `bond` 为 `undefined`。
3. **时间一致性**：`last_seen_world_time` 必须使用当前 `WorldState.time` 的 year/month，不得使用本地 Date 或其它时间源。
4. **存档兼容**：旧存档可能没有 `bond` 或缺少新字段；读档后首次访问某 NPC 的 bond 时通过 `ensureBond`/`createDefaultBond` 补全默认值，**不得**因缺少字段抛错或丢弃存档。
5. **effect 解析**：与羁绊/好感/关系相关的 effect 只允许在 `effectsApplier.applyNpcRelationEffects` 中解析并写回 `saveData.npcs`；不得在 gameApp 或 adjudicationFlow 中重复解析或改写 npcs。
6. **快照前衰减**：每次构建裁决请求前必须调用 `BondSystem.applyDecay(saveData)`（当前在 `snapshot.buildAdjudicationPayload` 首行），不得跳过或移到其它时机。

---

## 三、代码触点清单（使用/扩展时的必查位置）

按「仅使用现有结构」与「扩展结构/行为」分类，修改时请逐项确认。

### 3.1 仅使用现有结构（不新增字段、不新增 effect）

| 位置 | 说明 | 检查要点 |
|------|------|----------|
| **state.ts** | Bond / NPCState 类型 | 不修改类型，仅引用。 |
| **BondSystem.ts** | applyDecay, getEmotionalBrief, getDefaultNPCStateWithBonds, importFromRecords | 调用方是否传对 saveData/worldTime；新档若要用「带 Bond 的 NPC 列表」在此或 config 使用 getDefaultNPCStateWithBonds。 |
| **RelationManager.ts** | ensureBond, touchLastSeen, updateAffinity, createDefaultBond | 任何「首次建立/更新羁绊」处必须经此，不得直接写 npc.bond = {...}。 |
| **snapshot.ts** | buildAdjudicationPayload 开头 | 必须保留 `if (saveData) applyDecay(saveData);`。 |
| **effectsApplier.ts** | applyNpcRelationEffects | 仅解析 `npc_{id}_favor{+|-}N` 与 `npc_{id}_relation=...`，并 ensureBond、同步 affinity、touchLastSeen。 |
| **preAdjudicator.ts** | 时间步进 >1 年时 | 必须保留对 getEmotionalBrief 的调用及 bond_emotional_brief / bond_emotional_instruction 注入。 |

### 3.2 扩展 Bond 字段（如 first_met_world_time、titles、flags）

| 顺序 | 位置 | 必须修改内容 |
|------|------|--------------|
| 1 | **state.ts** | 在 `Bond` 接口中增加新字段及 JSDoc；若为可选，注明默认语义。 |
| 2 | **RelationManager.ts** | 在 `createDefaultBond(worldTime)` 中为新字段赋默认值（空数组/空对象/0 等）。 |
| 3 | **BondSystem.ts** | 若新字段参与衰减或情感简报，在 `applyDecay` 或 `getEmotionalBrief` 中读写；`importFromRecords` 若需初始化新字段则在此处理。 |
| 4 | **snapshot / 请求体** | 若 LLM 或云端需要新字段，在构建 `AdjudicationRequest` 时把 `npc_state` 或 `event_context` 中对应内容带上（通常 npc_state 已含 npcs，bond 会一并序列化；若有单独摘要再补）。 |
| 5 | **存档** | 不删旧数据；读档后无新字段时由 ensureBond/createDefaultBond 补全，无需单独迁移逻辑。 |

### 3.3 扩展 Effect 类型（如 npc_{id}_milestone=描述）

| 顺序 | 位置 | 必须修改内容 |
|------|------|--------------|
| 1 | **effectsApplier.ts** | 在 `applyNpcRelationEffects` 中增加对新格式的解析（如 `npc_(\d+)_milestone=(.+)`）；找到对应 NPC 后 ensureBond，再往 `bond.milestones` 追加一条；做条数上限（如 20）与长度/安全过滤。 |
| 2 | **文档** | 在《羁绊系统设计与数据结构》「Effect 协议」中补充新格式说明及示例。 |

### 3.4 新档使用「带 Bond 的 NPC 列表」

| 位置 | 必须修改内容 |
|------|--------------|
| **config/index.ts** | 将 `DEFAULT_NPC_STATE` 从 `getDefaultNPCState(184)` 改为从 BondSystem 获取带 Bond 的列表，例如：先 `import { getDefaultNPCStateWithBonds } from "@core/BondSystem"`，再 `export const DEFAULT_NPC_STATE: NPCState[] = getDefaultNPCStateWithBonds(184);`。 |
| **saveManager** | `createDefaultSave` 使用的 `DEFAULT_NPC_STATE` 来自 config，改 config 即可；若 createNewSaveWithConfig 有单独构造 npcs 的逻辑，需同步为带 Bond 的列表。 |

---

## 四、验收标准（完成任务后须满足）

1. **类型**：`npm run build` 通过，`npx tsc --noEmit` 无报错。
2. **测试**：现有与羁绊相关的单测（若有）仍通过；新增逻辑需补单测（如 effect 解析、createDefaultBond 默认值）。
3. **数据一致性**：任意写入 `player_favor` 或 `player_relation` 的路径，都同步更新了 `bond`（affinity / last_seen_world_time，以及若实现了 milestone effect 则 milestones）。
4. **旧档**：读档后对某 NPC 首次 ensureBond 时，不因缺少 Bond 或新字段而抛错；游戏可正常继续。
5. **快照**：每次裁决请求前 applyDecay 被调用；时间跨度 >1 年时 bond_emotional_brief 被注入 event_context。

---

## 五、禁止项（不得出现）

- 在 **gameApp / adjudicationFlow** 中直接解析 `npc_*_favor` 或 `npc_*_relation` 或写 `saveData.npcs`。
- 在 **snapshot** 中移除或绕过 `applyDecay(saveData)`。
- 使用 **本地 Date / 时间戳** 作为 `last_seen_world_time` 或 Bond 内时间字段。
- 在未通过 **RelationManager.ensureBond** 的前提下直接给 `npc.bond` 赋值新对象（允许在 ensureBond 之后写 `npc.bond!.xxx = ...`）。
- 因 **存档中缺少 bond 或新字段** 而 throw 或清空 npcs。

---

## 六、当前实现状态（便于「先开发」时选做）

羁绊系统**已在代码中实现**，并非仅存在于文档。以下为已接通与可优先开发项。

### 6.1 已实现并接入

| 项目 | 位置 | 说明 |
|------|------|------|
| Bond / WorldTime 类型 | state.ts | 已定义；NPCState.bond 可选。 |
| 衰减 | BondSystem.applyDecay | 快照前在 snapshot 中调用。 |
| 好感/关系 effect | effectsApplier | npc_*_favor、npc_*_relation 解析，ensureBond + touchLastSeen。 |
| 情感简报 | BondSystem.getEmotionalBrief | preAdjudicator 在时间步进 >1 年时注入 bond_emotional_brief。 |
| 单 NPC 操作 | RelationManager | ensureBond、createDefaultBond、touchLastSeen、updateAffinity。 |
| 带 Bond 的批量列表 | BondSystem | getDefaultNPCStateWithBonds、importFromRecords 已实现。 |

### 6.2 可优先开发（框架已就绪，仅需接好或补全）

| 项目 | 说明 | 规范中的对应小节 |
|------|------|------------------|
| 新档使用带 Bond 的 NPC 列表 | 将 config 的 DEFAULT_NPC_STATE 改为 getDefaultNPCStateWithBonds(184)，新档开局即带 Bond（affinity=0）。 | 三、3.4 |
| effect：npc_{id}_milestone=描述 | 在 effectsApplier 中解析并追加到 bond.milestones，并做条数上限与安全过滤。 | 三、3.3 |
| 关系升级时写里程碑 | 义结金兰/结婚时在 effectsApplier 中往该 NPC 的 bond.milestones 追加一条（可调用 RelationManager.updateAffinity(..., milestone) 或直接 push）。 | 三、3.2 + 设计文档 |
| Bond 扩展字段 | 如需 first_met_world_time、titles、flags 等，按「扩展 Bond 字段」清单在 state / RelationManager / BondSystem / 请求体中补齐。 | 三、3.2 |

执行「按羁绊系统设计与数据结构使用/扩展数据」时，请以**本规范**为准，以**《羁绊系统设计与数据结构》**为数据与协议定义，在上述「可优先开发」项中按需求选择并逐项实现即可。
