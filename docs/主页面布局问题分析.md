# 主页面布局问题分析

基于当前游戏主界面截图与 `src/ui/layout.ts`、`src/ui/renderer.ts`、`src/ui/menu.ts`、`src/config/index.ts` 的对照，整理出的问题与可优化点。**所有 UI 调整均需考虑微信小程序右上角胶囊按钮的避让。**

---

## 零、小程序右上角胶囊按钮避让（最高优先级）

**背景**：微信小程序右上角固定有系统提供的「胶囊」区域（约 87px 宽 × 32px 高），内含「···」菜单与关闭/首页按钮。自定义绘制的内容若与该区域重叠，会被遮挡或发生误触，且不符合平台规范。

**当前风险**：
- **时间条（TimeBanner）**：横跨整屏 `contentWidth`（`screenWidth - safeMargin*2`），右端可能侵入胶囊左侧。
- **「生平」按钮**：位于 TimeBanner 右侧（`area.x + area.width - safeMargin - 52`），与内容右缘对齐，在多数机型上会紧贴甚至压住胶囊，极易误触或遮挡。
- **状态栏**：右侧「重新开始」、五维最右列、「传奇」? 图标同样以 `contentWidth` 为右边界，在窄屏或胶囊偏左的机型上可能进入胶囊留白区。

**建议方案**：

1. **在布局中预留右上角避让区**
   - 在微信环境中调用 `wx.getMenuButtonBoundingClientRect()` 获取胶囊位置（返回 `left/right/top/bottom/width/height`，坐标系为屏幕逻辑坐标）。
   - 在 `LayoutOptions` 中增加 **`safeAreaRight`**（或等价：`capsuleLeft`），取值为「胶囊左边界与屏幕左缘的距离」——即内容区右边界不得超过该值再减一个边距。例如：`contentRight = capsule.left - safeMargin`，则 `contentWidth = capsule.left - safeMargin * 2`。
   - 非微信环境（如 H5/调试）可设 `safeAreaRight = screenWidth` 或用一个保守常量（如 90px 从右往里留），保证布局接口一致。

2. **具体调整**
   - **layout**：`createUILayout` 增加 `safeAreaRight?: number`。计算 `contentWidth` 时改为 `contentWidth = Math.min(screenWidth - safeMargin * 2, (safeAreaRight ?? screenWidth) - safeMargin) - safeMargin` 的等价形式（即内容右缘 ≤ safeAreaRight - safeMargin）。
   - **TimeBanner**：绘制与点击检测的矩形右缘不得超过上述内容右缘，避免与胶囊重叠。
   - **「生平」按钮**：以内容右缘为基准向左排布（例如 `contentRight - HISTORY_BTN_WIDTH`），保证与胶囊之间至少留出数像素间隙；若空间不足，可考虑将「生平」移到时间条文字左侧（时间居中时左侧留空）或改为时间条下方一行小按钮。
   - **状态栏**：`statusPanel.width` 已由 layout 收窄后，内部「重新开始」、属性列、? 图标会自然随 contentWidth 左收，无需再改逻辑，只需确保 gameApp 传入的 `safeAreaRight` 来自胶囊。

3. **实现要点**
   - 在 `gameApp` 的 `initGame`（或首次创建 layout 的地方）中，若存在 `wx.getMenuButtonBoundingClientRect`，则调用并计算 `safeAreaRight = menuRect.left`（逻辑坐标），传入 `createUILayout({ ..., safeAreaRight })`。
   - 若胶囊 API 不可用，则 `safeAreaRight = screenWidth - 90` 等保守预留，避免在真机上压住胶囊。

**涉及**：`src/ui/layout.ts`（LayoutOptions、contentWidth 与 statusPanel 宽度）；`src/ui/menu.ts`（getHistoryButtonRect 以 layout 给出的内容右缘为基准）；`src/ui/renderer.ts`（drawTimeBanner 的 bannerRect.width 已由 layout 限制）；`src/app/gameApp.ts`（initGame 中获取胶囊并传入 layout）；`src/utils/wxHelpers.ts`（可选：封装 getMenuButtonBoundingClientRect 供 layout 使用）。

---

## 一、信息层次与叙事区占比

**现象**：顶部「时间条 + 状态栏（资源/地点/五维/重新开始）」合计约占屏高约 15%+，对话区是“剩余空间”。在竖屏小屏上，首屏留给叙事的空间容易被压缩，玩家需要频繁「下滑查看更多」才能看完一段剧情。

**建议**：
- 将 `statusPanelHeight` 的系数从约 `0.145` 略降（如 0.12），或在小屏时进一步压缩状态栏行高/字号，把更多首屏留给对话区。
- 可选：状态栏支持「点击收起/展开」，默认仅显示时间+地点+体/金/粮，属性与「重新开始」收起在二级。

**涉及**：`src/ui/layout.ts` 中 `statusPanelHeight`、`createUILayout`。

---

## 二、「重新开始」误触风险

**现象**：「重新开始」与五维属性、? 图标同处状态栏右侧，且无二次确认。玩家滑动查看或点「传奇」说明时容易误触，导致进度丢失。

**建议**：
- 增加二次确认：点击后弹出「确定重新开始？当前进度将丢失」再执行。
- 或把「重新开始」移入「生平」旁的菜单/设置中，主界面只保留属性与 ?。
- 做任何右侧布局调整时，均需保证不侵入右上角胶囊区域（见第零节）。

**涉及**：`src/app/gameApp.ts` 中处理重新开始点击处；`src/ui/renderer.ts` 中 `getRestartButtonRect`。

---

## 三、行动建议三重重复

**现象**：叙事里已写「接下来你可以「打听消息」「帮忙农活」」，下方又有两个大按钮「打听消息」「帮忙农活」，输入框还预填了「打听消息」。信息重复，占用视觉与空间。

**建议**：
- 叙事中可弱化具体动作名，改为「接下来不妨在村中打听或帮把手」；或
- 行动按钮只保留 1 个「推荐」高亮，其余用「自定义输入」引导；或
- 输入框占位符与推荐行动错开（当前 PLACEHOLDERS 已有轮播，可避免首条与第一个推荐行动完全一致）。

**涉及**：`src/config/index.ts` 中 `getIntroSegment2CurrentSituation`、`getSuggestedActions`；`src/ui/renderer.ts` 中 `drawActionGuideSlot`、`PLACEHOLDERS`；LLM 返回的 suggested_actions。

---

## 四、【提示】占用了对话气泡

**现象**：「【提示】在下方输入框输入你的意图（如「前往洛阳」「结识豪杰」），点击发送即可推进剧情。下滑查看更多」作为一条完整对话气泡出现，既占一条气泡高度，又和「下滑查看更多」提示重叠（一个在气泡内、一个在对话区底部）。

**建议**：
- 将「在下方输入框输入…点击发送即可推进剧情」从对话历史中移除，改为输入区上方的一行固定小字提示（仅首屏或未发送过时显示），不占对话区。
- 「下滑查看更多」保留在 `drawDialogueArea` 底部即可，避免在气泡文案里再写「下滑查看更多」。

**涉及**：`src/config/index.ts` 中 `GAME_INTRO_HINT`、`getIntroSequence`；`src/app/gameApp.ts` 中如何使用 intro 三段（是否把 hint 当作一条 appendDialogue）；`src/ui/renderer.ts` 中对话区底部提示的绘制。

---

## 五、对话区底部两套提示的竞争

**现象**：同一位置（`area.y + area.height - 10`）会根据状态切换「下滑查看更多」和「点击屏幕跳过」。逻辑正确，但若内容不足一屏时仍可能出现「下滑查看更多」，或打字机未结束时两套逻辑需明确优先级。

**建议**：保持现有逻辑，仅确认：有打字机且未完成时优先「点击屏幕跳过」；无打字机且可滚动时显示「下滑查看更多」；内容不足一屏且无打字机时不显示底部提示。当前代码已按此区分。

**涉及**：`src/ui/renderer.ts` 中 `drawDialogueArea` 末尾两段 `fillText`。

---

## 六、连接状态条（「已连接」「展开」）

**现象**：截图中出现「已连接」与「展开」，当前仓库内未找到对应绘制代码，可能来自运行环境或调试层。

**建议**：若面向正式玩家，连接状态应弱化：仅断线/重连时短暂提示；若为调试用，可收到设置/开发者面板，避免常驻占主界面。

**涉及**：若在项目内实现，需在 renderer 或 gameApp 中新增一块小区域并仅在异常时显示。

---

## 七、属性区密度与「传奇」说明

**现象**：五维 + ? 挤在约 104–124px 高的状态栏下半部分，11px/13px 字号在小屏上略挤。

**建议**：维持现有布局与 `getAttrHelpButtonRect`，确保点击 ? 能稳定弹出属性说明（含「传奇」）。若未实现弹窗，需在 gameApp 中补上点击 ? 打开说明浮层的逻辑。

**涉及**：`src/ui/renderer.ts` 中 `drawStatusPanel`、`getAttrHelpButtonRect`；`src/app/gameApp.ts` 中 touch 对 `getAttrHelpButtonRect` 的处理。

---

## 八、安全区域与动态排版

**现状**：`createUILayout` 已使用 `safeMargin`、`safeAreaTop`、`safeAreaBottom`、`contentWidth` 按比例计算，符合规则要求。

**建议**：
- 确认在微信侧调用 `wx.getSystemInfoSync()` 后，将 `safeArea.top` / `safeArea.bottom` 传入 `createUILayout`，以便刘海/Home 条设备正确留白。
- **同时**必须考虑右上角胶囊：将 `wx.getMenuButtonBoundingClientRect()` 得到的 `left` 作为内容右边界上限（或传入 `safeAreaRight`），在 `createUILayout` 中参与 `contentWidth` 计算，使时间条、生平、状态栏、对话区、输入区等全部落在胶囊左侧，不侵入右上角。

**涉及**：`src/app/gameApp.ts`（或入口）中获取系统信息与胶囊位置并调用 `createUILayout(opts)` 的传参；`src/ui/layout.ts` 中增加 `safeAreaRight` 并用于 contentWidth。

---

## 九、小结与优先级

| 优先级 | 问题                     | 建议动作                                         |
|--------|--------------------------|--------------------------------------------------|
| 高     | **右上角胶囊避让**       | 用 getMenuButtonBoundingClientRect 设 content 右界；时间条/生平/状态栏不侵入胶囊 |
| 高     | 重新开始误触             | 二次确认或移入菜单                               |
| 高     | 提示占对话气泡 + 重复    | 提示改为输入区上方固定小字                       |
| 中     | 叙事区占比               | 略降状态栏高度或支持折叠                         |
| 中     | 行动建议三重重复         | 弱化叙事中的动作名或按钮数量                     |
| 低     | 连接状态条               | 仅异常时显示或移入调试面板                       |
| 低     | 传奇 ? 说明              | 确认点击 ? 有说明弹窗                            |

**说明**：凡涉及顶部或右侧的 UI 改动（时间条、生平、状态栏、后续任何右上角元素），都必须基于「内容右缘 ≤ 胶囊左侧 - safeMargin」的约束做布局，避免与小程序自带按钮重叠。

如需我按某一项直接改代码（例如「胶囊避让 + layout 接入 safeAreaRight」或「重新开始二次确认」），可指定优先级或文件，我按该方案给出具体修改片段。
