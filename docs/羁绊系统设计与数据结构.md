# 羁绊系统设计与数据结构

本文档说明羁绊系统在当前技术架构下的**数据结构约定**、**持久化位置**、**与裁决链路的对接方式**，以及如何扩展。

---

## 一、数据结构定义（推荐/当前）

### 1.1 核心类型（与 `core/state.ts` 一致）

```ts
/** 世界时间（年/月），用于羁绊的「上次见面时间」等 */
export interface WorldTime {
  year: number;
  month: number;
}

/** 玩家与单个 NPC 的羁绊 */
export interface Bond {
  /** 亲密度数值，0～100，随互动与时间变迁；与 NPCState.player_favor 保持同步 */
  affinity: number;
  /** 关键记忆/里程碑事件描述，保留最近若干条（如 20 条），供叙事与回顾 */
  milestones: string[];
  /** 上次见面（或关系/好感发生变更）时的世界时间，用于计算「未见面月数」做衰减 */
  last_seen_world_time: WorldTime;
}
```

- **affinity**：唯一数值化「亲密度」的字段；与 `NPCState.player_favor` 双写，便于 LLM 侧和 UI 统一用「好感度」语义。
- **milestones**：由裁决或本地在关键事件（如义结金兰、结婚、重大抉择）时追加；建议限制条数（如 20）避免存档膨胀。
- **last_seen_world_time**：每次「见面」或「好感/关系变更」时更新，用于 BondSystem 的 `applyDecay` 计算「未见面月数」。

### 1.2 挂在谁身上（持久化位置）

- **NPC 维度**：每个 NPC 一条羁绊，挂在 `NPCState` 上。
- **存档结构**：`GameSaveData.npcs[]` 中每个元素类型为 `NPCState`，其中包含可选字段 `bond?: Bond`。

```ts
export interface NPCState {
  id: string;
  name?: string;
  birth_year?: number;
  death_year?: number;
  stance: string;
  trust: number;
  location?: string;
  /** 玩家对该武将的好感度 0～100；与 bond.affinity 同步，供 LLM/UI 使用 */
  player_favor?: number;
  /** 玩家与该武将的关系类型：空、相识、义结金兰、结婚 */
  player_relation?: PlayerRelationType;
  /** 武将与其它武将的好感/关系：npc_id -> 好感度 */
  relations?: Record<string, number>;
  /** 与玩家的羁绊；有互动或关注时存在 */
  bond?: Bond;
}
```

约定：

- **权威数据**：亲密度以 `bond.affinity` 为准；`player_favor` 为同步出的展示/请求用字段。
- **无 bond**：表示尚未与该 NPC 建立羁绊（未见面或未触发过好感变更）；首次需要时由 `RelationManager.ensureBond(npc, worldTime)` 创建默认 Bond（affinity=0, milestones=[], last_seen=worldTime）。

---

## 二、羁绊在架构中的读写路径

| 环节 | 动作 | 说明 |
|------|------|------|
| **快照构建前** | `applyDecay(saveData)` | 按当前世界时间对全部 NPC 的 bond 做「未见面月数」衰减，并把衰减后的 `bond.affinity` 写回 `player_favor`。 |
| **效果应用** | `npc_*_favor` / `npc_*_relation` | 解析 effect 时更新 `player_favor` 与 `player_relation`，并 `ensureBond`、同步 `bond.affinity`、调用 `touchLastSeen(npc, worldTime)`。 |
| **关系升级** | 义结金兰/结婚 | 同上，并校验双方年龄≥15；可选在此时往 `bond.milestones` 追加一条描述。 |
| **时间跨度叙事** | `getEmotionalBrief(...)` | 时间步进超过 1 年时，对有羁绊或关系的 NPC 生成「X年未见、物是人非」类简报，注入 `event_context.bond_emotional_brief`。 |
| **新档/重置** | `getDefaultNPCStateWithBonds(year)` 或 `importFromRecords(records, worldTime)` | 若希望开局所有 NPC 就有 Bond 结构（affinity=0），用 BondSystem 提供的带 Bond 的默认列表；否则首次互动时再 ensureBond。 |

---

## 三、Effect 协议（与羁绊相关）

裁决 API 返回的 `effects` 中，与羁绊/好感/关系相关的约定格式如下（由 `effectsApplier.applyNpcRelationEffects` 解析）：

- **好感度增减**：`npc_{id}_favor{+|-}{数字}`  
  例：`npc_1_favor+10`、`npc_2_favor-5`  
  应用时：更新 `player_favor`，`ensureBond` 后同步 `bond.affinity`，并 `touchLastSeen`。
- **关系类型**：`npc_{id}_relation={acquaintance|sworn_brother|spouse}`  
  应用时：校验年龄后写入 `player_relation`，并 `touchLastSeen`。

若需「里程碑」由服务端驱动，可扩展 effect，例如：

- `npc_{id}_milestone={一段描述}`：在应用 effect 时往该 NPC 的 `bond.milestones` 追加一条（并做条数上限与安全过滤）。

---

## 四、扩展羁绊数据结构时的建议

在保持「亲密度 + 上次见面时间」核心语义的前提下，可按需在 `Bond` 上增加字段，例如：

| 字段（示例） | 类型 | 用途 |
|-------------|------|------|
| `first_met_world_time` | WorldTime | 首次见面时间，用于成就或叙事「相识 X 年」。 |
| `titles` | string[] | 玩家对该 NPC 的称呼/称号（如「吾之兄弟」），由叙事或选项写入。 |
| `flags` | string[] | 羁绊相关 flag（如「曾共历生死」「曾对立」），供叙事分支或条件判定。 |

扩展时注意：

1. 在 **state.ts** 中扩展 `Bond` 类型。
2. 在 **RelationManager** / **BondSystem** 中：新建 Bond 时初始化新字段；若有衰减或时间相关逻辑，在 `applyDecay` 或 `getEmotionalBrief` 中一并处理。
3. 在 **snapshot** 或 **event_context** 中把需要给 LLM 用的新字段放入 `npc_state` 或 `event_context`，以便叙事与判定一致。
4. **存档迁移**：若旧存档没有新字段，读档后首次访问该 NPC 的 bond 时用默认值补全（ensureBond 已会创建默认 Bond，在 `createDefaultBond` 里加新字段即可）。

按上述方式定义与扩展，羁绊系统会始终落在「core 状态 + 快照/效果/叙事」的既有架构内，无需改 gameApp 主流程。

---

## 五、当前实现状态（代码中已具备的框架）

羁绊系统**已在代码中实现**，并非仅写在文档里。以下为已接通与可继续开发项。

- **已实现并接入**：`Bond` / `WorldTime` 类型（state.ts）；`BondSystem.applyDecay`、`getEmotionalBrief`、`getDefaultNPCStateWithBonds`（BondSystem.ts）；`ensureBond`、`touchLastSeen`、`updateAffinity`、`createDefaultBond`（RelationManager.ts）；快照前调用 `applyDecay`（snapshot.ts）；`npc_*_favor` / `npc_*_relation` 的解析与 bond 同步（effectsApplier.ts）；时间步进 >1 年时注入 `bond_emotional_brief`（preAdjudicator.ts）。
- **可先开发**：新档使用带 Bond 的 NPC 列表（config 改用 `getDefaultNPCStateWithBonds`）；effect 扩展 `npc_{id}_milestone=...`；关系升级时往 `milestones` 追加；Bond 扩展字段（first_met_world_time、titles、flags 等）。

实施与扩展时的**具体修改位置、约定与验收标准**见 **《羁绊系统_实施与扩展规范》**（`docs/羁绊系统_实施与扩展规范.md`），供协作 AI 或人工按规范执行。
