# 游戏体验自动化测试方案

## 可行性结论

**可行。** 现有接口已经足够让「AI 或脚本」驱动游戏并收集对话与结论，无需改游戏逻辑，只需增加一个**驱动脚本**和（可选）**评估 LLM**。

---

## 现有可用的「接口」

| 层面 | 接口 | 说明 |
|------|------|------|
| **裁决 API** | `POST /intent/resolve`（或云函数 `adjudication`） | 入参：`AdjudicationRequest`（player_state, world_state, npc_state, player_intent, ...）；出参：`AdjudicationResponse`（narrative, effects, suggested_actions, state_changes）。可直接用 HTTP 调用，不依赖小游戏环境。 |
| **构建请求** | `buildAdjudicationPayload(saveData, intent)` + `processPlayerAction(payload)` | 在 Node 里可跑，产出发给裁决 API 的 payload。 |
| **游戏 App** | `initGame()` / `setCurrentInput(value)` / `submitInput()` / `getState()` | 需要 Canvas/wx 环境；若只做「对话流」自动化，用上面 API 即可，不必起完整 gameApp。 |

因此：**用「裁决 API + 构建请求」就能实现「AI 问了什么 → 系统回答了什么」的自动化测试**，无需真机或模拟器。

---

## 推荐做法

1. **驱动脚本（Node）**
   - 准备一份初始存档（或固定 fixture）。
   - 每轮：选定一个「玩家意图」→ 用 `buildAdjudicationPayload` + `processPlayerAction` 构建请求 → 用 `fetch` 调裁决 API → 拿到 `narrative`。
   - 记录：`玩家: <意图>` / `系统: <narrative>`。
   - 可多轮（意图列表或由「测试 AI」动态生成）。

2. **测试结束后输出**
   - **主要聊天信息**：每轮的「玩家: xxx」「系统: xxx」整理成一段或列表（Markdown/JSON 均可）。
   - **测试结论**：可先做规则结论（如：是否每轮都有叙事、是否超时、是否抛错）；若需要「体验评价」，再接入一个**评估 LLM**，把整段对话发给它，让它输出简短结论（如：叙事是否连贯、是否贴合三国、是否有明显 bug）。

3. **谁来决定「下一句问什么」**
   - **脚本固定**：例如 `["前往洛阳", "打听消息", "闭关 2 年"]`，适合回归。
   - **AI 驱动**：用另一个 LLM（**测试 AI**），输入「当前对话 + 当前状态」，输出「建议的下一步意图」或「结束测试」，再交给脚本执行并记录；测试结束后再调一次该 LLM，产出**体验报告与优化建议**。详见 **[测试AI_内测玩家方案.md](./测试AI_内测玩家方案.md)**。

---

## 本地如何设置环境变量

### 方式一：用 .env 文件（推荐）

1. 在项目根目录复制示例：`cp .env.example .env`
2. 用编辑器打开 `.env`，填上你的值（不要提交到 Git，`.env` 已在 `.gitignore` 中）：
   - **DEEPSEEK_API_KEY**（必填）：你的 DeepSeek API Key。
   - **ADJUDICATION_API**（必填）：裁决接口地址。**推荐**：先在本机起本地裁决服务（见下方「获取 ADJUDICATION_API」），再填 `http://localhost:3000/intent/resolve`。
3. 运行 `npm run playtest` 时会自动读取 `.env`，无需再在终端里 export。
4. **若使用本地裁决服务**：先在**一个终端**运行 `npm run adjudication-server` 并保持运行，再在**另一个终端**运行 `npm run playtest`。

### 方式二：当前终端临时设置

在运行 playtest 的终端里先执行（只对当前终端生效，关掉就没了）：

```bash
export ADJUDICATION_API="https://你的裁决接口地址"
export DEEPSEEK_API_KEY="sk-你的Key"
npm run playtest
```

或写在一行：

```bash
ADJUDICATION_API="https://..." DEEPSEEK_API_KEY="sk-..." npm run playtest
```

### ADJUDICATION_API 从哪里获取？

- **推荐（本地裁决服务）**：在项目根目录执行 `npm run adjudication-server`，服务会在本机 `http://localhost:3000/intent/resolve` 提供裁决接口；在 `.env` 中填 `ADJUDICATION_API=http://localhost:3000/intent/resolve` 即可。API Key 使用 `.env` 里的 `DEEPSEEK_API_KEY`（或 `HUNYUAN_API_KEY`），无需云开发 URL 化。
- **可选（云函数 HTTP）**：若已为云函数开启 HTTP 触发/URL 化，可将控制台生成的 URL 填为 `ADJUDICATION_API`。详见 [云开发_裁决API部署指南.md](./云开发_裁决API部署指南.md) 中「ADJUDICATION_API 从哪里获取？」一节。

### 可选变量

- `PLAYTEST_PERSONA`：本次体验人设，例如 `女性玩家，主要体验恋爱、社交等`
- `HUNYUAN_API_KEY`：若用腾讯混元而非 DeepSeek，可设此项

---

## 小结

| 问题 | 答案 |
|------|------|
| 能直接调用现有接口做自动化测试吗？ | 能，主要是裁决 API + 构建请求。 |
| 能由 AI 驱动体验测试吗？ | 能，用脚本 + 可选「测试 AI」决定下一步意图并执行。 |
| 能把主要聊天和测试结论发给你吗？ | 能，脚本在结束时输出「主要聊天信息」和「测试结论」到文件或控制台即可。 |

**已落地的脚本**：

1. **固定意图回归**：`tests/playtestExperience.test.ts`  
   - 运行：`ADJUDICATION_API=<url> npm run test -- tests/playtestExperience.test.ts --run`  
   - 3 轮固定意图，产出 `playtest-report.md`。

2. **测试 AI 内测玩家**：`tests/playtestWithAITest.test.ts` + `tests/playtest/`  
   - 运行：`ADJUDICATION_API=<裁决地址> DEEPSEEK_API_KEY=<与云函数相同的Key> npm run playtest`  
   - 测试 AI 自主多轮游玩（约 8～15 轮），结束后生成体验报告与优化建议，写入 **`docs/playtest-reports/`** 下带日期的报告文件。  
   - 可由 Cursor/助手代为发起：在对话中让助手执行 `npm run playtest`（需先配置上述环境变量）。

3. **深度叙事压力测试（四深水区）**：同一入口，`PLAYTEST_DEEP=1` 或 `npm run playtest:deep`  
   - 四画像并行，每画像**最多 100 轮**：社交反噬（BondSystem 二阶关系）、生存细节（生理/地理约束）、史实嵌套（worldTimeline 蝴蝶效应）、经济权重（物价/稀缺性）。  
   - 开局可植入 **debuff**（断粮/重伤/恶名昭著）。报告内自动包含 **文案疲劳**（连续三轮关键词重合≥70% 的轮次）与 **时空异常**（时间线回退）检测结果。

4. **叙事质量专项测试**：`PLAYTEST_QUALITY=1` 或 `npm run playtest:quality`  
   - 三画像并行：**留白测试**（30 轮，沉思型，仅微小动作，验证感官描写不重复/叙事干瘪）、**逻辑阻力**（50 轮，绝境 debuff，验证生理状态是否强制失败或描写颤抖/准头偏差）、**蝴蝶效应**（80 轮，救小卒后跨时跨城再联系，验证非史实角色中长期记忆与地位变迁）。  
   - 报告内同样包含文案疲劳与时空异常检测。

---

## 跑完耗时与通知方式

| 项目 | 说明 |
|------|------|
| **预计耗时** | 约 **2～5 分钟**（每轮约 2 次 API 调用：测试 AI 决策 + 裁决 API，共约 8～15 轮，视网络与模型速度而定）。 |
| **终端** | 跑完后终端会打印 **「体验测试已跑完，可查看报告」** 及报告路径、体验总结与建议摘要。 |
| **桌面通知** | 在 **macOS** 或 **Linux** 下，跑完会尝试弹出系统通知（标题「体验测试完成」），便于你离开时也能得知。 |
| **由助手发起时** | 若由 Cursor 助手在对话里执行 `npm run playtest`，**命令结束后助手会在对话中直接回复你**：是否成功、报告路径、以及体验总结与建议要点，相当于「跑完就通知到你」。 |
