# 发布上线检查清单

本次重构（羁绊与记忆、史实偏移、玩法权重、UI、存档迁移等）涉及**小游戏前端**与**云函数**，上线时请按下面执行。

---

## 一、必须上传的内容

### 1. 小游戏端（微信开发者工具）

- **上传并发布小游戏代码**：使用当前工程的 `dist/` 或构建产物（`npm run build` 后根目录的 `game.min.js`、`main.min.js`、`config.min.js`、`save.min.js` 及 `game.json`、`project.config.json` 等）。
- 本次改动都在前端逻辑与 UI 中，**不传新代码则新羁绊结构、history_flags、playstyle、离屏缓冲、存档迁移等都不会生效**。

### 2. 云函数（adjudication）

- **需要重新上传并部署云函数**。
- 原因：客户端会把 `event_context.history_deviation_instruction`、`event_context.playstyle_context` 等新字段发给云函数，但**旧版云函数没有把这些写进发给 LLM 的 prompt**，导致「历史偏移」「玩法权重」等说明不会生效。
- 本次已对云函数做的修改：
  - 在 **buildUserPrompt** 中注入 `event_context.history_deviation_instruction`（历史偏移说明）。
  - 在 **buildUserPrompt** 中注入 `event_context.playstyle_context`（志向/称号权重）。
  - 在 **SYSTEM_PROMPT** 的 effects 说明中增加 `npc_{id}_memory=...`（记忆碎片）的约定。
- **操作步骤**：在微信开发者工具中打开「云开发」→ 选择环境 → 找到 `adjudication` 云函数 → 右键「上传并部署：云端安装依赖」（或使用本工程 `cloudfunctions/adjudication/` 下的代码上传）。

---

## 二、可选 / 后续

- **state_changes.world.history_flags**：当前客户端已支持在收到 `state_changes.world.history_flags` 时合并进存档。若希望由 LLM 在剧情中「改写历史」时自动打标，需在云函数中扩展 LLM 输出格式（例如增加 `history_flags` 字段）并在云函数里拼成 `state_changes.world.history_flags` 返回；当前云函数尚未实现，可后续迭代。
- **逻辑库血缘/阵营**：客户端已在 `logic_db.npcs` 中传入 `father_id`、`owner_faction_id`；云函数目前仅把 logic_db 用于「年龄/出仕」一段。若希望 LLM 更显式利用血缘与阵营，可在云函数 buildUserPrompt 里增加一段「逻辑库血缘与阵营」的文案（当前关系与年龄规则中已文字说明，一般已够用）。

---

## 三、发布前自检

1. 本地执行 `npm run build`、`npm run test` 通过。
2. 在开发者工具中用「真机调试」或预览跑一遍：新档、读档、与 NPC 互动、长叙事与打字机、段落换行与滚动。
3. 确认云函数环境变量（如 `DEEPSEEK_API_KEY` 或 `HUNYUAN_API_KEY`）已配置且未过期。
4. 发布后若有旧玩家：存档会在 **load 时自动迁移**（补全 history_flags、active_titles、Bond 新字段与 milestones→memory_shards），无需额外操作。

---

## 四、真机调试时常见报错（可忽略）

- **`adReportOperateWXData:fail invalid scope`（err_code: -12001）**  
  开发/体验环境下，微信基础库或广告能力可能在没有正式广告权限时上报数据，触发该错误。  
  - 已做：激励视频在 **develop / trial** 下不再调用 `createRewardedVideoAd`，减少由己方代码触发的可能。  
  - 若仍出现：多为基础库（WAGame.js）行为，**不影响游戏逻辑**，真机调试可忽略；正式发布并开通广告流量主后，在 **release** 环境下会正常。
