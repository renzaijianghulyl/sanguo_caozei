# 三国沙盒 · 数据库结构与统计说明

本文档汇总当前项目中**所有结构化数据**的存放位置、字段结构及数量统计，便于查阅与扩展。  
类型定义统一参考：`src/data/sanguoDb/types.ts`。

---

## 一、总览

| 分类 | 文件/来源 | 条数/规模 | 说明 |
|------|-----------|-----------|------|
| 武将（NPC） | `sanguoDb/raw/npcs_184.json` | **40** | 184 年剧本核心 NPC，id 2001～2040 |
| 区域（Region） | `sanguoDb/raw/regions_184.json` | **16** | 地图区域，id 1001～1016 |
| 时间线事件 | `sanguoDb/raw/*_timeline.json`（12 个文件） | **187** | 184～280 年史实事件 |
| 区域展示名 | `config/index.ts` → REGION_DISPLAY_NAMES | **6** | 玩家 location.region 的 key → 中文名 |
| 场景类型 | `config/index.ts` → SCENE_DISPLAY_NAMES | **6** | 玩家 location.scene 的 key → 中文名 |
| 羁绊·初始门槛 | `bond/initialBonds.json` | **3** | 部分 NPC 的 encounter_threshold |
| 羁绊·亲密度档位 | `bond/affinityTiers.json` | **4** | 好感度区间与叙事提示 |
| 羁绊·关系里程碑 | `bond/milestoneTemplates.json` | **12** | 关系类型文案模板 |
| 羁绊·物是人非 | `bond/emotionalBriefTemplates.json` | **5** | 多年未见/已故/崛起等叙事模板 |

---

## 二、三国结构化数据库（sanguoDb）

### 2.1 武将（NPC）

- **路径**：`src/data/sanguoDb/raw/npcs_184.json`
- **类型**：`NPCRecord[]`（见 `types.ts`）
- **数量**：**40 条**
- **ID 范围**：2001～2040

**字段结构**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | number | ✓ | 唯一 ID，contentRegistry 以 `String(id)` 注册 |
| name | string | ✓ | 姓名 |
| birth_year | number | ✓ | 出生年 |
| death_year | number | ✓ | 卒年（部分为字符串如 "未知" 时需逻辑层兼容） |
| appear_year | number | ✓ | 登场年 |
| str | number | ✓ | 武力 |
| int | number | ✓ | 智力 |
| pol | number | ✓ | 政治 |
| lea | number | ✓ | 统率 |
| personality_traits | string[] | 否 | 性格标签，供叙事与 prompt 使用 |
| speech_style | string | 否 | 台词风格描述 |
| father_id | number \| null | ✓ | 父亲 NPC id |
| spouse_id | number \| null | ✓ | 配偶 NPC id |
| close_friends | number[] | 否 | 好友 NPC id 列表 |
| rivals | number[] | 否 | 敌对/对手 NPC id 列表 |
| current_region_id | number | ✓ | 当前所在区域 id（对应 regions） |
| owner_faction_id | number | ✓ | 所属势力 id |

**代码引用**：`getNPCsForYear(year)`、`getNPCById(id)`、`getDefaultNPCState(year)`、contentRegistry 注册 `"npc", String(npc.id)`。

---

### 2.2 区域（Region）

- **路径**：`src/data/sanguoDb/raw/regions_184.json`
- **类型**：`RegionRecord[]`
- **数量**：**16 条**
- **ID 范围**：1001～1016

**字段结构**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | number | ✓ | 唯一 ID |
| name | string | ✓ | 区域名（如「洛阳」「虎牢关」） |
| type | string | ✓ | 如「大都市」「一般」「关隘」 |
| landscape_description | string | 否 | 地貌描述，用于旅行叙事 |
| landmarks | string[] | 否 | 地标列表，供环境描写 |
| adjacent_regions | string[] | ✓ | 相邻区域名（name 列表） |
| commerce | number | ✓ | 商业值 |
| farming | number | ✓ | 农业值 |
| culture | number | ✓ | 文化值 |
| defense | number | ✓ | 防御值 |
| money | number | ✓ | 金钱资源 |
| food | number | ✓ | 粮草资源 |
| population | number | ✓ | 人口 |
| troop_count | number | ✓ | 兵力 |
| owner_faction_id | number | ✓ | 所属势力 |
| loyalty | number | ✓ | 忠诚度 |

**代码引用**：`getAllRegions(year)`、`getRegionById(id)`、`getRegionName(id)`、`getRegionByName(name)`；`logic_db.regions` 供裁决与时间解析使用。

---

### 2.3 时间线事件（Timeline）

- **路径**：`src/data/sanguoDb/raw/<年份段>_timeline.json`（见下表）
- **类型**：`TimelineEventRecord[]`，合并后按 year/month 排序
- **总数量**：**187 条**
- **年份范围**：`TIME_YEAR_MIN` 168 ～ `TIME_YEAR_MAX` 280（常量在 `timeline.ts`）

**单条事件字段结构**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| event_id | number | ✓ | 唯一 ID |
| year | number | ✓ | 年 |
| month | number | ✓ | 月 |
| event_name | string | ✓ | 事件名（如「黄巾起义爆发」） |
| summary | string | 否 | 摘要，供 LLM 叙事 |
| trigger_condition | string | 否 | 触发条件表达式 |
| hard_effects | object | 否 | 见下表 |
| narrative_hooks | string[] | 否 | 叙事钩子，供传闻与长叙事 |

**hard_effects 结构（可选）**

| 子字段 | 说明 |
|--------|------|
| npc_status.kill_list | NPC id 数组，该事件发生时视为死亡 |
| npc_status.move_list | `{ npc_id, to_region_id }[]`，NPC 迁入某区域 |
| region_changes | `{ region_id?, owner_faction_id?, loyalty? }[]`，势力/忠诚变化 |

**按文件统计**

| 文件 | 年份范围 | 事件数 |
|------|----------|--------|
| 184_189_timeline.json | 184～189 | 5 |
| 190_192_timeline.json | 190～192 | 12 |
| 193_196_timeline.json | 193～196 | 19 |
| 197_207_timeline.json | 197～207 | 29 |
| 208_210_timeline.json | 208～210 | 8 |
| 219_222_timeline.json | 219～222 | 7 |
| 222_229_timeline.json | 222～229 | 15 |
| 229_234_timeline.json | 229～234 | 5 |
| 249_263_timeline.json | 249～263 | 15 |
| 263_265_timeline.json | 263～265 | 21 |
| 265_280_timeline.json | 265～280 | 46 |
| 280_final_timeline.json | 280+ | 5 |
| **合计** | — | **187** |

**代码引用**：`getEventsInRange(fromYear, toYear)`、`getEventsInRangeWithDetails(...)`、`getRandomRumorHints(...)`、`getUpcomingRumors(currentYear, count)`。

---

## 三、配置层：区域与场景展示名（config）

玩家 `location` 使用**字符串 key**（非 DB 数字 id），与展示名在 config 中维护。

### 3.1 REGION_DISPLAY_NAMES

- **路径**：`src/config/index.ts`
- **类型**：`Record<string, string>`
- **数量**：**6 条**

| key | 展示名 |
|-----|--------|
| yingchuan | 颍川 |
| luoyang | 洛阳 |
| jingzhou | 荆州 |
| jizhou | 冀州 |
| yuzhou | 豫州 |
| zhuoxian | 涿县 |

说明：`player_state.location.region` 存的是上述 key；与 `regions_184.json` 的 16 个区域通过「名称」或后续映射关联（如洛阳 ↔ 1001）。

### 3.2 SCENE_DISPLAY_NAMES

- **路径**：`src/config/index.ts`
- **类型**：`Record<string, string>`
- **数量**：**6 条**

| key | 展示名 |
|-----|--------|
| village | 村庄 |
| city | 城内 |
| camp | 营地 |
| inn | 客栈 |
| temple | 庙宇 |
| prison | 牢狱 |

说明：`player_state.location.scene` 存的是上述 key；与 Region 组合成完整地点（如「颍川·村庄」）。

---

## 四、羁绊系统数据（bond）

### 4.1 initialBonds.json

- **路径**：`src/data/bond/initialBonds.json`
- **用途**：主角与 NPC 初始亲密度均为 0、无关系；此处仅配置**需要非零或特殊规则的 NPC**。
- **数量**：**3 个 NPC**

**结构**

```json
{
  "version": "1.0",
  "comment": "encounter_threshold：玩家恶名≥该值时拒绝会面",
  "byNpcId": {
    "2006": { "encounter_threshold": 30 },
    "2010": { "encounter_threshold": 35 },
    "2029": { "encounter_threshold": 25 }
  }
}
```

| NPC id | 说明 |
|--------|------|
| 2006 | 皇甫嵩，恶名≥30 拒见 |
| 2010 | 曹操，恶名≥35 拒见 |
| 2029 | 荀彧，恶名≥25 拒见 |

---

### 4.2 affinityTiers.json

- **路径**：`src/data/bond/affinityTiers.json`
- **用途**：好感度区间 → 档位名称与叙事提示（narrativeHint）。
- **数量**：**4 档**

**结构**

```json
{
  "version": "1.0",
  "tiers": [
    { "min": 0, "max": 20, "label": "萍水相逢", "narrativeHint": "…" },
    { "min": 21, "max": 50, "label": "相识", "narrativeHint": "…" },
    { "min": 51, "max": 75, "label": "知交", "narrativeHint": "…" },
    { "min": 76, "max": 100, "label": "莫逆", "narrativeHint": "…" }
  ]
}
```

---

### 4.3 milestoneTemplates.json

- **路径**：`src/data/bond/milestoneTemplates.json`
- **用途**：关系类型/里程碑的展示文案模板。
- **数量**：**12 条**

**结构**

```json
{
  "version": "1.0",
  "templates": [
    { "id": "sworn_brother", "text": "桃园之外，与你义结金兰" },
    { "id": "spouse", "text": "结发为夫妻，此生与共" },
    …
  ]
}
```

| id | 含义 |
|----|------|
| sworn_brother | 义结金兰 |
| spouse | 结婚 |
| father_son | 父子 |
| master_apprentice | 师徒 |
| close_friend | 知己 |
| ally | 同盟 |
| rival | 对手 |
| enemy | 仇敌 |
| first_meet | 初识 |
| save_life | 救命之恩 |
| betray | 背弃 |
| reconcile | 冰释前嫌 |

---

### 4.4 emotionalBriefTemplates.json

- **路径**：`src/data/bond/emotionalBriefTemplates.json`
- **用途**：长年未见/已故/崛起/落魄等「物是人非」叙事模板，变量如 `{name}`、`{years}`、`{deathYear}` 等。
- **数量**：**5 条** + 1 个 `eventHintDefault`

**结构**

```json
{
  "version": "1.0",
  "templates": [
    { "id": "years_separated", "pattern": "{name}：{years}年未见，{eventHint}重逢时当有物是人非之感" },
    { "id": "deceased", "pattern": "{name}：已故于{deathYear}年，再难相见" },
    { "id": "rise_to_power", "pattern": "{name}：昔日{oldStatus}，今已{newStatus}，令人感慨" },
    { "id": "fallen_from_grace", "pattern": "{name}：曾经{oldStatus}，如今{newStatus}，世事无常" },
    { "id": "longtime_companion", "pattern": "{name}：相伴{years}年，历经{eventHint}，情谊深厚" }
  ],
  "eventHintDefault": "期间历经天下大事，"
}
```

---

## 五、数据流向简图

```
npcs_184.json ──► getNPCsForYear / getDefaultNPCState ──► saveData.npcs / logic_db.npcs
regions_184.json ──► getAllRegions / getRegionByName ──► logic_db.regions / 旅行与时间解析
*_timeline.json ──► getEventsInRange / getEventsInRangeWithDetails ──► event_context / historical_summary / folk_rumors
REGION_DISPLAY_NAMES / SCENE_DISPLAY_NAMES ──► player.location 展示与意图解析
initialBonds / affinityTiers / milestoneTemplates / emotionalBriefTemplates ──► Bond 与叙事层
```

---

## 六、扩展说明

- **新增 NPC**：在 `npcs_184.json` 追加对象，id 保持唯一（建议 2041 起）；在 `bootstrapSanguoDb` 中对该 id 执行 `registerEntity("npc", String(id))`（若沿用当前注册方式）。
- **新增 Region**：在 `regions_184.json` 追加对象，id 唯一（建议 1017 起）；相邻关系填 `adjacent_regions`。若需在玩家 location 中使用，需在 config 中增加对应 key（或建立 id ↔ key 映射）。
- **新增时间线事件**：在对应年份段的 `*_timeline.json` 中追加事件对象，`event_id` 全局唯一；若需硬性改 NPC/势力，填写 `hard_effects`。
- **新增场景类型**：在 `SCENE_DISPLAY_NAMES` 中增加 key→展示名；逻辑/UI 中凡依赖 scene 枚举处需一并扩展。
- **羁绊**：新增档位或模板时修改 bond 下对应 JSON，保证 id/pattern 与代码中的使用一致。

以上为当前项目内**全部数据库与配置结构**及其统计，可直接作为开发与配置的单一参考。
