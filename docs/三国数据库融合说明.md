# 三国结构化数据库与游戏融合说明

## 一、数据来源

数据库位于 `docs/outputs_三国结构化数据库_184-280年_完整版/`，由内容 AI 构建。游戏运行时可访问的数据副本位于 `src/data/sanguoDb/raw/`。

## 二、融合方式

### 1. 时间线（Timeline）

- **原**：`src/config/worldTimeline.ts` 中手工维护的 `WORLD_TIMELINE` 数组。
- **现**：由 `src/data/sanguoDb/timeline.ts` 从数据库的 `184_189_timeline.json`、`190_192_timeline.json` 等合并后提供。
- **用法**：逻辑层 `applyHardConstraints` 在时间跳跃时，通过 `getEventsInRange(fromYear, toYear)` 获取该时段内事件，写入 `logical_results.world_changes`。

### 2. 默认 NPC

- **原**：`config/index.ts` 中写死的 `DEFAULT_NPC_STATE`（曹操、刘备 2 人）。
- **现**：调用 `getDefaultNPCState(184)`，从 `184_npc_database.json` 中 40 位武将生成默认 NPC 列表。
- **格式映射**：数据库 `NPCRecord` → 游戏 `NPCState`（id 转为字符串，location 为城池中文名）。

### 3. 实体注册（幻觉防御）

- 游戏初始化时调用 `bootstrapSanguoDb(184)`。
- 将 184 年剧本中的全部 NPC id 注册到 `contentRegistry`。
- `filterEntities("npc", npcState)` 会过滤掉未注册的 NPC，只将数据库内存在的 NPC 传给裁决 API。

### 4. 裁决请求体中的 logic_db

- `buildAdjudicationPayload` 会根据当前 `world.time.year` 调用 `getLogicDbContext(year)`。
- 请求体中新增 `logic_db` 字段，包含：
  - `regions`：该年份城池列表（id、name、type、ownerId、loyalty）。
  - `npcs`：该年份武将列表（id、name、str、int、currentRegion、personality_traits、speech_style、birth_year、death_year）。
- 服务端 / 云函数可将 `logic_db` 注入 Prompt，让 LLM 参考以修正叙事幻觉。

## 三、当前加载范围

- **184 年剧本**：regions_184.json、npcs_184.json、184_189～280_final 全部时间线 JSON。
- **其他年份**：当前实现中，regions 与 npcs 仍使用 184 年数据；可按需扩展 `getNPCsForYear`、`getAllRegions` 以支持多阶段。

## 四、约定与规范

- 数据来源与结构遵循《内容文案规范_供内容AI使用》及《三国结构化数据库使用说明》中约定。
- 工程侧只做结构映射与接入，不修改数据库中的具体文案或数值。
