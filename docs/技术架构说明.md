# 三国 LLM 文字冒险小游戏 — 技术架构说明

本文档描述当前项目的技术架构，以及各目录与核心模块的职责与协作关系。项目为**微信小游戏单端**，使用 **Canvas** 渲染、**LLM 裁决 API** 驱动剧情，严格遵循 `.cursorrules` 中的平台与合规约束。

---

## 一、整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────┐
│  微信小游戏入口 (game.ts)                                                 │
│  wx.onShow → bootstrap → initGame + gameLoop；wx.onHide → onAppHide     │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  应用薄壳 (app.ts) + 游戏主控 (app/gameApp.ts)                            │
│  对外暴露：initGame / gameLoop / handleTouch / submitInput / render 等   │
│  内部：阶段机(splash→创角→playing)、输入、裁决流程编排、渲染编排           │
└─────────────────────────────────────────────────────────────────────────┘
         │                │                │                │
         ▼                ▼                ▼                ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   core/      │  │   agents/    │  │  services/   │  │    ui/       │
│  状态/逻辑   │  │  Prompt 注册 │  │ 网络/存储/   │  │  Canvas 渲染  │
│  快照/效果   │  │  幻觉防御    │  │ 安全/音效/广告│  │  布局/输入   │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
         │                │                │                │
         └────────────────┴────────────────┴────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  data/ + config/                                                         │
│  三国数据库(NPC/区域/时间线)、行动建议、默认状态与文案配置                  │
└─────────────────────────────────────────────────────────────────────────┘
```

- **数据流**：玩家输入 → 本地指令拦截 → 快照构建 → 逻辑层预处理(preAdjudicator) → 裁决 API → 叙事+effects → effectsApplier 写回存档 → 自动存档 → 渲染更新。
- **平台约束**：无 `window`/`document`/`localStorage`，统一使用 `wx` 与 `@/utils/wxHelpers` 封装的 Canvas、触摸、键盘、网络、存储。

---

## 二、目录结构与模块职责

### 2.1 入口与应用层

| 路径 | 作用 |
|------|------|
| **game.ts** | 微信小游戏入口。仅负责：在 `wx.onShow` 时执行一次 `bootstrap()`（云环境初始化 + `initGame()` + `gameLoop()`），在 `wx.onHide` 时调用 `onAppHide()`，在 `wx.onError` 时打日志。 |
| **app.ts** | 应用薄壳。对外 re-export `gameApp` 的公开 API（如 `initGame`、`gameLoop`、`handleTouch`、`submitInput`、`restartGame`、`manualSave`、`loadLatestSave`、`render` 等）及类型，供 `game.js` 或外部调用。 |
| **app/gameApp.ts** | 游戏主控与运行时。维护全局 `runtime`（Canvas、布局、阶段、存档引用、对话历史、输入状态、是否裁决中、打字机、滚动等），实现初始化、主循环、触摸/键盘分发、阶段切换（splash → characterCreation → playing）、**本地指令处理**（帮助/存档/读档/属性/广告/反馈/重试）、**裁决流程编排**（构建请求→调用 API→打字机播完→应用 effects→存档→更新建议动作与音效）、渲染编排。不实现具体快照构建与 effects 解析，委托给 `core/` 与 `app/adjudicationFlow.ts`。 |
| **app/adjudicationFlow.ts** | 裁决流程纯逻辑。提供：`buildAdjudicationRequest`（基于 snapshot）、`applyPlayerStateChanges` / `applyNpcRelationEffects`（写回玩家/NPC 状态）、`applyTypewriterCompletion`（打字机播完后统一应用 state_changes/effects、存档、同步建议动作与音效）、`handleAdjudicationResult`（叙事安全过滤、追加对话、滚动、触发打字机或直接完成）。入参显式传 `saveData`/`dialogueHistory` 或通过窄接口注入，便于单测与 gameApp 瘦身。 |
| **app/lifecycle.ts** | 生命周期与存读档编排。定义何时加载存档（`loadLatestSave`）、何时手动存档（`manualSave`）、何时在切出时存档（`onAppHide`）。具体读写委托给 `saveManager`，由调用方注入 `syncFromSave`、`appendDialogue`、`render` 等。 |
| **app/localIntents.ts** | 本地指令识别。纯函数：`getLocalIntentType(input)` 判断是否为帮助/存档/读档/关于/广告/反馈/属性/重试等；`getLastPlayerIntent(dialogueHistory)` 从历史中取最后一条玩家意图。不依赖 runtime，便于单测。 |
| **app/typewriter.ts** | 打字机效果。逐字显示叙事文案，支持点击跳过；支持「长叙事模式」（略快速度 + 段落间 500ms 停顿）。由 gameApp 在收到裁决叙事时启动，播完后通过 `applyTypewriterCompletion` 应用效果并刷新。 |

---

### 2.2 核心逻辑层 (core/)

| 路径 | 作用 |
|------|------|
| **state.ts** | 游戏状态类型定义。包括：`PlayerState`（属性、体力、志向、位置、资源等）、`WorldState`（时代、时间、区域状态、flags）、`NPCState`（与玩家好感、关系、Bond 羁绊、relations 等）、`GameSaveData`、`Bond`、`WorldTime`、年龄常量（出仕/义结金兰/结婚 15 岁）等。 |
| **stateMachine.ts** | 阶段/状态机相关（若存在则负责 phase 转移规则，与 gameApp 中的 `phase` 配合）。 |
| **snapshot.ts** | **构建裁决用世界快照**。`buildAdjudicationPayload(saveData, playerIntent, recentDialogue)`：在传入的 saveData 上应用 Bond 衰减、按 contentRegistry 过滤 NPC、过滤已故武将、注入 `event_context`（近期对话、对话轮数超阈值时的摘要提示、首段独白提示、叙事安全与关系规则等），返回 `AdjudicationRequest`。纯函数、无副作用，供 adjudicationFlow 与云端请求使用。 |
| **actionProcessor.ts** | 玩家动作逻辑层入口。`processPlayerAction(payload)` 先通过 `timeParser` 解析意图中的时间消耗，再经 `preAdjudicator.applyHardConstraints` 对请求做硬约束（时间推进、不可能判定等），返回处理后的 `AdjudicationRequest`。 |
| **timeParser.ts** | 从玩家意图文本解析「动作消耗月数」（如「行军 2 月」「闭关十年」），供 actionProcessor / preAdjudicator 使用。 |
| **preAdjudicator.ts** | **逻辑层预处理**。根据玩家意图解析时间跨度、修炼/旅行/战斗/远征等类型，推进 `world_state.time`，写入 `logical_results`（如 `time_passed`、`new_time`、`world_changes`、`attribute_gained`、`audio_trigger`）；对不可能实现（如击杀已故武将、超出时间线）写入 `logic_override`，强制 LLM 描写失败。保证叙事与既定事实一致。 |
| **effectsApplier.ts** | **裁决 effects 解析与应用**。`computePlayerStateDelta(changes)` 解析 effects 字符串（如 `strength+5`、`legend+10`）为玩家属性/资源/传奇/声望增量；`applyNpcRelationEffects(saveData, effects, year)` 解析 NPC 好感与关系变更并写回 `saveData.npcs`，并委托 RelationManager 更新 Bond 的 `last_seen`。义结金兰/结婚会校验双方满 15 岁。 |
| **contentRegistry.ts** | **幻觉防御**。维护 Prompt 注册表与实体注册表（如 NPC id）。`filterEntities(type, items)` 过滤掉未注册的实体，仅把已注册实体传给 LLM；快照构建时用其过滤 NPC 列表。 |
| **BondSystem.ts** | 羁绊系统。基于 NPCRecord 做初始关系导入（`importFromRecords`）；按世界时间对 `saveData.npcs` 应用亲密度衰减（`applyDecay`），衰减后把 `bond.affinity` 同步到 `player_favor`。与 RelationManager 配合。 |
| **RelationManager.ts** | 人际关系管理。提供 `ensureBond`、`createDefaultBond`、`touchLastSeen`（见面时更新 last_seen_world_time）、`initializeRelationsFromRecord`（从 NPCRecord 血缘/配偶/好友/敌对初始化 NPCState.relations）。 |
| **relationshipRules.ts** | 年龄与关系规则。`getAge`、`canServe`（满 15 岁可出仕）、`canSwornBrother`、`canMarry`，及关系类型中文标签。被 effectsApplier、preAdjudicator、sanguoDb 等使用。 |

---

### 2.3 代理与提示词 (agents/)

| 路径 | 作用 |
|------|------|
| **prompts.ts** | System Prompt 与各类提示词注册。通过 `registerPrompt` 写入 contentRegistry；定义 `PROMPT_KEYS`（SYSTEM、SAFETY、NEW_PLAYER、REPUTATION_PERSONA 等），`bootstrapDefaultPrompts()` 注册名望与称呼等默认文案。实际裁决用的完整 Prompt 在云端/云函数中组装，此处为客户端可插拔的提示词片段与注册入口。 |

---

### 2.4 服务层 (services/)

| 路径 | 作用 |
|------|------|
| **network/adjudication.ts** | 裁决 API 调用。定义 `AdjudicationRequest` / `AdjudicationResponse`、`LogicalResults`、`LogicOverride`、`LogicDbContext`；在微信环境下优先 `wx.cloud.callFunction("adjudication", data)`，不可用时走 HTTP `ADJUDICATION_API`；支持重试与超时，返回叙事、effects、state_changes、suggested_actions、audio_trigger 等。 |
| **storage/saveManager.ts** | 存档管理。封装 `wx.setStorageSync`（或内存 fallback）；实现 load(slot)、save(saveData, isAuto)、createNewSave(slot, name)；版本号与迁移（如对话年份 168→184）；自动存档与手动存档共用同一写入路径。 |
| **security/contentGuard.ts** | 内容安全。本地敏感词表拦截；玩家输入送审前调用 `wx.security.msgSecCheck`；叙事侧 `sanitizeNarrative` 做轻量替换（如易触发审核的短语）并 strip 替换字符，降低审核拒绝率。 |
| **security/feedbackLogger.ts** | 反馈与审核日志。记录裁决失败、 sanitize 失败等，便于灰度与排查；`getLatestFeedbackSnapshot` 供反馈入口使用。 |
| **audio/ambientAudio.ts** | 环境音效。根据裁决返回的 `audio_trigger`（如 war/history/calm）播放对应氛围音，需适配微信音频 API。 |
| **ads/rewardedAd.ts** | 激励视频广告。在剧情高潮、体力不足、传奇/金币提升等时机调用 `requestRewardedAd(trigger)`，内部检测 `wx.createRewardedVideoAd` 可用性并做优雅降级。 |

---

### 2.5 渲染与交互 (ui/)

| 路径 | 作用 |
|------|------|
| **layout.ts** | 动态布局。根据 `wx.getSystemInfoSync()` 的宽高与安全区域计算 `UILayout`：状态栏区、对话区、行动引导槽、输入区等矩形与边距，适配刘海屏与不同分辨率。 |
| **theme.ts** | 主题常量。颜色、圆角、字号、按钮尺寸等（如 `sizes.restartBtnWidth`），供 renderer 与 gameApp 点击检测一致使用。 |
| **primitives.ts** | Canvas 绘图原语。如圆角矩形、文字换行测量与绘制等，被 renderer 使用。 |
| **renderer.ts** | 主渲染器。根据 `RenderState` 绘制：状态面板（属性、地点、时间、重新开始）、对话区（气泡、滚动、高度缓存）、行动引导芯片、输入框与占位符。支持离屏缓冲、对话区高度缓存与滚动；暴露 `lastDialogueTotalHeight`、`invalidateDialogueCache`、`getRestartButtonRect`、`getActionGuideChipRects` 等供 gameApp 触摸判定。 |
| **input.ts** | 输入状态。维护 `InputState`（value、isKeyboardVisible）及 `setInputValue`、`clearInput`、`setKeyboardVisible`，与 wx 键盘事件配合。 |
| **splash.ts** | 启动页。布局与绘制 splash 界面，点击后进入创角或游玩。 |
| **characterCreation.ts** | 创角界面。布局、表单项（姓名、性别、志向等）、触摸区域与绘制，创角完成后写入 `player` 并进入 playing。 |

---

### 2.6 数据与配置 (data/ + config/)

| 路径 | 作用 |
|------|------|
| **config/index.ts** | 客户端配置。默认玩家/世界/NPC 状态、开局文案（志向专属开场）、游戏提示、云环境 ID、裁决 API 地址、请求超时与重试、叙事安全说明等。 |
| **config/worldTimeline.ts** | 世界时间线事件。按年份区间提供大事记，供 preAdjudicator 写入 `logical_results.world_changes` 与叙事上下文。 |
| **data/sanguoDb/** | 三国结构化数据库。`npcs`、`regions`、`timeline`、`types`；raw 目录下为按年份切分的 NPC/区域/时间线 JSON。`bootstrapSanguoDb(year)` 向 contentRegistry 注册 NPC、返回默认 NPC 列表与区域摘要；`getLogicDbContext(year)` 返回供裁决请求使用的 `LogicDbContext`（城池、武将及年龄/can_serve 等），用于 LLM 叙事与幻觉修正。 |
| **data/actionSuggestions.ts** | 默认行动建议文案。当云端未返回 suggested_actions 时，由前端使用的兜底建议列表。 |

---

### 2.7 工具 (utils/)

| 路径 | 作用 |
|------|------|
| **wxHelpers.ts** | 微信 API 封装。Canvas 创建、getSystemInfo、触摸/键盘事件（onTouchStart/Move/End、onKeyboardInput/Confirm/Complete）、requestAnimationFrame、request（网络）等，统一处理 wx 与非 wx 环境，便于单测与多端占位。 |
| **dialogueBuffer.ts** | 对话缓冲。`appendDialogue`、`removeLast` 等，对 `dialogueHistory` 的增删封装，与存档中的对话历史同步使用。 |
| **network/request.ts** | 网络请求封装（若存在则用于 HTTP 裁决或其它接口）。 |

---

### 2.8 构建与发布

| 路径 | 作用 |
|------|------|
| **scripts/build.js** | 一键构建。使用 esbuild 将 `game.ts`、`app.ts`、`config/index.ts`、`saveManager.ts` 分别打包为 `game.min.js`、`main.min.js`、`config.min.js`、`save.min.js`，输出到 `dist/` 并同步到根目录；复制 `game.json`、`project.config.json` 等；支持 `--watch` 与环境变量（如 `CLOUD_ENV`、`ADJUDICATION_API`）。 |
| **game.json** | 小游戏主配置（入口、分包等）。 |
| **project.config.json** | 微信开发者工具项目配置。 |

---

## 三、关键数据流简述

1. **玩家输入**  
   `submitInput` → 本地指令判断（localIntents）→ 若为本地指令则执行帮助/存档/读档等并 return；否则进入裁决流程。

2. **裁决请求构建**  
   `buildAdjudicationRequest(saveData, intent)` → `buildAdjudicationPayload`（snapshot）：应用 Bond 衰减、过滤 NPC、注入 event_context、获取 logic_db → `processPlayerAction(payload)`：时间解析 + preAdjudicator 硬约束 → 得到最终 `AdjudicationRequest`。

3. **裁决调用与结果**  
   `callAdjudication(payload)`（云函数或 HTTP）→ 返回 `AdjudicationResponse`（narrative、effects、state_changes、suggested_actions、audio_trigger）→ 叙事经 contentGuard.sanitizeNarrative → 追加对话、滚动、启动打字机。

4. **打字机完成**  
   `applyTypewriterCompletion`：应用 state_changes 与 effects（effectsApplier）、更新世界状态、自动存档、syncFromSave、更新建议动作、根据效果触发激励广告、播放环境音效。

5. **存档**  
   自动存档在每次裁决效果应用后；手动存档与切出存档由 lifecycle + saveManager 完成；读档后通过 `syncFromSave` 把 `currentSaveData` 同步到 runtime（对话、属性等）并刷新界面。

---

## 四、与 .cursorrules 的对应关系

- **目录与模块化**：`/src/agents` 负责 LLM 与 Prompt；`/src/core` 负责状态机、数值、实体注册与逻辑预处理；`/src/ui` 负责 Canvas 与交互；`/src/utils` 含 wx 封装；`/assets` 管理静态资源。
- **LLM 与幻觉防御**：双轨输出由云端实现；客户端通过 contentRegistry 过滤实体、logic_db 注入事实；preAdjudicator 约束时间与不可能事件。
- **状态快照**：由 snapshot 构建压缩版 WorldState，不发送全量历史。
- **动态排版与打字机**：layout 基于 getSystemInfo 计算；renderer 负责文字与气泡；typewriter 负责逐字与跳过。
- **生命周期与持久化**：lifecycle + saveManager，onAppHide 存档；可扩展断点重连与上下文滑动窗口。
- **内容安全**：contentGuard 本地过滤 + msgSecCheck，提示词在云端做安全边界。
- **成本与变现**：localIntents 拦截基础指令；rewardedAd 在指定时机触发；广告与支付可抽象为 Service。

---

## 五、羁绊系统在架构中的位置与接入方式

羁绊系统已按「核心逻辑在 core、数据在 state、读写在裁决链路」接入，无需改 gameApp 主流程即可生效。

### 5.1 在架构中的位置

- **数据结构**：`core/state.ts` 中 `Bond`、`WorldTime`，以及 `NPCState.bond`、`NPCState.player_favor`（与 bond.affinity 同步）。存档里 `GameSaveData.npcs[].bond` 持久化。
- **核心逻辑**：
  - **BondSystem.ts**：批量能力——`applyDecay`（按世界时间做亲密度衰减）、`importFromRecords`（新档/重置时给 NPC 挂 Bond）、`getEmotionalBrief`（时间跨度大时生成「物是人非」情感简报供叙事注入）。
  - **RelationManager.ts**：单 NPC 能力——`ensureBond`、`createDefaultBond`、`touchLastSeen`（见面刷新时间）、`updateAffinity`（增减亲密度并可选写里程碑）。
- **接入点**（已接入）：
  1. **快照前**：`snapshot.buildAdjudicationPayload` 内先调 `applyDecay(saveData)`，再组请求。
  2. **效果应用**：`effectsApplier.applyNpcRelationEffects` 在解析 `npc_*_favor` / `npc_*_relation` 时调用 `ensureBond`、同步 `bond.affinity` 与 `player_favor`、`touchLastSeen`。
  3. **时间跨度叙事**：`preAdjudicator` 在时间步进超过 1 年时调 `getEmotionalBrief`，将结果放入 `event_context.bond_emotional_brief` 供云端叙事使用。

### 5.2 若要从零接入或扩展

- **新档是否预挂 Bond**：当前默认 NPC 列表来自 `config` 的 `getDefaultNPCState(year)`，未带 Bond；首次与某 NPC 互动时由 effectsApplier 内 `ensureBond` 创建。若希望所有 NPC 开局就有 Bond（affinity 0），可在创建新档时改用 `BondSystem.getDefaultNPCStateWithBonds(year)` 作为初始 `npcs`。
- **扩展羁绊**：在 `state.ts` 的 `Bond` 上增加字段（如下文「羁绊系统设计与数据结构」）；在 RelationManager/BondSystem 中增加对应读写与衰减/简报逻辑；在裁决请求的 `event_context` 或 `npc_state` 中把新字段带给云端即可。

更细的数据结构约定与 effect 协议见 **《羁绊系统设计与数据结构》**（`docs/羁绊系统设计与数据结构.md`）。

以上即为当前项目的技术架构与各模块职责说明，便于新人上手与后续扩展时保持边界清晰。
