# 羁绊系统 — 数据规范与编入约定

本文档约定**分工**与**数据格式**：  
- **数据方（另一个 AI）**：只编写、产出羁绊相关的**数据文件**（如 JSON），不写业务逻辑代码。  
- **编入方（负责接入的 AI/人）**：负责把数据方产出的数据**编入**到现有羁绊系统代码里（读取、校验、在适当时机注入或使用）。

---

## 一、分工说明

| 角色 | 职责 | 不负责 |
|------|------|--------|
| **数据方** | 按本规范产出羁绊相关数据文件（格式、路径、Schema 见下）；可新增/修改 `src/data/bond/` 下的 JSON 等数据文件。 | 不修改 `core/`、`app/`、`services/` 等业务代码；不写读取或注入数据的 TypeScript 逻辑。 |
| **编入方** | 在代码中读取数据方提供的数据文件，在**新档创建、Bond 初始化、情感简报、UI 展示**等时机使用或注入；保证类型安全与旧档兼容。 | 不替数据方编写具体剧情/文案内容；只做「把已有数据接进系统」。 |

数据方交付数据后，由编入方完成接入；若数据格式或路径有变更，以本规范为准，编入方按规范实现读取与注入。

---

## 二、数据存放位置与命名

- **根目录**：`src/data/bond/`（与 `sanguoDb` 平级）。  
- **文件命名**：仅使用以下约定文件名，便于编入方统一读取；数据方只在这些文件中编写内容。

| 文件名 | 用途 | 编入方使用时机 |
|--------|------|----------------|
| `initialBonds.json` | 部分 NPC 开局时的羁绊/好感初始值（可选覆盖默认 0） | 新档创建、或 getDefaultNPCStateWithBonds 时合并 |
| `affinityTiers.json` | 亲密度区间与等级/称呼（如 0–20 萍水相逢、21–50 相识） | UI 展示、或注入 event_context 供叙事称呼 |
| `milestoneTemplates.json` | 里程碑/关键事件的可选文案模板（供叙事或下拉选用） | 关系升级或服务端 effect 引用、本地展示 |
| `emotionalBriefTemplates.json` | 情感简报（久别重逢、物是人非）的句子模板或变量规则 | getEmotionalBrief 或云端叙事参考 |

以上文件均为**可选**：数据方可根据需求只产出其中部分；编入方在对应文件存在时读取并接入，不存在时使用代码内默认逻辑。

---

## 三、数据 Schema（数据方必须遵守）

### 3.1 initialBonds.json

用于指定**部分 NPC** 在**新档开局**时的羁绊初始值（其余 NPC 仍为 0 或由代码默认）。

```json
{
  "version": "1.0",
  "comment": "npc_id 为字符串，与 NPCState.id 一致；仅列出需要非零初始值的 NPC",
  "byNpcId": {
    "2001": {
      "affinity": 10,
      "milestones": ["曾在市集有一面之缘"]
    },
    "2002": {
      "affinity": 0,
      "player_relation": "acquaintance",
      "milestones": []
    }
  }
}
```

- **byNpcId**：键为 NPC 的 `id`（字符串，与 `NPCState.id`、sanguoDb 中的 id 一致）。  
- 每项可选字段：  
  - **affinity**：0～100，开局亲密度。  
  - **player_relation**：`""` | `"acquaintance"` | `"sworn_brother"` | `"spouse"`，开局关系。  
  - **milestones**：字符串数组，开局即有的关键记忆，建议不超过 5 条。  
- 未出现在 `byNpcId` 中的 NPC，编入方按现有逻辑处理（affinity 0、无 relation）。

### 3.2 affinityTiers.json

亲密度区间与等级/称呼，供 UI 或叙事按区间取文案。

```json
{
  "version": "1.0",
  "tiers": [
    { "min": 0, "max": 20, "label": "萍水相逢", "narrativeHint": "称呼可带疏离" },
    { "min": 21, "max": 50, "label": "相识", "narrativeHint": "可称壮士、义士" },
    { "min": 51, "max": 75, "label": "知交", "narrativeHint": "可称将军、阁下" },
    { "min": 76, "max": 100, "label": "莫逆", "narrativeHint": "可称明公、主公" }
  ]
}
```

- **tiers**：按 `min` 升序排列；区间不重叠、覆盖 0～100。  
- **label**：等级名称（UI 或简短展示）。  
- **narrativeHint**：可选，供注入 event_context 给 LLM 参考的称呼/语气提示。

### 3.3 milestoneTemplates.json

里程碑或关键事件的**文案模板**列表；可由裁决或本地在关系升级等时机选用。

```json
{
  "version": "1.0",
  "templates": [
    { "id": "sworn_brother", "text": "桃园之外，与你义结金兰" },
    { "id": "spouse", "text": "结发为夫妻，此生与共" },
    { "id": "first_meet", "text": "初识于乱世，一见如故" }
  ]
}
```

- **id**：可选，便于 effect 或代码引用。  
- **text**：一条完整短句，会写入 `bond.milestones` 或供叙事使用；需符合内容安全与长度限制（编入方可做截断与过滤）。

### 3.4 emotionalBriefTemplates.json

「久别重逢 / 物是人非」类情感简报的模板；用于替换或补充 BondSystem.getEmotionalBrief 的默认拼接逻辑。

```json
{
  "version": "1.0",
  "templates": [
    {
      "id": "years_separated",
      "pattern": "{name}：{years}年未见，{eventHint}重逢时当有物是人非之感"
    },
    {
      "id": "deceased",
      "pattern": "{name}：已故于{deathYear}年，再难相见"
    }
  ],
  "eventHintDefault": "期间历经天下大事，"
}
```

- **pattern**：占位符用 `{name}`、`{years}`、`{eventHint}`、`{deathYear}` 等，由编入方在 getEmotionalBrief 或等价逻辑中替换。  
- **eventHintDefault**：无事件列表时的默认 eventHint。

数据方只需保证 JSON 合法、字段名与类型符合上表；编入方负责实现占位符替换与默认值。

---

## 四、编入方职责摘要（供你/接入 AI 使用）

编入方在拿到数据方交付的 `src/data/bond/` 下文件后，将完成至少以下工作（具体实现以代码为准）：

1. **读取与校验**  
   在合适模块（如 `src/data/bond/` 下新建 `index.ts` 或 `loaders.ts`）中读取上述 JSON；校验 version、必填字段与数值范围；缺失文件时回退到代码内默认行为。

2. **initialBonds 注入**  
   在新档创建或 getDefaultNPCStateWithBonds 时：若存在 `initialBonds.json`，则对 `byNpcId` 中列出的 NPC 应用初始 affinity / player_relation / milestones，再交给 BondSystem/RelationManager 的既有逻辑；未列出的 NPC 不变。

3. **affinityTiers 使用**  
   若存在 `affinityTiers.json`，提供按 affinity 查 tier 的接口（如 getAffinityTier(affinity)）；在 UI 或构建 event_context 时使用 label / narrativeHint。

4. **milestoneTemplates 使用**  
   若存在 `milestoneTemplates.json`，在关系升级或解析 `npc_{id}_milestone=...` effect 时，可按 id 或随机选用一条写入 bond.milestones；并做条数上限与安全过滤。

5. **emotionalBriefTemplates 使用**  
   若存在 `emotionalBriefTemplates.json`，在 getEmotionalBrief 或等价逻辑中，用 pattern 与占位符生成文案，替换或补充当前硬编码字符串。

6. **兼容与安全**  
   旧存档不因新数据文件而报错；新数据字段缺失时用默认值；写入叙事或 milestones 的文案经 contentGuard 或等价安全过滤。

---

## 五、数据方交付清单（给「只编数据的 AI」）

请你**只做以下事情**：

1. 在项目中创建目录 **`src/data/bond/`**（若不存在）。  
2. 根据需求在下列文件中**只编写数据内容**（不写 TS/JS 逻辑）：  
   - `initialBonds.json` — 按 3.1 Schema 填写需要非零开局羁绊的 NPC。  
   - `affinityTiers.json` — 按 3.2 填写亲密度区间与称呼。  
   - `milestoneTemplates.json` — 按 3.3 填写里程碑模板。  
   - `emotionalBriefTemplates.json` — 按 3.4 填写情感简报模板。  
3. 保证 JSON 合法、字段名与类型符合第三节中的 Schema；不修改 `core/`、`app/`、`config/` 等业务代码。  
4. 交付时说明：已提供哪些文件名；若有 id 或 key 的引用关系（如 effect 中引用 milestone 的 id），可一并列出便于编入方对接。

**编入**（读取、校验、在游戏中注入或使用这些数据）由另一方完成；你只需按本规范产出数据文件即可。
