# 游戏数据库说明

本文档描述项目中「数据库」的组成、关系与当前状态。游戏未使用独立数据库服务，所有静态数据以 **JSON 文件 + TypeScript 类型** 形式存放在工程内，构建时打入小游戏包。

---

## 一、总体结构

| 模块 | 路径 | 用途 |
|------|------|------|
| **三国结构化库（sanguoDb）** | `src/data/sanguoDb/` | 武将、区域、时间线事件等世界基础数据 |
| **羁绊配置（bond）** | `src/data/bond/` | 开局羁绊、亲密度档位、里程碑/情感简报模板 |

**关系概览**：

- **武将（NPC）** 通过 `current_region_id` 关联到 **区域（Region）**；通过 `father_id`、`spouse_id`、`close_friends`、`rivals` 关联到其他武将。
- **时间线事件** 通过 `npc_id`、`region_id` 等引用武将与区域，驱动叙事与状态变化。
- **羁绊** 通过 `byNpcId` 的键（NPC 的 `id` 字符串）与武将一一对应，仅影响**玩家与该武将**的初始亲密度与关系。

---

## 二、三国结构化库（sanguoDb）

### 2.1 类型定义

**文件**：`src/data/sanguoDb/types.ts`

- **RegionRecord**：区域一条记录（id、name、type、相邻区域、经济/农业/文化/防御、钱粮人口兵力、归属势力、忠诚等）。
- **NPCRecord**：武将一条记录（见下表）。
- **TimelineEventRecord**：时间线事件一条记录（event_id、year、month、event_name、summary、trigger_condition、hard_effects、narrative_hooks）。

### 2.2 武将（NPC）

**数据文件**：`src/data/sanguoDb/raw/npcs_184.json`  
**加载与接口**：`src/data/sanguoDb/npcs.ts`（`getNPCsForYear`、`getNPCById`、`npcRecordToState`、`getDeceasedNPCsInRange`）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 唯一标识，与 `NPCState.id`（字符串）一致，如 2001、2019 |
| name | string | 显示名，如「张角」「刘备」 |
| birth_year / death_year | number | 出生/卒年，用于年龄与逝世判定 |
| appear_year | number | 登场年份 |
| str, int, pol, lea | number | 武/智/政/统四维 |
| personality_traits | string[] | 性格标签，如 ["野心勃勃","善于蛊惑"] |
| speech_style | string | 说话风格描述，供叙事参考 |
| father_id | number \| null | 父亲 NPC 的 id，空表示无 |
| spouse_id | number \| null | 配偶 NPC 的 id |
| close_friends | number[] | 好友 NPC 的 id 列表 |
| rivals | number[] | 敌对/对手 NPC 的 id 列表 |
| current_region_id | number | 当前所在区域 id，对应 regions 表 |
| owner_faction_id | number | 所属势力 id |

**关系**：

- `current_region_id` → `regions_184.json` 的 `id`，通过 `getRegionName(id)` 得到展示用名称（如「洛阳」）。
- `father_id` / `spouse_id` / `close_friends` / `rivals` → 其他 NPC 的 `id`，用于初始化 NPC 间关系与羁绊（RelationManager、BondSystem）。

**当前规模**：约 40 条武将记录（184 年前后），覆盖主要势力与名将。

### 2.3 区域（Region）

**数据文件**：`src/data/sanguoDb/raw/regions_184.json`  
**加载与接口**：`src/data/sanguoDb/regions.ts`（`getRegionById`、`getRegionName`、`getAllRegions`）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 唯一标识，如 1001（洛阳）、1002（邺城） |
| name | string | 区域名称，如「洛阳」「许昌」 |
| type | string | 类型，如「大都市」「一般」 |
| adjacent_regions | string[] | 相邻区域名称 |
| commerce, farming, culture, defense | number | 商业/农业/文化/防御数值 |
| money, food, population, troop_count | number | 金钱、粮草、人口、兵力 |
| owner_faction_id | number | 归属势力 id |
| loyalty | number | 忠诚度 |

**关系**：NPC 的 `current_region_id` 指向本表 `id`；时间线事件的 `region_id` / `region_changes` 也引用本表。

**当前规模**：约 16 个区域，NPC 实际使用其中约 12 个 id。

### 2.4 时间线事件（Timeline）

**数据文件**：`src/data/sanguoDb/raw/` 下按年份切分的 JSON，如：

- `184_189_timeline.json`、`190_192_timeline.json`、…、`280_final_timeline.json`

**加载与接口**：`src/data/sanguoDb/timeline.ts`（`getEventsInRange`、`getEventsInRangeWithDetails`、`getRandomRumorHints`）

| 字段 | 类型 | 说明 |
|------|------|------|
| event_id | number | 事件唯一 id |
| year, month | number | 发生年月 |
| event_name | string | 事件名称，如「黄巾起义爆发」 |
| summary | string | 简述，供叙事使用 |
| trigger_condition | string | 触发条件描述 |
| hard_effects | object | 硬性效果，如 npc 移动、区域归属与忠诚变化 |
| narrative_hooks | string[] | 叙事钩子，供 LLM 生成剧情 |

**关系**：`hard_effects` 内可含 `npc_id`、`to_region_id`、`region_id` 等，与 NPC、Region 表对应。

**时间跨度**：约 168～280 年，事件按年月排序后统一使用。

---

## 三、羁绊配置（bond）

**目录**：`src/data/bond/`  
**加载与接口**：`src/data/bond/index.ts`

### 3.1 initialBonds.json（开局羁绊）

- **用途**：新档创建时，为**部分** NPC 覆盖「玩家与该武将」的初始亲密度、关系类型、记忆碎片。
- **键**：`byNpcId`，键为 NPC 的 `id`（字符串，与 `npcs_184.json` 的 id 一致）。
- **每项可选**：`affinity`（0～100）、`player_relation`（"" | "acquaintance" | "sworn_brother" | "spouse"）、`milestones`（字符串数组）。
- **当前状态**：`byNpcId` 已清空为 `{}`，即**主角与所有人初始均为 0 亲密度、无关系**；未出现在表中的 NPC 本就走默认 0/无关系。

### 3.2 affinityTiers.json（亲密度档位）

- **用途**：将 0～100 的亲密度划分为若干档位（如萍水相逢、相识、知交、莫逆），供 UI 展示与叙事语气（narrativeHint）使用。
- **结构**：`tiers` 数组，每项含 `min`、`max`、`label`、`narrativeHint`。

### 3.3 milestoneTemplates.json（里程碑文案模板）

- **用途**：关系升级或写入关键记忆时，按 id 选用一条短句（如义结金兰、结为夫妻等）。
- **结构**：`templates` 数组，每项含 `id`、`text`。

### 3.4 emotionalBriefTemplates.json（情感简报模板）

- **用途**：时间跨度较大时，生成「久别重逢/物是人非」类句子，供叙事注入；支持占位符如 `{name}`、`{years}`、`{eventHint}`、`{deathYear}`。
- **结构**：`templates` 数组（含 `id`、`pattern`），以及顶层 `eventHintDefault`。

**与 sanguoDb 的关系**：羁绊的 key 必须与 `NPCRecord.id` 一致（转为字符串），否则不会生效；不依赖区域或时间线表。

---

## 四、数据流与使用时机

1. **启动 / 新档**：读取 `npcs_184`、`regions_184`，经 `initBondEngine(year)` 生成带 Bond 与 NPC 间关系的 `NPCState[]`；再根据 `initialBonds.json` 的 `byNpcId` 覆盖部分 NPC 的初始羁绊（当前为空，故无人被覆盖）。
2. **裁决与叙事**：快照与云函数会带入当前 NPC 列表、区域、时间线事件、羁绊档位与情感简报模板，供 LLM 生成剧情与 suggested_actions。
3. **时间推进**：时间线事件用于历史摘要、世界变迁与情感简报；NPC 的 `birth_year`/`death_year` 用于年龄与逝世判定。

---

## 五、当前状态小结

| 项目 | 状态 |
|------|------|
| 武将数量 | 约 40（npcs_184.json） |
| 区域数量 | 约 16（regions_184.json） |
| 时间线 | 多段 JSON 覆盖约 168～280 年 |
| 主角与 NPC 初始关系 | 全部 0 亲密度、无关系（byNpcId 为空） |
| 羁绊档位与模板 | 已配置，供 UI 与叙事使用 |

如需扩展武将或区域，只需在对应 JSON 中按现有 Schema 追加记录，并保证 id 不重复、外键（如 `current_region_id`、`father_id`）指向已有 id 即可。
