# 如何抓取裁决请求的 event_context 与返回的 result.narrative

排查「object Object」、叙事异常或提示词问题时，需要看到**发给云函数的 event_context** 和 **返回的 result.narrative**。按下面方式即可抓到并贴出来。

---

## 一、打开 DEBUG 日志

项目已在 **DEBUG 模式** 下自动打这两类日志：

1. **请求发出前**：`[adjudication] request event_context（可复制到控制台查看）:` 后面跟完整 `event_context` 的 JSON。
2. **响应返回后**：`[adjudication] response result.narrative 类型:` 后面跟 `narrative` 的类型和前 300 字（若为对象会 JSON 序列化后截断）。

DEBUG 默认开启条件：`NODE_ENV !== "production"`（本地 `npm run build` 或开发时通常已是 DEBUG）。  
若需在**真机构建**里也看日志，可在构建前设环境变量，例如：

```bash
NODE_ENV=development npm run build
```

或在 `src/config/index.ts` 里临时把 `ClientConfig.DEBUG` 改为 `true` 再构建。

---

## 二、在哪里看日志

### 1. 微信开发者工具（推荐）

1. 用微信开发者工具打开项目，预览/真机调试均可。
2. 打开 **控制台**（Console）面板。
3. 在游戏里**输入一条意图并发送**，触发一次裁决请求。
4. 在控制台里搜索 `[adjudication]`：
   - **request event_context**：即本次请求的 `event_context`，可展开或复制整段 JSON。
   - **response result.narrative**：即本次返回的 `narrative` 类型和内容预览。

复制时可直接选中控制台里该条日志的输出内容，右键复制，或从「复制对象」等菜单拿到 JSON 字符串。

### 2. 真机 + vConsole（手机上看）

若在真机上跑且没有连电脑控制台：

1. 在项目里接入 **vConsole**（或你们已有的移动端调试面板）。
2. 构建时保证 DEBUG 为 true（见上一节）。
3. 真机打开小游戏，打开 vConsole 的 Console 面板。
4. 触发一次裁决（发一条意图），在 Console 里同样搜 `[adjudication]`，即可看到 event_context 和 narrative 的日志，长按可复制。

### 3. 云函数日志（只看服务端返回时）

若只想确认**云函数实际返回了什么**（例如怀疑被截断或格式异常）：

1. 打开微信开发者工具 → 云开发 → 云函数 → 选择 **adjudication**。
2. 在「日志」里查看最近调用；云函数里已有 `console.log("[adjudication] LLM 返回长度:", ...)` 等。
3. 若要看完整返回内容，可在云函数 `parseLLMOutput` 之后临时加一行把 `content` 或 `narrative` 打出来（注意不要打敏感信息）。

---

## 三、贴出来时建议带上的信息

把下面几样一起贴出来，方便继续查：

1. **event_context 的完整 JSON**  
   从 `[adjudication] request event_context` 那条日志里复制；若太长可先贴前半部分或关键键（如 `destiny_goal`、`narrative_instruction`、`playstyle_context` 等）。
2. **result.narrative 的类型和内容**  
   从 `[adjudication] response result.narrative 类型:` 那条复制；若类型是 `object`，把后面 JSON 序列化出来的那段也贴上。
3. **当时操作**  
   例如：刚输入「前往洛阳」、或「查看身体状况」、是否刚设过志向等，便于复现。

---

## 四、相关代码位置

- 请求 payload 构建：`src/core/snapshot.ts`（`buildAdjudicationPayload`）、`src/core/eventContextPipeline.ts`（`buildSnapshotInstructions`）。
- 打 DEBUG 日志：`src/app/gameApp.ts` 中调用 `callAdjudication` 前后。
- 云函数拼 prompt：`cloudfunctions/adjudication/index.js` 的 `buildUserPrompt`。

关闭 DEBUG 或上线前记得去掉/还原临时修改，避免日志过多或泄露信息。
