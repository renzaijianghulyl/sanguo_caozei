# 逻辑层与叙事层：服务端提示词说明

客户端已升级为「逻辑层 + 叙事层」双层架构。请求体中会携带 `logical_results`（既定事实）与可选的 `logic_override`（强制描写失败）。云函数/服务端在拼装发给大模型的 Prompt 时，需按以下方式注入，保证**数值先行、叙事在后**。

---

## 1. 请求体中的新字段

- **`logical_results`**（可选）：逻辑预处理器产出的既定事实。
  - `time_passed`：经过的年数（时间跳跃）。
  - `world_changes`：该时间跨度内发生的世界大事（来自 worldTimeline），字符串数组。
  - **属性增减**：不由逻辑层按年定额计算，改由裁决 API 根据玩家输入与叙事，通过返回的 **effects**（如 `strength+10`、`intelligence-5`）决定，客户端解析后写回存档。

- **`logic_override`**（可选）：当逻辑层判定意图不可能实现时存在。

- **`logic_db`**：三国结构化数据库上下文，供 LLM 参考以修正叙事幻觉。
  - `regions`：城池列表（id、name、type、ownerId、loyalty）。
  - `npcs`：武将列表（id、name、str、int、currentRegion、personality_traits、speech_style、birth_year、death_year）。
  - `reason`：原因标识，如 `"impossible_battle"`。
  - `instruction`：给模型的简短指令，如「玩家武力不足以战胜吕布，叙事必须描写失败或撤退，不可写成胜利。」

当存在 `logic_override` 时，**叙事必须遵守 `instruction`**，不得写出成功或逆转结果。

---

## 2. Prompt 生成建议

在云函数/服务端拼装 System 或 User 消息时，建议：

1. **优先注入 `logical_results`**
   - 若存在 `logical_results`，在上下文中显式写出一段「既定事实」说明，例如：
   - 「以下为已由系统计算确定的客观事实，你必须严格基于此进行文学化叙事，不得篡改或忽略：」
   - 然后逐条列出：经过年数、该时间段内发生的世界大事。
   - 明确说明：**这些事实的权重高于 recent_dialogue，叙事必须与事实一致。**
   - **属性变化**由你通过本次回复的 **effects** 给出（如 `strength+10`），根据剧情与玩家选择决定增减，不必与固定公式挂钩。

2. **若有 `logic_override`**
   - 在 Prompt 中单独强调：**本次结果必须为失败/撤退/未达成**，并引用 `logic_override.instruction`。
   - 例如：「系统判定：本次意图在逻辑上不可实现。你必须按以下要求写作：{instruction}」

3. **对话轮数超过 10 轮时的摘要提示**
   - 若 `event_context.suggest_summary === true`，说明对话历史已超过 10 轮，请在 Prompt 中注入 `event_context.summary_instruction` 的全文，要求大模型在本轮叙事末尾附上 2～3 句剧情摘要（可标注「【剧情摘要】」），便于后续手动触发 Context 压缩、减少 Token 消耗。
   - `event_context.dialogue_rounds` 为当前对话轮数（按「你：」出现次数计）。

4. **再提供对话与意图**
   - `recent_dialogue`、`player_intent` 作为「玩家说了什么」的参考；叙事在符合 `logical_results` 与 `logic_override` 的前提下，可参考对话语气与意图进行润色。

5. **状态与属性**
   - 请求体中的 `player_state`、`world_state` 已包含逻辑层更新（目前仅有时间推进，无定额属性增长）。
   - 属性、声望、资源等的增减均由你在本次回复中通过 **effects**（如 `strength+10`、`reputation-5`、`gold+50`）指定，客户端会解析并写回存档。

---

## 3. 示例（伪代码）

```text
若 payload.logical_results 存在：
  追加到 system 或 user：
  "【既定事实】系统已计算：时间过去了 {time_passed} 年；该期间发生的大事：{world_changes}。
   你的叙事必须严格基于以上事实。属性与资源的增减由你通过本次回复的 effects 给出。"

若 payload.logic_override 存在：
  追加："【强制约束】{logic_override.instruction}"

再追加：最近对话 recent_dialogue、玩家意图 player_intent，要求基于上述事实与约束进行文学化叙事。
```

---

## 4. 预期效果

当玩家输入「我闭关修炼了二十年」时：

- 客户端逻辑层：推进世界时间 20 年，从 worldTimeline 取出该区间内大事写入 `logical_results`（`time_passed`、`world_changes`）；**不**按年定额增加属性。
- 请求体中的 `player_state`、`world_state` 已是 20 年后的时间状态，属性保持原样。
- 服务端将 `logical_results` 作为硬性事实注入 Prompt，大模型根据剧情与玩家表现写出叙事，并通过 **effects**（如 `strength+15`、`intelligence+10`）给出属性增减，由客户端解析并写回存档。

这样即可实现「数值先行、叙事在后」的双层架构。

---

## 5. 志向（ambition）与长期记忆

### 5.1 请求体中的志向

- **`player_state.ambition`**（可选）：玩家在角色创建时选择的志向，取值为：
  - `"unify"`：天下一统
  - `"wealth"`：富甲天下
  - `"fortress"`：割据一方
  - `"scholar"`：一代名士

服务端应将 **志向写入 SYSTEM_PROMPT 的永久标签**（即每次请求的 System 中固定包含「玩家志向：天下一统 / 富甲天下 / 割据一方 / 一代名士」类描述），使大模型在每一轮生成时都知晓该设定。

### 5.2 叙事倾向：符合志向 vs 违背志向

- **行为符合志向**：在文案中给予**正向暗示**（如决心更坚、步伐更稳、内心笃定等）。
- **行为违背志向**：在文案中给予**内心挣扎**的描写（如迟疑、自责、对初衷的动摇等）。

以上可在 System 或固定指令中简要说明，由模型在长文案中自然体现。

---

## 6. 首段叙事（开局内心独白）

当 **`event_context.is_opening === true`** 且 **`player_state.ambition`** 存在时，表示本局为**开局首轮**（对话轮数为 0）。此时应：

1. 在 Prompt 中注入 **`event_context.opening_instruction`** 的全文（客户端已写好）。
2. 要求叙事引擎在**本轮回复开头**根据志向生成一段**专属内心独白**，再写对玩家意图的叙事反馈。
3. 志向与独白侧重：
   - **unify（天下一统）**：侧重「不忍见苍生受苦，欲提三尺剑立不世之功」。
   - **wealth（富甲天下）**：侧重「乱世之中，唯有掌握天下之财，方能左右棋局」。
   - **fortress（割据一方）**：侧重「厌倦纷争，守住一方乐土，让百姓安居」。
   - **scholar（一代名士）**：侧重「无意争霸，但求结交贤才、著书立说、留下千古美名」。

---

## 7. 「内心戏」指令（长文案 Level 3）

客户端在每次请求的 **`event_context.narrative_instruction`** 中会附带以下指令，服务端应在拼装 Prompt 时注入（可与 Level 3 长文案逻辑结合）：

- **当产生长文案反馈（Level 3）时**，请在正文前或结尾处，增加一段以**「我」**为视角的**括号内心独白**。
- 示例：  
  `（看着城头的硝烟，我握紧了腰间的剑柄：这乱世，终将由我来终结。）`

即：在 Level 3 叙事中，要求模型在正文前或结尾增加一句或一段括号内的第一人称内心戏，与玩家志向与当前剧情呼应。
