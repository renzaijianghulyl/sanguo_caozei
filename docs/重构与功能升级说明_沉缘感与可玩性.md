# 重构与功能升级说明 — 沉缘感与可玩性

基于《技术架构说明》完成的深度重构与功能升级，核心目标：提升「沉缘感」与「可玩性」。以下为已实现项与使用说明。

---

## 一、深度羁绊与记忆系统 (Bond & Memory)

### 1.1 结构重组（state.ts）

- **Bond** 现为完整对象，包含：
  - `affinity`：亲密度 0～100
  - `relation_type`：`BondRelationType`（空、acquaintance、lord_vassal、sworn_brother、admiration、spouse）
  - `memory_shards`：记忆碎片数组（由叙事关键点写入，替代原 milestones）
  - `last_seen_world_time`：上次见面世界时间（用于衰减）
  - `last_interaction_year`：上次互动年份
- **NPCState** 仍保留 `player_favor`、`player_relation`，由 Bond 同步，供 LLM/UI 兼容。
- 旧存档中 `bond.milestones` 在 `ensureBond` 时通过 `normalizeBond` 迁移为 `memory_shards`。

### 1.2 动态反馈（effectsApplier.ts）

- 新增 effect：`npc_{id}_memory={描述}`，解析后写入该 NPC 的 `bond.memory_shards`（上限 30 条）。
- 好感 effect（`npc_*_favor`）、关系 effect（`npc_*_relation`）应用后同步更新 `bond.relation_type` 并 `touchLastSeen`。

### 1.3 情感阈值（relationshipRules.ts）

- `AFFINITY_SWORN_BROTHER = 90`、`AFFINITY_MARRIAGE = 90`。
- `canUnlockSwornBrother(playerAge, npcAge, affinity)` / `canUnlockMarriage(...)`：年龄通过且好感 ≥ 90 方可解锁结拜/婚配**叙事权限**。
- snapshot 的 `event_context.relationship_rules` 中已写明：结拜/婚配仅当该武将好感 ≥ 90 且符合史实逻辑时方可解锁。

---

## 二、史实保护与蝴蝶效应

### 2.1 血缘与阵营锁定（logic_db）

- **LogicDbContext.npcs** 每项新增：
  - `father_id`：来自 NPCRecord，锁定父子关系（如曹丕必为曹操之子）。
  - `owner_faction_id`：当前所属阵营，锁定阵营。
- `getLogicDbContext(year)`（sanguoDb/index.ts）已注入上述字段；snapshot 的 `relationship_rules` 中说明逻辑库含血缘、阵营锁定。

### 2.2 偏差追踪（WorldState.history_flags）

- **WorldState** 新增可选字段 `history_flags: string[]`。
- 当玩家改变重大历史（如救活郭嘉、刺杀董卓成功），服务端可在 `state_changes.world.history_flags` 中返回新增项；**adjudicationFlow** 在应用 world 变更时会将新 flag **合并**入 `saveData.world.history_flags`（去重追加）。

### 2.3 逻辑偏移告知 LLM（snapshot）

- 若 `world_state.history_flags?.length > 0`，则在 `event_context` 中注入：
  - `history_deviation`：当前 history_flags 数组。
  - `history_deviation_instruction`：明确要求「由于玩家行为，历史已偏移，请严格基于以下现状推演，忽略与这些事实矛盾的原始史实脚本」。

---

## 三、多样化玩法驱动

### 3.1 身份称号（PlayerState.active_titles）

- **PlayerState** 新增可选字段 `active_titles: string[]`。
- 默认存档与迁移中均会初始化为 `[]`；后续可由服务端在 `state_changes.player` 或 effects 中写入称号（如「乱世奸雄」「货通天下」）。

### 3.2 意图分发（buildAdjudicationPayload）

- 新增 **playstyle_context**（仅当存在 ambition 或 active_titles 时注入）：
  - 按 **ambition** 注入对应权重说明：霸业→军粮/民心/征伐；商人→物价/商路/财富；割据→守城/民生/盟友；名士→贤才/著书/声望。
  - 若有 **active_titles**，则追加「当前称号」说明，供叙事中调整他人对玩家的称呼与态度。

---

## 四、渲染与交互优化

### 4.1 小说化分版（primitives + renderer）

- **wrapTextWithParagraphs**（primitives.ts）：按 `\n\n` 拆分为段落，再逐段换行；返回 `lines` 与 `paragraphGapAfterIndex`。
- **wrapBubble**：使用上述结果，段落后增加 **1.5 倍行距**（0.5 倍行高作为段落间隔）。
- **drawBubble**：支持传入 `paragraphGapAfterIndex`，绘制时在对应行后增加段落间距。

### 4.2 离屏缓冲（renderer）

- 历史对话（`dialogueHistory`）绘制到**离屏 Canvas**；主 Canvas 只绘制「可见区」的离屏切片 + **实时打字层**。
- 当 `dialogueHistory.length` 或 `maxWidth` 变化时重绘离屏；打字机逐字时仅重绘打字气泡，减少重叠与掉帧。
- `invalidateDialogueCache()` 会同时清除离屏有效标记，便于重新开始/读档后正确重绘。

---

## 五、数据初始化（initBondEngine）

- **BondSystem.initBondEngine(year)**：从 NPCRecord 的好友、对手、父子等字段生成带 Bond 与 NPC 间关系的 NPC 列表（内部调用 `getDefaultNPCStateWithBonds`）。
- **config** 中 **DEFAULT_NPC_STATE** 已改为 `initBondEngine(184)`，新档开局即带完整 Bond 与 relations。

---

## 六、存档兼容与迁移

- **saveManager.migrateSaveData**：在读档及导入存档后执行：
  - 为缺少 `history_flags` 的 WorldState 赋 `[]`；
  - 为缺少 `active_titles` 的 PlayerState 赋 `[]`；
  - 对每个 NPC 调用 **ensureBond(npc, worldTime)**，从而对旧版 Bond（如仅有 milestones）执行 **normalizeBond**（补全 relation_type、memory_shards、last_interaction_year）。
- **RelationManager.normalizeBond**：将 `milestones` 迁移为 `memory_shards`，并补全 Bond 新字段默认值。

---

## 七、涉及文件一览

| 模块       | 文件 |
|------------|------|
| 状态与类型 | `src/core/state.ts` |
| 羁绊逻辑   | `src/core/BondSystem.ts`、`src/core/RelationManager.ts` |
| 效果应用   | `src/core/effectsApplier.ts` |
| 关系规则   | `src/core/relationshipRules.ts` |
| 快照与意图 | `src/core/snapshot.ts` |
| 裁决请求   | `src/app/adjudicationFlow.ts`（history_flags 合并） |
| 逻辑库     | `src/data/sanguoDb/index.ts`、`src/services/network/adjudication.ts`（LogicDbContext） |
| 配置与默认 | `src/config/index.ts` |
| 存档       | `src/services/storage/saveManager.ts`（迁移） |
| UI         | `src/ui/primitives.ts`、`src/ui/renderer.ts` |

---

## 八、后续可扩展

- 服务端在裁决结果中返回 **state_changes.world.history_flags** 或 effects 中约定「历史偏移」标记，即可自动写入并影响后续 LLM 推演。
- 称号写入方式：在 **state_changes.player** 或自定义 effect 中更新 `player.active_titles`，并在 buildAdjudicationPayload 中已通过 **playstyle_context** 注入叙事侧。
- 云函数/裁决 API 可返回 **narrative_key_points** 或 effect `npc_X_memory=...`，由 effectsApplier 写入 **memory_shards**，增强沉缘感与后续叙事调用。
