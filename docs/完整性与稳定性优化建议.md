# 游戏完整性与稳定性优化建议

基于当前代码库的梳理，从**完整性**和**稳定性**角度整理的可优化点，按优先级与实现成本分类，便于后续迭代。

---

## 一、稳定性（优先建议）

### 1. 云函数裁决增加重试

- **现状**：`callAdjudication` 里走 **云函数** 时只调用一次，失败即抛错；走 **HTTP** 时才有 `MAX_RETRIES` 重试。
- **建议**：云函数路径也加 1～2 次重试（与 HTTP 一致），并带短延时（如 1s），减少网络抖动导致的“裁决失败”。
- **位置**：`src/services/network/adjudication.ts`，`useCloud` 分支内对 `wx.cloud.callFunction` 包一层 retry 循环。

### 2. 裁决失败时可选「重试当前意图」

- **现状**：失败后仅追加“裁决失败：……”提示，用户需再次输入或从引导槽点选。
- **建议**：失败时在对话区追加一句「输入「重试」可再次发送上一条意图」；或在本地指令里支持「重试」：取出 `dialogueHistory` 最后一条「你：xxx」，再次调用 `submitInput` 逻辑（不重复追加「你：」）。实现成本低，体验提升明显。

### 3. 存档损坏时的明确反馈

- **现状**：`saveManager.load()` 在 `JSON.parse` 或校验失败时返回 `null`，`loadLatestSave()` 返回 `false`，但初始化时未对用户做任何提示。
- **建议**：在 `initGame` 中若 `loadLatestSave()` 为 false，且 `getSaveList()` 存在槽位（说明曾有存档），可一次性 Toast「存档无法读取，已跳过」或写入一条系统对话，避免用户误以为存档丢失是 bug。

### 4. 存档结构弱校验

- **现状**：`readSlot` 仅依赖 `JSON.parse` 不抛错即返回 `data`，未校验必填字段（如 `meta`、`player`、`world`、`npcs`）。
- **建议**：在 `readSlot` 或 `load` 内做最小结构校验（如 `data?.meta?.version && data?.player && data?.world`），不通过则视为损坏并返回 `null`，防止半写入/截断数据导致后续运行时报错。

### 5. 切出期间裁决返回的处理（可选）

- **现状**：用户提交意图后切出，`onAppHide` 会保存当前状态（已含「你：xxx」）；若请求在后台完成，`handleAdjudicationResult` 仍会执行并更新状态。
- **建议**：若希望避免“回来后发现剧情已变”的困惑，可引入「请求序号」：提交时自增 id，回调里仅当 id 仍为当前请求时才应用结果；否则仅记录日志并丢弃。实现成本中等，可按需求决定是否做。

---

## 二、完整性（体验与边界）

### 6. 长叙事/多段落的排版与滚动

- **现状**：长叙事（如闭关十年三幕）单条对话很长，依赖对话区滚动。
- **建议**：已有滚动与打字机；可考虑对超长单条在渲染时做「折叠/展开」或分段展示，减少单屏信息过载（实现成本较高，可作后续优化）。

### 7. 网络弱网/超时提示

- **现状**：`REQUEST_TIMEOUT` 15s，超时后走 catch，提示「裁决请求失败」。
- **建议**：在 catch 里根据 `error.message` 或类型区分「超时」与「网络错误」，给出更具体提示（如「网络较慢，请稍后重试」），并保持现有的「重试」能力（见上文第 2 点）。

### 8. 本地指令可发现性

- **现状**：帮助指令会列出「存档、读档、帮助、属性、反馈」等，用户需输入「帮助」才能看到。
- **建议**：在开始页或首次进入游玩时增加一句「输入「帮助」可查看全部指令」，或在输入框 placeholder 中轮播「试试输入：帮助 / 存档 / 前往洛阳」。

### 9. 云函数超时与冷启动

- **现状**：裁决云函数若执行时间接近 20s，可能被平台中断；冷启动会带来首包延迟。
- **建议**：在文档或配置中明确云函数超时设为 ≥20s；若使用 HTTP 模式，建议服务端同样设置合理超时。冷启动可通过定时预热或用户行为预测缓解（实现成本视运维能力而定）。

---

## 三、数据与一致性

### 10. 对话历史与存档上限

- **现状**：`storageLimits.maxDialogueHistory` 等已限制条数，超限会裁剪。
- **建议**：保持现状即可；若有「导出剧情」需求，可单独提供按需导出（不改变主流程）。

### 11. effects 解析健壮性

- **现状**：`applyPlayerStateChanges` 用正则解析 effects，无法识别的会 `continue`，不会抛错。
- **建议**：对未知格式可打一条 DEBUG 日志，便于排查 LLM 返回异常 effect 的情况；生产环境可关闭或降级为 trace。

### 12. 版本与迁移

- **现状**：`SAVE_VERSION` 与 `migrateDialogueYear` 已做部分迁移。
- **建议**：后续若增改存档结构（如新字段、新槽位用途），在 `load` 中按 `meta.version` 走迁移分支，并更新 `SAVE_VERSION`，保证旧档可读。

---

## 四、测试与可观测性

### 13. 关键路径单测

- **建议**：为「裁决失败」路径补单测：例如 mock `callAdjudication` 抛错，断言 `dialogueHistory` 末尾为失败提示、`isAdjudicating` 恢复为 false。`loadLatestSave` 在 load 返回 null 时的行为也可加一条断言。

### 14. 反馈与日志

- **现状**：已有 `feedbackLogger` 记录裁决失败与审核失败。
- **建议**：若上线后需要排查问题，可在关键分支（如裁决成功/失败、存档读写、本地指令命中）打带请求 id 或 slot 的日志，便于真机反馈时定位。

---

## 五、小结（按优先级）

| 优先级 | 项 | 说明 |
|--------|----|------|
| 高 | 云函数裁决重试 | 与 HTTP 一致，减少偶发失败 |
| 高 | 裁决失败可「重试」 | 本地指令支持重发上一条意图，体验好 |
| 中 | 存档损坏提示 | 用户可知“非丢档而是损坏” |
| 中 | 存档结构校验 | 防止脏数据导致运行时错误 |
| 中 | 超时/网络错误区分 | 提示更清晰 |
| 低 | 请求序号防 stale | 切出期间返回可忽略，按需实现 |
| 低 | 帮助可发现性 | 文案/placeholder 提示「帮助」等指令 |

以上均可按阶段实施，优先做「云函数重试」和「重试当前意图」两项，对完整性与稳定性提升最明显。
